/*publish time:2011-09-19 20:54:20*/
KISSY.add("editor/export", function (B) { function F(K, G) { var I = this; if (!(I instanceof F)) { return new F(K, G) } if (B.isString(K)) { K = B.one(K) } K = D._4e_wrap(K); G = G || {}; G.pluginConfig = G.pluginConfig || {}; I.cfg = G; G.pluginConfig = G.pluginConfig; I.cfg = G; B.app(I, B.EventTarget); var J = ["htmldataprocessor", "enterkey", "clipboard"], H = E; I.use = function (O, N) { O = O.split(","); if (!H) { for (var M = 0; M < J.length; M++) { var L = J[M]; B.inArray(L, O) || O.unshift(L) } } I.ready(function () { B.Editor.use("button,select", function () { B.use.call(I, O.join(","), function () { for (var P = 0; P < O.length; P++) { I.usePlugin(O[P]) } N && N.call(I); if (!H) { I.setData(K.val()); if (G.focus) { I.focus() } else { (P = I.getSelection()) && P.removeAllRanges() } H = C } }, { global: F }) }) }); return I }; I.use = I.use; I.Config.base = F.Config.base; I.Config.debug = F.Config.debug; I.Config.componentJsName = A; I.init(K) } var D = B.DOM, C = true, E = false, A; A = parseFloat(B.version) < 1.2 ? function () { return "plugin-min.js?t=2011-09-19 20:28:24" } : function (H, G) { return H + "/plugin-min.js" + (G ? G : "?t=2011-09-19 20:28:24") }; B.app(F, B.EventTarget); F.Config.base = B.Config.base + "editor/plugins/"; F.Config.debug = B.Config.debug; F.Config.componentJsName = A; B.Editor = F; B.Editor = F }); KISSY.add("editor", function (A) { return A.Editor }, { requires: ["dd", "overlay"] }); KISSY.Editor.add("utils", function (D) { var A = null, H = KISSY, G = H.Node, I = H.DOM, F = H.UA, B = H.Event, C; C = F.ie ? document.documentMode || F.ie : void 0; var E = { debugUrl: function (J) { J = J.replace(/-min\.(js|css)/i, ".$1"); D.Config.debug || (J = J.replace(/\.(js|css)/i, "-min.$1")); if (J.indexOf("?t") == -1) { J += J.indexOf("?") != -1 ? "&" : "?"; J += "t=" + encodeURIComponent("2011-09-19 15:00:39") } return D.Config.base + J }, lazyRun: function (M, J, N) { var L = M[J], K = M[N]; M[J] = function () { L.apply(this, arguments); M[J] = M[N]; return K.apply(this, arguments) } }, getXY: function (L, J, M, K) { M = M.defaultView || M.parentWindow; L -= I.scrollLeft(M); J -= I.scrollTop(M); if (K) { if (M != (K.defaultView || K.parentWindow) && M.frameElement) { K = I._4e_getOffset(M.frameElement, K); L += K.left; J += K.top } } return { left: L, top: J} }, tryThese: function () { for (var M, J = 0, N = arguments.length; J < N; J++) { var L = arguments[J]; try { M = L(); break } catch (K) { } } return M }, arrayCompare: function (K, J) { if (!K && !J) { return true } if (!K || !J || K.length != J.length) { return false } for (var L = 0; L < K.length; L++) { if (K[L] !== J[L]) { return false } } return true }, getByAddress: function (P, K, Q) { P = P.documentElement; for (var O = 0; P && O < K.length; O++) { var M = K[O]; if (Q) { for (var L = -1, J = 0; J < P.childNodes.length; J++) { var N = P.childNodes[J]; if (!(Q === true && N.nodeType == 3 && N.previousSibling && N.previousSibling.nodeType == 3)) { L++; if (L == M) { P = N; break } } } } else { P = P.childNodes[M] } } return P ? new G(P) : A }, clearAllMarkers: function (K) { for (var J in K) { K[J]._4e_clearMarkers(K, true) } }, htmlEncodeAttr: function (J) { return J.replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/, "&gt;") }, ltrim: function (J) { return J.replace(/^\s+/, "") }, rtrim: function (J) { return J.replace(/\s+$/, "") }, trim: function (J) { return this.ltrim(this.rtrim(J)) }, mix: function () { for (var K = {}, J = 0; J < arguments.length; J++) { K = H.mix(K, arguments[J]) } return K }, isCustomDomain: function () { if (!F.ie) { return false } var K = document.domain, J = window.location.hostname; return K != J && K != "[" + J + "]" }, duplicateStr: function (K, J) { return Array(J + 1).join(K) }, throttle: function (L, J, M) { M = M || 150; if (M === -1) { return function () { L.apply(J, arguments) } } var K = (new Date).getTime(); return function () { var N = (new Date).getTime(); if (N - K > M) { K = N; L.apply(J, arguments) } } }, buffer: function (L, J, M) { M = M || 0; var K = A; return function () { K && clearTimeout(K); var N = arguments; K = setTimeout(function () { return L.apply(J, N) }, M) } }, isNumber: function (J) { return /^\d+(.\d+)?$/.test(H.trim(J)) }, verifyInputs: function (M) { for (var J = 0; J < M.length; J++) { var N = I._4e_wrap(M[J]), L = H.trim(N.val()), K = N.attr("data-verify"); N = N.attr("data-warning"); if (K && !RegExp(K).test(L)) { alert(N); return false } } return true }, sourceDisable: function (K, J) { K.on("sourcemode", J.disable, J); K.on("wysiwygmode", J.enable, J) }, resetInput: function (K) { var J = K.attr("placeholder"); if (J && !F.webkit) { K.addClass("ke-input-tip"); K.val(J) } else { F.webkit && K.val("") } }, valInput: function (K, J) { K.removeClass("ke-input-tip"); K.val(J) }, placeholder: function (K, J) { K.attr("placeholder", J); if (!F.webkit) { K.on("blur", function () { if (!H.trim(K.val())) { K.addClass("ke-input-tip"); K.val(J) } }); K.on("focus", function () { K.removeClass("ke-input-tip"); H.trim(K.val()) == J && K.val("") }) } }, clean: function (L) { L = L[0] || L; for (var J = H.makeArray(L.childNodes), M = 0; M < J.length; M++) { var K = J[M]; K.nodeType == D.NODE.NODE_TEXT && !H.trim(K.nodeValue) && L.removeChild(K) } }, htmlEncode: function (J) { return !J ? J : String(J).replace(/&/g, "&amp;").replace(/>/g, "&gt;").replace(/</g, "&lt;").replace(/"/g, "&quot;") }, htmlDecode: function (J) { return !J ? J : String(J).replace(/&gt;/g, ">").replace(/&lt;/g, "<").replace(/&quot;/g, '"').replace(/&amp;/g, "&") }, equalsIgnoreCase: function (K, J) { return K.toLowerCase() == J.toLowerCase() }, normParams: function (K) { K = H.clone(K); for (var J in K) { if (K.hasOwnProperty(J)) { var L = K[J]; if (H.isFunction(L)) { K[J] = L() } } } return K }, doFormUpload: function (O, R, P) { function N() { var T = { responseText: "", responseXML: A }; T.argument = O ? O.argument : A; try { var U; if ((U = F.ie ? L.contentWindow.document : L.contentDocument || window.frames[J].document) && U.body) { T.responseText = H.trim(I.text(U.body)) } T.responseXML = U && U.XMLDocument ? U.XMLDocument : U } catch (V) { H.log(V) } B.remove(L, "load", N); O.callback && O.callback(T); setTimeout(function () { I._4e_remove(L) }, 100) } var J = H.guid("form-upload-"), L = document.createElement("iframe"); L.id = J; L.name = J; L.className = "ke-hidden"; var Q = "document.open();" + (E.isCustomDomain() ? 'document.domain="' + document.domain + '";' : "") + "document.close();"; if (F.ie) { L.src = F.ie ? "javascript:void(function(){" + encodeURIComponent(Q) + "}())" : "" } H.log("doFormUpload : " + L.src); document.body.appendChild(L); if (F.ie) { document.frames[J].name = J } Q = I._4e_unwrap(O.form); var M = { target: Q.target, method: Q.method, encoding: Q.encoding, enctype: Q.enctype, action: Q.action }; Q.target = J; Q.method = "POST"; Q.enctype = Q.encoding = "multipart/form-data"; if (P) { Q.action = P } var S; if (R) { S = []; R = D.Utils.normParams(R); for (var K in R) { if (R.hasOwnProperty(K)) { P = document.createElement("input"); P.type = "hidden"; P.name = K; P.value = R[K]; Q.appendChild(P); S.push(P) } } } B.on(L, "load", N); Q.submit(); Q.target = M.target; Q.method = M.method; Q.enctype = M.enctype; Q.encoding = M.encoding; Q.action = M.action; if (S) { R = 0; for (K = S.length; R < K; R++) { I._4e_remove(S[R]) } } return L }, extern: function (K, J) { for (var L in J) { K[L] = J[L] } }, map: function (K, J) { for (var L = 0; L < K.length; L++) { K[L] = J(K[L]) } return K }, ieEngine: C, preventFocus: function (J) { F.ie ? J._4e_unselectable() : J.attr("onmousedown", "return false;") }, isFlashEmbed: function (J) { J = J.attributes; return J.type == "application/x-shockwave-flash" || /\.swf(?:$|\?)/i.test(J.src || "") }, addRes: function () { var J = this.__res = this.__res || []; J.push.apply(J, H.makeArray(arguments)) }, destroyRes: function () { for (var K = this.__res || [], J = 0; J < K.length; J++) { var L = K[J]; if (H.isFunction(L)) { L() } else { L.detach && L.detach(); L.destroy && L.destroy(); L.nodeType && L.remove && L.remove() } } this.__res = [] } }; D.Utils = E; D.Utils = E; F.ieEngine = E.ieEngine; E.extern(E, { debugUrl: E.debugUrl, lazyRun: E.lazyRun, getXY: E.getXY, tryThese: E.tryThese, arrayCompare: E.arrayCompare, getByAddress: E.getByAddress, clearAllMarkers: E.clearAllMarkers, htmlEncodeAttr: E.htmlEncodeAttr, ltrim: E.ltrim, rtrim: E.rtrim, trim: E.trim, mix: E.mix, isCustomDomain: E.isCustomDomain, duplicateStr: E.duplicateStr, buffer: E.buffer, isNumber: E.isNumber, verifyInputs: E.verifyInputs, sourceDisable: E.sourceDisable, resetInput: E.resetInput, placeholder: E.placeholder, clean: E.clean, htmlEncode: E.htmlEncode, htmlDecode: E.htmlDecode, equalsIgnoreCase: E.equalsIgnoreCase, normParams: E.normParams, throttle: E.throttle, doFormUpload: E.doFormUpload, map: E.map }) }); KISSY.Editor.add("dom", function (E) { function B(P) { return P.replace(/-(\w)/g, function (R, Q) { return Q.toUpperCase() }) } var N = KISSY, M = N.DOM, O = N.UA, L = N.Node, C = E.Utils, D = { abbr: 1, acronym: 1, address: 1, b: 1, bdo: 1, big: 1, cite: 1, code: 1, del: 1, dfn: 1, em: 1, font: 1, i: 1, ins: 1, label: 1, kbd: 1, q: 1, s: 1, samp: 1, small: 1, span: 1, strike: 1, strong: 1, sub: 1, sup: 1, tt: 1, u: 1, "var": 1 }; E.NODE = { NODE_ELEMENT: 1, NODE_TEXT: 3, NODE_COMMENT: 8, NODE_DOCUMENT_FRAGMENT: 11 }; E.NODE = E.NODE; E.POSITION = { POSITION_IDENTICAL: 0, POSITION_DISCONNECTED: 1, POSITION_FOLLOWING: 2, POSITION_PRECEDING: 4, POSITION_IS_CONTAINED: 8, POSITION_CONTAINS: 16 }; E.POSITION = E.POSITION; var G = E.NODE, I = E.POSITION, K = { block: 1, "list-item": 1, table: 1, "table-row-group": 1, "table-header-group": 1, "table-footer-group": 1, "table-row": 1, "table-column-group": 1, "table-column": 1, "table-cell": 1, "table-caption": 1 }, J = { hr: 1 }, H = function (P) { return P[0] || P }, A = function (P) { if (P && !P[0]) { return new L(P) } return P }, F = { _4e_wrap: A, _4e_unwrap: H, _4e_equals: function (P, Q) { if (!P && !Q) { return true } if (!P || !Q) { return false } P = H(P); Q = H(Q); return P === Q }, _4e_isBlockBoundary: function (P, R) { P = A(P); var Q = N.mix(N.mix({}, J), R || {}); return K[P.css("display")] || Q[P._4e_name()] }, _4e_getWin: function (P) { return P && "scrollTo" in P && P.document ? P : P && P.nodeType === 9 ? P.defaultView || P.parentWindow : false }, _4e_index: function (P) { P = H(P); for (var R = P.parentNode.childNodes, Q = 0; Q < R.length; Q++) { if (R[Q] === P) { return Q } } return -1 }, _4e_first: function (P, R) { P = H(P); var Q = P.firstChild; if ((Q = Q && new L(Q)) && R && !R(Q)) { Q = Q._4e_next(R) } return Q }, _4e_move: function (P, R, Q) { P = H(P); M._4e_remove(P); R = H(R); Q ? R.insertBefore(P, R.firstChild) : R.appendChild(P) }, _4e_name: function (P) { P = H(P); var Q = P.nodeName.toLowerCase(); if (O.ie) { if ((P = P.scopeName) && P != "HTML") { Q = P.toLowerCase() + ":" + Q } } return Q }, _4e_isIdentical: function (V, T) { if (V._4e_name() != T._4e_name()) { return false } var X = V[0].attributes, S = T[0].attributes, R = X.length, P = S.length; if (R != P) { return false } for (var Q = 0; Q < R; Q++) { var W = X[Q], U = W.name; if (W.specified && V.attr(U) != T.attr(U)) { return false } } if (C.ieEngine < 8) { for (Q = 0; Q < P; Q++) { W = S[Q]; U = W.name; if (W.specified && V.attr(U) != T.attr(U)) { return false } } } return true }, _4e_isEmptyInlineRemoveable: function (P) { P = H(P).childNodes; for (var T = 0, Q = P.length; T < Q; T++) { var S = P[T], R = S.nodeType; if (!(R == G.NODE_ELEMENT && S.getAttribute("_ke_bookmark"))) { if (R == G.NODE_ELEMENT && !F._4e_isEmptyInlineRemoveable(S) || R == G.NODE_TEXT && N.trim(S.nodeValue)) { return false } } } return true }, _4e_moveChildren: function (P, R, Q) { P = H(P); R = R[0] || R; if (P != R) { if (Q) { for (; Q = P.lastChild; ) { R.insertBefore(P.removeChild(Q), R.firstChild) } } else { for (; Q = P.firstChild; ) { R.appendChild(P.removeChild(Q)) } } } }, _4e_mergeSiblings: function () { function P(U, Q, S) { if (Q[0] && Q[0].nodeType == G.NODE_ELEMENT) { for (var R = []; Q.attr("_ke_bookmark") || Q._4e_isEmptyInlineRemoveable(); ) { R.push(Q); Q = S ? new L(Q[0].nextSibling) : new L(Q[0].previousSibling); if (!Q[0] || Q[0].nodeType != G.NODE_ELEMENT) { return } } if (U._4e_isIdentical(Q)) { for (var T = S ? U[0].lastChild : U[0].firstChild; R.length; ) { R.shift()._4e_move(U, !S) } Q._4e_moveChildren(U, !S); Q._4e_remove(); T[0] && T[0].nodeType == G.NODE_ELEMENT && T._4e_mergeSiblings() } } } return function (Q) { if (Q[0]) { if (D[Q._4e_name()] || Q._4e_name() == "a") { P(Q, new L(Q[0].nextSibling), true); P(Q, new L(Q[0].previousSibling)) } } } } (), _4e_unselectable: O.gecko ? function (P) { P = H(P); P.style.MozUserSelect = "none" } : O.webkit ? function (P) { P = H(P); P.style.KhtmlUserSelect = "none" } : function (P) { P = H(P); if (O.ie || O.opera) { var R = 0; P.setAttribute("unselectable", "on"); for (var Q = P.getElementsByTagName("*"); P = Q[R++]; ) { switch (P.tagName.toLowerCase()) { case "iframe": case "textarea": case "input": case "select": break; default: P.setAttribute("unselectable", "on") } } } }, _4e_getOffset: function (P, U) { P = H(P); var Q, S = 0; Q = 0; var R = P.ownerDocument.defaultView || P.ownerDocument.parentWindow, T = P.ownerDocument, V = T.documentElement; U = U || T; if (P.getBoundingClientRect) { if (P !== T.body && V !== P) { Q = P.getBoundingClientRect(); S = Q.left + (U === T ? M.scrollLeft(R) : 0); Q = Q.top + (U === T ? M.scrollTop(R) : 0) } if (U) { if (R != (U.defaultView || U.parentWindow) && R.frameElement) { R = F._4e_getOffset(R.frameElement, U); S += R.left; Q += R.top } } } return { left: S, top: Q} }, _4e_getFrameDocument: function (P) { return (P = H(P)) && P.contentWindow.document }, _4e_splitText: function (P, S) { P = H(P); var Q = P.ownerDocument; if (!(!P || P.nodeType != G.NODE_TEXT)) { if (O.ie && S == P.nodeValue.length) { var R = Q.createTextNode(""); M.insertAfter(R, P); return new L(R) } R = new L(P.splitText(S)); if (Q.documentMode) { Q = Q.createTextNode(""); M.insertAfter(Q, R[0]); M._4e_remove(Q) } return R } }, _4e_parents: function (P, R) { P = A(P); var Q = []; do { Q[R ? "push" : "unshift"](P) } while (P = P.parent()); return Q }, _4e_clone: function (P, S, Q) { P = H(P); P = P.cloneNode(S); if (!Q) { var R = function (T) { if (T.nodeType == G.NODE_ELEMENT) { T.removeAttribute("id"); T = T.childNodes; for (var U = 0; U < T.length; U++) { R(T[U]) } } }; R(P) } return new L(P) }, _4e_nextSourceNode: function (P, U, Q, S) { P = H(P); if (S && !S.call) { var R = S[0] || S; S = function (V) { V = V[0] || V; return V !== R } } U = !U && P.firstChild; var T = new L(P); if (!U) { if (P.nodeType == G.NODE_ELEMENT && S && S(P, true) === false) { return null } U = P.nextSibling } for (; !U && (T = T.parent()); ) { if (S && S(T, true) === false) { return null } U = T[0].nextSibling } if (!U) { return null } U = M._4e_wrap(U); if (S && S(U) === false) { return null } if (Q && Q != U[0].nodeType) { return U._4e_nextSourceNode(false, Q, S) } return U }, _4e_previousSourceNode: function (P, U, Q, S) { P = H(P); if (S && !S.call) { var R = S[0] || S; S = function (V) { V = V[0] || V; return V !== R } } U = !U && P.lastChild; var T = new L(P); if (!U) { if (P.nodeType == G.NODE_ELEMENT && S && S(P, true) === false) { return null } U = P.previousSibling } for (; !U && (T = T.parent()); ) { if (S && S(T, true) === false) { return null } U = T[0].previousSibling } if (!U) { return null } U = M._4e_wrap(U); if (S && S(U) === false) { return null } if (Q && U[0].nodeType != Q) { return U._4e_previousSourceNode(false, Q, S) } return U }, _4e_commonAncestor: function (P, R) { if (P._4e_equals(R)) { return P } if (R[0].nodeType != G.NODE_TEXT && R.contains(P)) { return R } var Q = P[0].nodeType == G.NODE_TEXT ? P.parent() : P; do { if (Q[0].nodeType != G.NODE_TEXT && Q.contains(R)) { return Q } } while (Q = Q.parent()); return null }, _4e_ascendant: function (P, S, Q) { P = H(P); if (!Q) { P = P.parentNode } if (S && !N.isFunction(S)) { var R = S; S = function (T) { return T._4e_name() == R } } for (; P && P.nodeType != 9; ) { if (!S || S(new L(P)) === true) { return new L(P) } P = P.parentNode } return null }, _4e_hasAttribute: C.ieEngine < 9 ? function (P, R) { P = H(P); var Q = P.getAttributeNode(R); return !!(Q && Q.specified) } : function (P, Q) { P = H(P); return P.hasAttribute(Q) }, _4e_hasAttributes: C.ieEngine < 9 ? function (P) { P = H(P); for (var S = P.attributes, Q = 0; Q < S.length; Q++) { var R = S[Q]; switch (R.name) { case "class": if (P.getAttribute("class")) { return true } break; default: if (R.specified) { return true } } } return false } : function (P) { P = H(P); O.gecko && P.removeAttribute("_moz_dirty"); return P.hasAttributes() }, _4e_position: function (P, U) { var Q = H(P), S = H(U); if (Q.compareDocumentPosition) { return Q.compareDocumentPosition(S) } if (Q == S) { return I.POSITION_IDENTICAL } if (Q.nodeType == G.NODE_ELEMENT && S.nodeType == G.NODE_ELEMENT) { if (Q.contains) { if (Q.contains(S)) { return I.POSITION_CONTAINS + I.POSITION_PRECEDING } if (S.contains(Q)) { return I.POSITION_IS_CONTAINED + I.POSITION_FOLLOWING } } if ("sourceIndex" in Q) { return Q.sourceIndex < 0 || S.sourceIndex < 0 ? I.POSITION_DISCONNECTED : Q.sourceIndex < S.sourceIndex ? I.POSITION_PRECEDING : I.POSITION_FOLLOWING } } Q = P._4e_address(); S = U._4e_address(); for (var R = Math.min(Q.length, S.length), T = 0; T <= R - 1; T++) { if (Q[T] != S[T]) { if (T < R) { return Q[T] < S[T] ? I.POSITION_PRECEDING : I.POSITION_FOLLOWING } break } } return Q.length < S.length ? I.POSITION_CONTAINS + I.POSITION_PRECEDING : I.POSITION_IS_CONTAINED + I.POSITION_FOLLOWING }, _4e_address: function (V, T) { V = H(V); for (var X = [], S = V.ownerDocument.documentElement, R = V; R && R != S; ) { var P = R.parentNode, Q = -1; if (P) { for (var W = 0; W < P.childNodes.length; W++) { var U = P.childNodes[W]; if (!(T && U.nodeType == 3 && U.previousSibling && U.previousSibling.nodeType == 3)) { Q++; if (U == R) { break } } } X.unshift(Q) } R = P } return X }, _4e_breakParent: function (P, S) { var Q = new E.Range(P[0].ownerDocument); Q.setStartAfter(P); Q.setEndAfter(S); var R = Q.extractContents(); Q.insertNode(P._4e_remove()); P[0].parentNode.insertBefore(R, P[0].nextSibling) }, _4e_style: function (P, R, Q) { if (Q !== undefined) { P = A(P); P.css(R, Q); P.attr("style") || P.removeAttr("style") } else { P = H(P); return P.style[B(R)] } }, _4e_remove: function (P, T) { var Q = H(P), S = Q.parentNode; if (S) { if (T) { for (var R; R = Q.firstChild; ) { S.insertBefore(Q.removeChild(R), Q) } } S.removeChild(Q) } return P }, _4e_trim: function (P) { M._4e_ltrim(P); M._4e_rtrim(P) }, _4e_ltrim: function (P) { P = H(P); for (var S; S = P.firstChild; ) { if (S.nodeType == G.NODE_TEXT) { var Q = C.ltrim(S.nodeValue), R = S.nodeValue.length; if (Q) { if (Q.length < R) { (new L(S))._4e_splitText(R - Q.length); P.removeChild(P.firstChild) } } else { P.removeChild(S); continue } } break } }, _4e_rtrim: function (P) { P = H(P); for (var S; S = P.lastChild; ) { if (S.type == G.NODE_TEXT) { var Q = C.rtrim(S.nodeValue), R = S.nodeValue.length; if (Q) { if (Q.length < R) { (new L(S))._4e_splitText(Q.length); P.removeChild(P.lastChild) } } else { P.removeChild(S); continue } } break } if (!O.ie && !O.opera) { (S = P.lastChild) && S.nodeType == 1 && S.nodeName.toLowerCase() == "br" && S.parentNode.removeChild(S) } }, _4e_appendBogus: function (P) { P = H(P); for (var Q = P.lastChild; Q && Q.nodeType == G.NODE_TEXT && !N.trim(Q.nodeValue); ) { Q = Q.previousSibling } if (!Q || Q.nodeType == G.NODE_TEXT || M._4e_name(Q) !== "br") { Q = O.opera ? P.ownerDocument.createTextNode("") : P.ownerDocument.createElement("br"); O.gecko && Q.setAttribute("type", "_moz"); P.appendChild(Q) } }, _4e_previous: function (P, S) { var Q = H(P), R; do { R = (Q = Q.previousSibling) && new L(Q) } while (R && S && !S(R)); return R }, _4e_last: function (P, R) { P = M._4e_wrap(P); var Q = P[0].lastChild; if ((Q = Q && new L(Q)) && R && !R(Q)) { Q = Q._4e_previous(R) } return Q }, _4e_next: function (P, S) { var Q = H(P), R; do { R = (Q = Q.nextSibling) && new L(Q) } while (R && S && !S(R)); return R }, _4e_outerHtml: function (P) { P = H(P); if (P.outerHTML) { return P.outerHTML.replace(/<\?[^>]*>/, "") } var Q = P.ownerDocument.createElement("div"); Q.appendChild(P.cloneNode(true)); return Q.innerHTML }, _4e_setMarker: function (P, U, Q, S) { P = M._4e_wrap(P); var R = P.data("list_marker_id") || P.data("list_marker_id", N.guid()).data("list_marker_id"), T = P.data("list_marker_names") || P.data("list_marker_names", {}).data("list_marker_names"); U[R] = P; T[Q] = 1; return P.data(Q, S) }, _4e_clearMarkers: function (P, U, Q) { P = A(P); var S = P.data("list_marker_names"), R = P.data("list_marker_id"), T; for (T in S) { P.removeData(T) } P.removeData("list_marker_names"); if (Q) { P.removeData("list_marker_id"); delete U[R] } }, _4e_copyAttributes: function (Q, V, R) { Q = H(Q); V = A(V); var T = Q.attributes; R = R || {}; for (var S = 0; S < T.length; S++) { var U = T[S], W = U.name.toLowerCase(), P; if (!(W in R)) { if (W == "checked" && (P = M.attr(Q, W))) { V.attr(W, P) } else { if (U.specified || O.ie && U.value && W == "value") { P = M.attr(Q, W); if (P === null) { P = U.nodeValue } V.attr(W, P) } } } } if (Q.style.cssText !== "") { V[0].style.cssText = Q.style.cssText } }, _4e_isEditable: function (P) { P = M._4e_name(P); var Q = E.XHTML_DTD; return (P = !Q.$nonEditable[P] && (Q[P] || Q.span)) && P["#"] }, _4e_scrollIntoView: function (P) { P = A(P); var U = P[0].ownerDocument, Q = M.scrollLeft(U), S = M.scrollTop(U), R = P.offset(), T = R.left; R = R.top; if (M.viewportHeight(U) + S < R || R < S || M.viewportWidth(U) + Q < T || T < Q) { P.scrollIntoView(U) } }, _4e_getElementsByTagName: function (P, R, Q) { P = H(P); if (!O.ie && Q) { R = Q + ":" + R } Q = []; P = P.getElementsByTagName(R); for (R = 0; R < P.length; R++) { Q.push(new L(P[R])) } return Q } }; C.extern(F, { _4e_wrap: F._4e_wrap, _4e_unwrap: F._4e_unwrap, _4e_equals: F._4e_equals, _4e_isBlockBoundary: F._4e_isBlockBoundary, _4e_getWin: F._4e_getWin, _4e_index: F._4e_index, _4e_first: F._4e_first, _4e_move: F._4e_move, _4e_name: F._4e_name, _4e_isIdentical: F._4e_isIdentical, _4e_isEmptyInlineRemoveable: F._4e_isEmptyInlineRemoveable, _4e_moveChildren: F._4e_moveChildren, _4e_mergeSiblings: F._4e_mergeSiblings, _4e_unselectable: F._4e_unselectable, _4e_getOffset: F._4e_getOffset, _4e_getFrameDocument: F._4e_getFrameDocument, _4e_splitText: F._4e_splitText, _4e_parents: F._4e_parents, _4e_clone: F._4e_clone, _4e_nextSourceNode: F._4e_nextSourceNode, _4e_previousSourceNode: F._4e_previousSourceNode, _4e_commonAncestor: F._4e_commonAncestor, _4e_ascendant: F._4e_ascendant, _4e_hasAttribute: F._4e_hasAttribute, _4e_hasAttributes: F._4e_hasAttributes, _4e_position: F._4e_position, _4e_address: F._4e_address, _4e_breakParent: F._4e_breakParent, _4e_style: F._4e_style, _4e_remove: F._4e_remove, _4e_trim: F._4e_trim, _4e_ltrim: F._4e_ltrim, _4e_rtrim: F._4e_rtrim, _4e_appendBogus: F._4e_appendBogus, _4e_last: F._4e_last, _4e_previous: F._4e_previous, _4e_next: F._4e_next, _4e_outerHtml: F._4e_outerHtml, _4e_setMarker: F._4e_setMarker, _4e_clearMarkers: F._4e_clearMarkers, _4e_getUniqueId: F._4e_getUniqueId, _4e_copyAttributes: F._4e_copyAttributes, _4e_isEditable: F._4e_isEditable, _4e_scrollIntoView: F._4e_scrollIntoView, _4e_getElementsByTagName: F._4e_getElementsByTagName }); (function (P) { N.mix(M, P); for (var Q in P) { P.hasOwnProperty(Q) && function (R) { L.prototype[R] = function () { var S = [].slice.call(arguments, 0); S.unshift(this); return P[R].apply(null, S) } } (Q) } })(F) }); KISSY.Editor.add("focusmanager", function (D) { function A() { var M = this; M.iframeFocus = F; E = M; C && clearTimeout(C); C = setTimeout(function () { M.fire("focus") }, 100) } function K() { var M = this; M.iframeFocus = H; E = G; C && clearTimeout(C); C = setTimeout(function () { M.fire("blur") }, 100) } var J = KISSY, L = J.DOM, I = J.Event, B = {}, C, E; J = { refreshAll: function () { for (var N in B) { var M = B[N]; M.document.designMode = "off"; M.document.designMode = "on" } }, currentInstance: function () { return E }, getInstance: function (M) { return B[M] }, add: function (N) { var M = L._4e_getWin(N.document); I.on(M, "focus", A, N); I.on(M, "blur", K, N) }, register: function (M) { B[M._UUID] = M }, remove: function (N) { delete B[N._UUID]; var M = L._4e_getWin(N.document); I.remove(M, "focus", A, N); I.remove(M, "blur", K, N) } }; var F = true, H = false, G = null; J.refreshAll = J.refreshAll; D.focusManager = J; D.focusManager = J; D.getInstances = function () { return B }; D.getInstances = D.getInstances }); KISSY.Editor.add("definition", function (J) { var G = true, D = false, C = J.Utils, E = document, A = KISSY, H = A.UA, I = H.ie, L = A.DOM, O = A.Node, R = A.Event, P = J.focusManager, N = C.tryThese, F = 1, K = "document.open();" + (C.isCustomDomain() ? 'document.domain="' + E.domain + '";' : "") + "document.close();", Q = "<div  class='ke-editor-wrap'  > <div class='" + ".ke-editor-tools".substring(1) + "' ></div><div class='" + ".ke-textarea-wrap".substring(1) + '\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="' + (I ? "javascript:void(function(){" + encodeURIComponent(K) + "}())" : "") + '"  allowTransparency="true" ></iframe></div><div class=\'' + ".ke-editor-status".substring(1) + "'></div></div>", M, B; M = J.SOURCE_MODE = 0; B = J.WYSIWYG_MODE = 1; J.SOURCE_MODE = M; J.WYSIWYG_MODE = B; A.augment(J, { init: function (U) { var T = this; T.__commands = {}; T.__dialogs = {}; T.__plugins = {}; I && L.addClass(E.body, "ke-ie" + I); if (H.trident) { L.addClass(E.body, "ke-trident" + H.trident) } else { if (H.gecko) { L.addClass(E.body, "ke-gecko") } else { H.webkit && L.addClass(E.body, "ke-webkit") } } var V = new O(Q); T.editorWrap = V; T._UUID = F++; P.register(T); T.wrap = V.one(".ke-textarea-wrap"); T.wrap = T.wrap; T.iframe = T.wrap.one("iframe"); T.iframe = T.iframe; T.toolBarDiv = V.one(".ke-editor-tools"); T.toolBarDiv = T.toolBarDiv; T.textarea = U; T.textarea = T.textarea; T.statusDiv = V.one(".ke-editor-status"); T.statusDiv = T.statusDiv; C.preventFocus(T.toolBarDiv); var W = U._4e_style("width"), S = U._4e_style("height"); if (W) { V.css("width", W); U.css("width", "100%") } T.textarea.css("display", "none"); V.insertAfter(U); T.wrap[0].appendChild(U[0]); if (S) { T.wrap.css("height", S); U.css("height", "100%") } V = T.iframe; if (U._4e_hasAttribute("tabindex")) { V[0].tabIndex = H.webkit ? -1 : U[0].tabIndex } T.on("dataReady", function () { T._ready = G; J.fire("instanceCreated", { editor: T }) }); H.gecko ? V.on("load", T._setUpIFrame, T) : T._setUpIFrame(); T.cfg.attachForm && U[0].form && T._attachForm() }, destroy: function () { if (!this.__destroyed) { var U = this.editorWrap, T = this.textarea, V = this.document, W = this.iframe[0].contentWindow; this.sync(); J.focusManager.remove(this); R.remove(V); R.remove(V.documentElement); R.remove(V.body); R.remove(W); this.iframe.detach(); V = this.__plugins; for (var S in V) { if (V.hasOwnProperty(S)) { W = V[S]; W.destroy && W.destroy() } } this.fire("destroy"); T.insertBefore(U); U.remove(); T.css({ width: U.css("width"), height: this.wrap.css("height") }); T.show(); this.__commands = this.__dialogs = this.__plugins = null; this.detach(); this.__destroyed = true } }, _attachForm: function () { var T = this, S = new O(T.textarea[0].form); S.on("submit", T.sync, T); T.on("destroy", function () { S.detach("submit", T.sync, T) }) }, useDialog: function (T, S) { var U = this, V = J.Overlay; V && V.loading(); U.use(T, function () { var W = U.getDialog(T); if (W) { S(W); V && V.unloading() } else { A.later(arguments.callee, 50, false, U) } }) }, addDialog: function (T, S) { this.__dialogs[T] = S }, getDialog: function (S) { return this.__dialogs[S] }, destroyDialog: function (T) { var S = this.__dialogs[T]; S && S.destroy(); this.__dialogs[T] = null }, addCommand: function (T, S) { this.__commands[T] = S }, hasCommand: function (S) { return this.__commands[S] }, execCommand: function (T) { var S = this.__commands[T], U = A.makeArray(arguments); U.shift(); U.unshift(this); return S.exec.apply(S, U) }, getMode: function () { return this.textarea.css("display") == "none" ? B : M }, getData: function (T) { var S; S = this.getMode() == B ? this.document && this.document.body ? this.document.body.innerHTML : "" : this.textarea.val(); if (this.htmlDataProcessor) { S = T ? this.htmlDataProcessor.toHtml(S, "p") : this.htmlDataProcessor.toServer(S, "p") } S = A.trim(S); if (/^<p>((&nbsp;)|\s)*<\/p>$/.test(S)) { S = "" } return S }, setData: function (T) { var S = T; if (this.htmlDataProcessor) { S = this.htmlDataProcessor.toDataFormat(T, "p") } this.document.body.innerHTML = S; if (!S) { this.document.body.innerHTML = S } this.getMode() != B && this.textarea.val(T) }, sync: function () { this.textarea.val(this.getData()) }, _getRawData: function () { return this.document.body.innerHTML }, _setRawData: function (S) { this.document.body.innerHTML = S }, _prepareIFrameHtml: function (U) { var T = this.cfg, V = T.customStyle; T = T.customLink; var X = "", S = J.Utils.debugUrl("../theme/editor-iframe.css"); if (T) { for (var W = 0; W < T.length; W++) { X += '<link href="' + T[W] + '" rel="stylesheet"/>' } } return "<!doctype html><html><head><title>${title}</title><link href='" + S + "' rel='stylesheet'/><style>" + (V || "") + "</style>" + X + "</head><body class='ke-editor'>&nbsp;" + (U ? '<script id="ke_actscript" type="text/javascript">' + (C.isCustomDomain() ? 'document.domain="' + E.domain + '";' : "") + 'window.parent.KISSY.Editor._initIFrame("' + U + '");<\/script>' : "") + "</body></html>" }, getSelection: function () { return J.Selection.getSelection(this.document) }, focus: function () { var T = this.document, S = L._4e_getWin(T); H.webkit && S && S.parent && S.parent.focus(); H.webkit && S && S.focus(); T && T.body.focus(); this.notifySelectionChange() }, blur: function () { L._4e_getWin(this.document).blur(); this.document && this.document.body.blur() }, addCustomStyle: function (T) { var S = this.cfg, U = this.document; S.customStyle = S.customStyle || ""; S.customStyle += "\n" + T; S = U.createElement("style"); U.getElementsByTagName("head")[0].appendChild(S); if (S.styleSheet) { S.styleSheet.cssText = T } else { S.appendChild(U.createTextNode(T)) } }, addCustomLink: function (T) { var S = this.cfg, U = this.document; S.customLink = S.customLink || []; S.customLink.push(T); S = U.createElement("link"); S.rel = "stylesheet"; U.getElementsByTagName("head")[0].appendChild(S); S.href = T }, removeCustomLink: function (T) { for (var S = this.cfg, U = A.makeArray(this.document.getElementsByTagName("link")), V = 0; V < U.length; V++) { U[V].href == T && L._4e_remove(U[V]) } S.customLink = S.customLink || []; S = S.customLink; T = A.indexOf(T, S); T != -1 && S.splice(T, 1) }, _setUpIFrame: function () { function U() { X = S.document; T.document = X; W.detach(); X.open("text/html", "replace"); X.write(Y); X.close() } var T = this, W = T.iframe, Y = T._prepareIFrameHtml(T._UUID), S = W[0].contentWindow, X; try { X = S.document } catch (V) { W[0].src = W[0].src; if (I < 7) { setTimeout(U, 10); return } } U() }, ready: function (S) { this._ready ? S() : this.on("dataReady", S) }, addPlugin: function (T, S, U) { this.__plugins = this.__plugins; U = U || {}; U.func = S; this.__plugins[T] = U }, usePlugin: function (T) { var S = this.__plugins[T]; if (S) { if (!(S.status && !S.duplicate)) { T = this.Env.mods[T].requires || []; for (var U = 0; U < T.length; U++) { this.usePlugin(T[U]) } S.func.call(S); S.status = 1 } } }, _monitor: function () { var S = this; S._monitorId && clearTimeout(S._monitorId); S._monitorId = setTimeout(function () { var T = S.getSelection(); if (T && !T.isInvalid) { var U = T.getStartElement(), V = new J.ElementPath(U); if (!S.previousPath || !S.previousPath.compare(V)) { S.previousPath = V; S.fire("selectionChange", { selection: T, path: V, element: U }) } } }, 100) }, notifySelectionChange: function () { this.previousPath = null; this._monitor() }, insertElement: function (o, m, f) { var h = this; if (h.getMode() === B) { h.focus(); var Z, Y = o._4e_name(), b = J.XHTML_DTD, c = J.RANGE, l = J.NODE, g = b.$block[Y], X = h.getSelection(), d = X && X.getRanges(), e, a, V, U; if (!d || d.length == 0) { var T = arguments, W = T.callee; setTimeout(function () { W.apply(h, T) }, 30) } else { h.fire("save"); for (var S = d.length - 1; S >= 0; S--) { e = d[S]; e.deleteContents(); Z = !S && o || o._4e_clone(G); m && m(Z); if (g) { for (; (V = e.getCommonAncestor(D, G)) && (U = b[V._4e_name()]) && !(U && U[Y]); ) { if (V._4e_name() in b.span) { e.splitElement(V) } else { if (e.checkStartOfBlock() && e.checkEndOfBlock()) { e.setStartBefore(V); e.collapse(G); V._4e_remove() } else { e.splitBlock() } } } } e.insertNode(Z); a || (a = Z) } if (a) { Y = a._4e_nextSourceNode(G); b = h.document; U = J.XHTML_DTD; if (U.$inline[Z._4e_name()]) { Y = new O(b.createTextNode(" ")); Y.insertAfter(a) } else { if (Y) { if (Y._4e_name() == "br" && U[Y.parent()._4e_name()].p) { U = new O("<p>&nbsp;</p>", null, b); Y[0].parentNode.replaceChild(U[0], Y[0]); Y = U } } else { U = new O("<p>&nbsp;</p>", null, b); U.insertAfter(a); Y = U } } e.moveToPosition(a, c.POSITION_AFTER_END); Y && Y[0].nodeType == l.NODE_ELEMENT && e.moveToElementEditablePosition(Y); X.selectRanges([e]); h.focus(); Z && Z._4e_scrollIntoView(); h._saveLater(); f && f(Z) } } } }, insertHtml: function (T, S) { if (this.getMode() === B) { if (this.htmlDataProcessor) { T = this.htmlDataProcessor.toDataFormat(T, null, S) } this.focus(); this.fire("save"); var U = this.document; if (I) { U = U.selection; U.type == "Control" && U.clear(); try { U.createRange().pasteHTML(T) } catch (V) { A.log("insertHtml error in ie") } } else { U.execCommand("inserthtml", D, T) } this._saveLater() } }, _saveLater: function () { var S = this; if (S.__saveTimer) { clearTimeout(S.__saveTimer); S.__saveTimer = null } S.__saveTimer = setTimeout(function () { S.fire("save") }, 0) } }); J._initIFrame = function (Y) { function X(d) { N(function () { b.designMode = "on"; setTimeout(function () { b.designMode = "off"; S.focus(); if (!arguments.callee.retry) { arguments.callee.retry = G } }, 50) }, function () { b.designMode = "off"; L.attr(S, "contentEditable", D); L.attr(S, "contentEditable", G); !d && X(1) }) } var T = P.getInstance(Y); Y = T.textarea[0]; var V = T.iframe[0].contentWindow, b = T.document, a = T.cfg, c = b.getElementById("ke_actscript"); L._4e_remove(c); var S = b.body; if (I) { S.hideFocus = G; S.disabled = G; S.contentEditable = G; S.removeAttribute("disabled") } else { setTimeout(function () { if (H.gecko || H.opera) { S.contentEditable = G } else { if (H.webkit) { S.parentNode.contentEditable = G } else { b.designMode = "on" } } }, 0) } if (H.webkit) { R.on(b, "click", function (d) { var e = new O(d.target); A.inArray(e._4e_name(), ["input", "select"]) && d.preventDefault() }); R.on(b, "mouseup", function (d) { var e = new O(d.target); A.inArray(e._4e_name(), ["input", "textarea"]) && d.preventDefault() }) } if (H.gecko || I || H.opera) { var W; W = (new O('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(Y); W.on("focus", function () { T.focus() }); T.activateGecko = function () { H.gecko && T.iframeFocus && W[0].focus() }; T.on("destroy", function () { W.detach(); W.remove() }) } if (b.documentMode || H.gecko || H.opera) { var U = b.documentElement; R.on(U, "mousedown", function (d) { if ((new O(d.target))[0] == U) { H.gecko && X(D); W[0].focus() } }) } R.on(V, "focus", function () { if (H.gecko) { X(D) } else { H.opera && S.focus() } T.notifySelectionChange() }); H.gecko && R.on(T.document, "mousedown", function () { T.iframeFocus || X(D) }); if (I) { R.on(b, "keydown", function (f) { if (f.keyCode in { 8: 1, 46: 1 }) { var g = T.getSelection(), d = g.getSelectedElement(); if (d) { T.fire("save"); var e = g.getRanges()[0].createBookmark(); d._4e_remove(); g.selectBookmarks([e]); T.fire("save"); f.preventDefault() } } }); if (b.compatMode == "CSS1Compat") { var Z = { 33: 1, 34: 1 }; R.on(b, "keydown", function (d) { d.keyCode in Z && setTimeout(function () { T.getSelection().scrollIntoView() }, 0) }) } } setTimeout(function () { I && setTimeout(function () { if (b) { S.runtimeStyle.marginBottom = "0px"; S.runtimeStyle.marginBottom = "" } }, 1000) }, 0); setTimeout(function () { T.fire("dataReady"); var e = a.disableObjectResizing, f = a.disableInlineTableEditing; if (e || f) { try { b.execCommand("enableObjectResizing", D, !e); b.execCommand("enableInlineTableEditing", D, !f) } catch (d) { R.on(S, I ? "resizestart" : "resize", function (h) { var g = new O(h.target); if (e || g._4e_name() === "table" && f) { h.preventDefault() } }) } } }, 10); H.webkit && R.on(b, "mousedown", function (d) { d = new O(d.target); A.inArray(d._4e_name(), ["img", "hr", "input", "textarea", "select"]) && T.getSelection().selectElement(d) }); H.gecko && R.on(b, "dragstart", function (d) { var e = new O(d.target); e._4e_name() === "img" && /ke_/.test(e[0].className) && d.preventDefault() }); P.add(T) }; document.documentMode > 7 && function () { for (var T = A.all("link"), S = 0; S < T.length; S++) { var U = new O(T[S]), V = U.attr("href"); V.indexOf("editor-pkg-min-mhtml.css") != -1 && U.attr("href", V.replace(/editor-pkg-min-mhtml\.css/g, "editor-pkg-min-datauri.css")) } } (); K = J.prototype; C.extern(K, { removeCustomLink: K.removeCustomLink, addCustomLink: K.addCustomLink, setData: K.setData, getData: K.getData, insertElement: K.insertElement, insertHtml: K.insertHtml, ready: K.ready, addCustomStyle: K.addCustomStyle, addCommand: K.addCommand, hasCommand: K.hasCommand, execCommand: K.execCommand, useDialog: K.useDialog, addDialog: K.addDialog, getDialog: K.getDialog, getMode: K.getMode, sync: K.sync, getSelection: K.getSelection, focus: K.focus, blur: K.blur, notifySelectionChange: K.notifySelectionChange }) }); KISSY.Editor.add("zindex", function () { var A = KISSY.Editor; if (!A.zIndexManager) { A.zIndexManager = { BUBBLE_VIEW: 1100, POPUP_MENU: 1200, DD_PG: 99999, STORE_FLASH_SHOW: 99999, MAXIMIZE: 900, OVERLAY: 9999, LOADING: 11000, LOADING_CANCEL: 12000, SELECT: 1200 }; A.baseZIndex = function (B) { return (A.Config.baseZIndex || 10000) + B }; A.baseZIndex = A.baseZIndex; A.zIndexManager = A.zIndexManager } }); KISSY.Editor.add("dtd", function (A) { A.XHTML_DTD = function () { function I() { for (var W = arguments[0], V = arguments.length - 1; V > 0; ) { KISSY.mix(W, arguments[V--]) } return W } var E = { isindex: 1, fieldset: 1 }, D = { input: 1, button: 1, select: 1, textarea: 1, label: 1 }, F = I({ a: 1 }, D), B = I({ iframe: 1 }, F), J = { hr: 1, ul: 1, menu: 1, div: 1, blockquote: 1, noscript: 1, table: 1, center: 1, address: 1, dir: 1, pre: 1, h5: 1, dl: 1, h4: 1, noframes: 1, h6: 1, ol: 1, h1: 1, h3: 1, h2: 1 }, K = { ins: 1, del: 1, script: 1, style: 1 }, O = I({ b: 1, acronym: 1, bdo: 1, "var": 1, "#": 1, abbr: 1, code: 1, br: 1, i: 1, cite: 1, kbd: 1, u: 1, strike: 1, s: 1, tt: 1, strong: 1, q: 1, samp: 1, em: 1, dfn: 1, span: 1 }, K), R = I({ sub: 1, img: 1, object: 1, sup: 1, basefont: 1, map: 1, applet: 1, font: 1, big: 1, small: 1 }, O), U = I({ p: 1 }, R); D = I({ iframe: 1 }, R, D); R = { img: 1, noscript: 1, br: 1, kbd: 1, center: 1, button: 1, basefont: 1, h5: 1, h4: 1, samp: 1, h6: 1, ol: 1, h1: 1, h3: 1, h2: 1, form: 1, font: 1, "#": 1, select: 1, menu: 1, ins: 1, abbr: 1, label: 1, code: 1, table: 1, script: 1, cite: 1, input: 1, iframe: 1, strong: 1, textarea: 1, noframes: 1, big: 1, small: 1, span: 1, hr: 1, sub: 1, bdo: 1, "var": 1, div: 1, object: 1, sup: 1, strike: 1, dir: 1, map: 1, dl: 1, applet: 1, del: 1, isindex: 1, fieldset: 1, ul: 1, b: 1, acronym: 1, a: 1, blockquote: 1, i: 1, u: 1, s: 1, tt: 1, address: 1, q: 1, pre: 1, p: 1, em: 1, dfn: 1 }; var S = I({ a: 1 }, D), Q = { tr: 1 }, G = { "#": 1 }, N = I({ param: 1 }, R), T = I({ form: 1 }, E, B, J, U), P = { li: 1 }, C = { base: 1, link: 1, meta: 1, title: 1 }, M = I(C, { style: 1, script: 1 }), L = { head: 1, body: 1 }, H = { address: 1, blockquote: 1, center: 1, dir: 1, div: 1, dl: 1, fieldset: 1, form: 1, h1: 1, h2: 1, h3: 1, h4: 1, h5: 1, h6: 1, hr: 1, isindex: 1, menu: 1, noframes: 1, ol: 1, p: 1, pre: 1, table: 1, ul: 1 }; return { $nonBodyContent: I({ html: 1 }, L, C), $block: H, $blockLimit: { body: 1, div: 1, td: 1, th: 1, caption: 1, form: 1 }, $inline: S, $body: I({ script: 1, style: 1 }, H), $cdata: { script: 1, style: 1 }, $empty: { area: 1, base: 1, br: 1, col: 1, hr: 1, img: 1, input: 1, link: 1, meta: 1, param: 1 }, $listItem: { dd: 1, dt: 1, li: 1 }, $list: { ul: 1, ol: 1, dl: 1 }, $nonEditable: { applet: 1, button: 1, embed: 1, iframe: 1, map: 1, object: 1, option: 1, script: 1, textarea: 1, param: 1 }, $removeEmpty: { abbr: 1, acronym: 1, address: 1, b: 1, bdo: 1, big: 1, cite: 1, code: 1, del: 1, dfn: 1, em: 1, font: 1, i: 1, ins: 1, label: 1, kbd: 1, q: 1, s: 1, samp: 1, small: 1, span: 1, strike: 1, strong: 1, sub: 1, sup: 1, tt: 1, u: 1, "var": 1 }, $tabIndex: { a: 1, area: 1, button: 1, input: 1, object: 1, select: 1, textarea: 1 }, $tableContent: { caption: 1, col: 1, colgroup: 1, tbody: 1, td: 1, tfoot: 1, th: 1, thead: 1, tr: 1 }, html: L, head: M, style: G, body: T, base: {}, link: {}, meta: {}, title: G, col: {}, tr: { td: 1, th: 1 }, img: {}, colgroup: { col: 1 }, noscript: T, td: T, br: {}, th: T, center: T, kbd: S, button: I(U, J), basefont: {}, h5: S, h4: S, samp: S, h6: S, ol: P, h1: S, h3: S, option: G, h2: S, form: I(E, B, J, U), select: { optgroup: 1, option: 1 }, font: S, ins: S, menu: P, abbr: S, label: S, table: { thead: 1, col: 1, tbody: 1, tr: 1, colgroup: 1, caption: 1, tfoot: 1 }, code: S, script: G, tfoot: Q, cite: S, li: T, input: {}, iframe: T, strong: S, textarea: G, noframes: T, big: S, small: S, span: S, hr: {}, dt: S, sub: S, optgroup: { option: 1 }, param: {}, bdo: S, "var": S, div: T, object: N, sup: S, dd: T, strike: S, area: {}, dir: P, map: I({ area: 1, form: 1, p: 1 }, E, K, J), applet: N, dl: { dt: 1, dd: 1 }, del: S, isindex: {}, fieldset: I({ legend: 1 }, R), thead: Q, ul: P, acronym: S, b: S, a: D, blockquote: T, caption: S, i: S, u: S, tbody: Q, s: S, address: I(B, U), tt: S, legend: S, q: S, pre: I(O, F), p: S, em: S, dfn: S} } (); A.XHTML_DTD = A.XHTML_DTD }); KISSY.Editor.add("elementpath", function (D) { function A(N) { var Q = F, O = F, M = []; for (N = N; N && N[0]; ) { if (N[0].nodeType == I.NODE_ELEMENT) { if (!this.lastElement) { this.lastElement = N } var J = N._4e_name(); if (!O) { if (!Q && B[J]) { Q = N } if (C[J]) { var K; if (K = !Q) { if (K = J == "div") { Q: { K = N; K = K[0] || K; K = K.childNodes; for (var P = 0, L = K.length; P < L; P++) { var R = K[P]; if (R.nodeType == I.NODE_ELEMENT && G.$block[R.nodeName.toLowerCase()]) { K = true; break Q } } K = false } K = !K } K = K } if (K) { Q = N } else { O = N } } } M.push(N); if (J == "body") { break } } N = N.parent() } this.block = this.block = Q; this.blockLimit = this.blockLimit = O; this.elements = this.elements = M } var H = KISSY.DOM, G = D.XHTML_DTD, I = D.NODE, F = null, B = { address: 1, blockquote: 1, dl: 1, h1: 1, h2: 1, h3: 1, h4: 1, h5: 1, h6: 1, p: 1, pre: 1, li: 1, dt: 1, dd: 1 }, C = { body: 1, div: 1, table: 1, tbody: 1, tr: 1, td: 1, th: 1, caption: 1, form: 1 }; A.prototype = { compare: function (K) { var J = this.elements; K = K && K.elements; if (!K || J.length != K.length) { return false } for (var L = 0; L < J.length; L++) { if (!H._4e_equals(J[L], K[L])) { return false } } return true }, contains: function (K) { for (var J = this.elements, L = 0; L < J.length; L++) { if (J[L]._4e_name() in K) { return J[L] } } return F } }; D.ElementPath = D.ElementPath = A; var E = A.prototype; D.Utils.extern(E, { compare: E.compare, contains: E.contains }) }); KISSY.Editor.add("walker", function (D) { function A(T, M) { if (this._.end) { return B } var R, V = this.range, S, X = this.guard, Q = this.type, P = T ? "_4e_previousSourceNode" : "_4e_nextSourceNode"; if (!this._.start) { this._.start = 1; V.trim(); if (V.collapsed) { this.end(); return B } } if (!T && !this._.guardLTR) { var N = V.endContainer, O = new H(N[0].childNodes[V.endOffset]); this._.guardLTR = function (a, Z) { return (a = F._4e_wrap(a)) && a[0] && (!Z || !F._4e_equals(N, a)) && (!O[0] || !a._4e_equals(O)) && (a[0].nodeType != E.NODE_ELEMENT || !Z || a._4e_name() != "body") } } if (T && !this._.guardRTL) { var W = V.startContainer, U = V.startOffset > 0 && new H(W[0].childNodes[V.startOffset - 1]); this._.guardRTL = function (a, Z) { return (a = F._4e_wrap(a)) && a[0] && (!Z || !a._4e_equals(W)) && (!U[0] || !a._4e_equals(U)) && (a[0].nodeType != E.NODE_ELEMENT || !Z || a._4e_name() != "body") } } var Y = T ? this._.guardRTL : this._.guardLTR; S = X ? function (a, Z) { if (Y(a, Z) === I) { return I } return X(a, Z) } : Y; if (this.current) { R = this.current[P](I, Q, S) } else { if (T) { R = V.endContainer; if (V.endOffset > 0) { R = new H(R[0].childNodes[V.endOffset - 1]); if (S(R) === I) { R = B } } else { R = S(R, L) === I ? B : R._4e_previousSourceNode(L, Q, S) } } else { R = V.startContainer; if ((R = new H(R[0].childNodes[V.startOffset])) && R[0]) { if (S(R) === I) { R = B } } else { R = S(V.startContainer, L) === I ? B : V.startContainer._4e_nextSourceNode(L, Q, S) } } } for (; R && R[0] && !this._.end; ) { this.current = R; if (!this.evaluator || this.evaluator(R) !== I) { if (!M) { return R } } else { if (M && this.evaluator) { return I } } R = R[P](I, Q, S) } this.end(); return this.current = B } function K(O) { for (var N, M = B; N = A.call(this, O); ) { M = N } return M } function J(M) { this.range = M; this._ = {} } var L = true, I = false, B = null, C = KISSY, E = D.NODE, F = C.DOM, H = C.Node; C.augment(J, { end: function () { this._.end = 1 }, next: function () { return A.call(this) }, previous: function () { return A.call(this, L) }, checkForward: function () { return A.call(this, I, L) !== I }, checkBackward: function () { return A.call(this, L, L) !== I }, lastForward: function () { return K.call(this) }, lastBackward: function () { return K.call(this, L) }, reset: function () { delete this.current; this._ = {} } }); J.blockBoundary = function (M) { return function (N) { N = F._4e_wrap(N); return !(N && N[0].nodeType == E.NODE_ELEMENT && N._4e_isBlockBoundary(M)) } }; J.listItemBoundary = function () { return this.blockBoundary({ br: 1 }) }; J.bookmark = function (O, N) { function M(P) { return P && P[0] && P._4e_name() == "span" && P.attr("_ke_bookmark") } return function (P) { var R, Q; R = P && P[0] && P[0].nodeType == E.NODE_TEXT && (Q = P.parent()) && M(Q); R = O ? R : R || M(P); return N ^ R } }; J.whitespaces = function (M) { return function (N) { N = (N = N[0] || N) && N.nodeType == E.NODE_TEXT && !C.trim(N.nodeValue); return M ^ N } }; J.invisible = function (N) { var M = J.whitespaces(); return function (O) { O = M(O) || O[0].nodeType == E.NODE_ELEMENT && !O[0].offsetHeight; return N ^ O } }; D.Walker = J; D.Walker = J; var G = J.prototype; D.Utils.extern(G, { end: G.end, next: G.next, previous: G.previous, checkForward: G.checkForward, checkBackward: G.checkBackward, lastForward: G.lastForward, lastBackward: G.lastBackward, reset: G.reset }); D.Utils.extern(J, { blockBoundary: J.blockBoundary, listItemBoundary: J.listItemBoundary, bookmark: J.bookmark, whitespaces: J.whitespaces, invisible: J.invisible }) }); KISSY.Editor.add("range", function (R) { function N(D) { this.endOffset = this.endContainer = this.startOffset = this.startContainer = Y; this.collapsed = Q; this.document = D } function I(E) { var D = E[0].nodeType != Z.NODE_TEXT && E._4e_name() in T.$removeEmpty, a = !z.trim(E[0].nodeValue); E = !!E.parent().attr("_ke_bookmark"); return D || a || E } function G(D) { return !A(D) && !H(D) } function K(E) { var D = V, a = U.bookmark(Q); return function (b) { if (a(b)) { return Q } if (b[0].nodeType == Z.NODE_TEXT) { if (z.trim(b[0].nodeValue).length) { return V } } else { if (b[0].nodeType == Z.NODE_ELEMENT) { if (!B[b._4e_name()]) { if (!E && !F.ie && b._4e_name() == "br" && !D) { D = Q } else { return V } } } } return Q } } function C(E, D) { function a(b) { return b && b.nodeName == "span" && b.getAttribute("_ke_bookmark") } return function (c) { var d, b; d = c && !c.nodeName && (b = c.parentNode) && a(b); d = E ? d : d || a(c); return D ^ d } } function O(D) { return function (E) { E = (E = E[0] || E) && E.nodeType == Z.NODE_TEXT && !z.trim(E.nodeValue); return D ^ E } } R.RANGE = { POSITION_AFTER_START: 1, POSITION_BEFORE_END: 2, POSITION_BEFORE_START: 3, POSITION_AFTER_END: 4, ENLARGE_ELEMENT: 1, ENLARGE_BLOCK_CONTENTS: 2, ENLARGE_LIST_ITEM_CONTENTS: 3, START: 1, END: 2, STARTEND: 3, SHRINK_ELEMENT: 1, SHRINK_TEXT: 2 }; R.RANGE = R.RANGE; var Q = true, V = false, Y = null, z = KISSY, Z = R.NODE, X = R.RANGE, L = R.POSITION, U = R.Walker, k = z.DOM, W = R.Utils.getByAddress, F = z.UA, T = R.XHTML_DTD, S = R.ElementPath, M = z.Node, P = { area: 1, base: 1, br: 1, col: 1, hr: 1, img: 1, input: 1, link: 1, meta: 1, param: 1 }; N.prototype.toString = function () { var D = []; D.push((this.startContainer[0].id || this.startContainer[0].nodeName) + ":" + this.startOffset); D.push((this.endContainer[0].id || this.endContainer[0].nodeName) + ":" + this.endOffset); return D.join("<br/>") }; z.augment(N, { updateCollapsed: function () { this.collapsed = this.startContainer && this.endContainer && k._4e_equals(this.startContainer, this.endContainer) && this.startOffset == this.endOffset }, optimize: function () { var E = this.startContainer, D = this.startOffset; if (E[0].nodeType != Z.NODE_ELEMENT) { if (D) { D >= E[0].nodeValue.length && this.setStartAfter(E) } else { this.setStartBefore(E) } } E = this.endContainer; D = this.endOffset; if (E[0].nodeType != Z.NODE_ELEMENT) { if (D) { D >= E[0].nodeValue.length && this.setEndAfter(E) } else { this.setEndBefore(E) } } }, setStartAfter: function (D) { this.setStart(D.parent(), D._4e_index() + 1) }, setStartBefore: function (D) { this.setStart(D.parent(), D._4e_index()) }, setEndAfter: function (D) { this.setEnd(D.parent(), D._4e_index() + 1) }, setEndBefore: function (D) { this.setEnd(D.parent(), D._4e_index()) }, optimizeBookmark: function () { var E = this.startContainer, D = this.endContainer; E && E._4e_name() == "span" && E.attr("_ke_bookmark") && this.setStartAt(E, X.POSITION_BEFORE_START); D && D._4e_name() == "span" && D.attr("_ke_bookmark") && this.setEndAt(D, X.POSITION_AFTER_END) }, setStart: function (E, D) { if (E[0].nodeType == Z.NODE_ELEMENT && P[E._4e_name()]) { E = E.parent(); D = E._4e_index() } this.startContainer = E; this.startOffset = D; if (!this.endContainer) { this.endContainer = E; this.endOffset = D } this.updateCollapsed() }, setEnd: function (E, D) { if (E[0].nodeType == Z.NODE_ELEMENT && P[E._4e_name()]) { E = E.parent(); D = E._4e_index() + 1 } this.endContainer = E; this.endOffset = D; if (!this.startContainer) { this.startContainer = E; this.startOffset = D } this.updateCollapsed() }, setStartAt: function (E, D) { switch (D) { case X.POSITION_AFTER_START: this.setStart(E, 0); break; case X.POSITION_BEFORE_END: E[0].nodeType == Z.NODE_TEXT ? this.setStart(E, E[0].nodeValue.length) : this.setStart(E, E[0].childNodes.length); break; case X.POSITION_BEFORE_START: this.setStartBefore(E); break; case X.POSITION_AFTER_END: this.setStartAfter(E) } this.updateCollapsed() }, setEndAt: function (E, D) { switch (D) { case X.POSITION_AFTER_START: this.setEnd(E, 0); break; case X.POSITION_BEFORE_END: E[0].nodeType == Z.NODE_TEXT ? this.setEnd(E, E[0].nodeValue.length) : this.setEnd(E, E[0].childNodes.length); break; case X.POSITION_BEFORE_START: this.setEndBefore(E); break; case X.POSITION_AFTER_END: this.setEndAfter(E) } this.updateCollapsed() }, execContentsAction: function (e, b) { var l = this.startContainer, D = this.endContainer, E = this.startOffset, o = this.endOffset, j, i = this.document, h; this.optimizeBookmark(); if (D[0].nodeType == Z.NODE_TEXT) { D = D._4e_splitText(o) } else { if (D[0].childNodes.length > 0) { if (o >= D[0].childNodes.length) { D = new M(D[0].appendChild(i.createTextNode(""))); h = Q } else { D = new M(D[0].childNodes[o]) } } } if (l[0].nodeType == Z.NODE_TEXT) { l._4e_splitText(E); if (l._4e_equals(D)) { D = new M(l[0].nextSibling) } } else { if (E) { if (E >= l[0].childNodes.length) { j = new M(i.createTextNode("")); l.append(j); l = j; j = Q } else { l = new M(l[0].childNodes[E].previousSibling) } } else { j = new M(i.createTextNode("")); l.prepend(j); l = j; j = Q } } E = l._4e_parents(); o = D._4e_parents(); var m, g, f; for (m = 0; m < E.length; m++) { g = E[m]; f = o[m]; if (!g._4e_equals(f)) { break } } i = b; for (var d, a, c, n = m; n < E.length; n++) { d = E[n]; a = i && !d._4e_equals(l) ? i.appendChild(d._4e_clone()[0]) : null; for (d = d[0].nextSibling; d; ) { if (k._4e_equals(o[n], d) || k._4e_equals(D, d)) { break } c = d.nextSibling; if (e == 2) { i.appendChild(d.cloneNode(Q)) } else { k._4e_remove(d); e == 1 && i.appendChild(d) } d = c } if (a) { i = a } } i = b; for (m = m; m < o.length; m++) { d = o[m]; a = i && e > 0 && !d._4e_equals(D) ? i.appendChild(d._4e_clone()[0]) : null; if (!E[m] || !d.parent()._4e_equals(E[m].parent())) { for (d = d[0].previousSibling; d; ) { if (k._4e_equals(E[m], d) || k._4e_equals(l, d)) { break } c = d.previousSibling; if (e == 2) { i.insertBefore(d.cloneNode(Q), i.firstChild) } else { k._4e_remove(d); e == 1 && i.insertBefore(d, i.firstChild) } d = c } } if (a) { i = a } } if (e == 2) { f = this.startContainer[0]; if (f.nodeType == Z.NODE_TEXT && f.nextSibling && f.nextSibling.nodeType == Z.NODE_TEXT) { f.data += f.nextSibling.data; f.parentNode.removeChild(f.nextSibling) } f = this.endContainer[0]; if (f.nodeType == Z.NODE_TEXT && f.nextSibling && f.nextSibling.nodeType == Z.NODE_TEXT) { f.data += f.nextSibling.data; f.parentNode.removeChild(f.nextSibling) } } else { if (g && f && (!l.parent()._4e_equals(g.parent()) || !D.parent()._4e_equals(f.parent()))) { g = f._4e_index(); j && f.parent()._4e_equals(l.parent()) && g--; this.setStart(f.parent(), g) } this.collapse(Q) } j && l._4e_remove(); h && D[0].parentNode && D._4e_remove() }, collapse: function (D) { if (D) { this.endContainer = this.startContainer; this.endOffset = this.startOffset } else { this.startContainer = this.endContainer; this.startOffset = this.endOffset } this.collapsed = Q }, clone: function () { var D = new N(this.document); D.startContainer = this.startContainer; D.startOffset = this.startOffset; D.endContainer = this.endContainer; D.endOffset = this.endOffset; D.collapsed = this.collapsed; return D }, getEnclosedNode: function () { var E = this.clone(); E.optimize(); if (E.startContainer[0].nodeType != Z.NODE_ELEMENT || E.endContainer[0].nodeType != Z.NODE_ELEMENT) { return Y } var D = new R.Walker(E), b = C(Q, undefined), a = O(Q); E.evaluator = function (c) { return a(c) && b(c) }; E = D.next(); D.reset(); D = D.previous(); return E && E._4e_equals(D) ? E : Y }, shrink: function (b, a) { if (!this.collapsed) { b = b || X.SHRINK_TEXT; var f = this.clone(), D = this.startContainer, E = this.endContainer, h = this.startOffset, e = this.endOffset, d = 1, c = 1; if (D && D[0].nodeType == Z.NODE_TEXT) { if (h) { if (h >= D[0].nodeValue.length) { f.setStartAfter(D) } else { f.setStartBefore(D); d = 0 } } else { f.setStartBefore(D) } } if (E && E[0].nodeType == Z.NODE_TEXT) { if (e) { if (e >= E[0].nodeValue.length) { f.setEndAfter(E) } else { f.setEndAfter(E); c = 0 } } else { f.setEndBefore(E) } } f = new U(f); f.evaluator = function (i) { i = i[0] || i; return i.nodeType == (b == X.SHRINK_ELEMENT ? Z.NODE_ELEMENT : Z.NODE_TEXT) }; var g; f.guard = function (j, i) { j = j[0] || j; if (b == X.SHRINK_ELEMENT && j.nodeType == Z.NODE_TEXT) { return V } if (i && j == g) { return V } if (!i && j.nodeType == Z.NODE_ELEMENT) { g = j } return Q }; if (d) { (D = f[b == X.SHRINK_ELEMENT ? "lastForward" : "next"]()) && this.setStartAt(D, a ? X.POSITION_AFTER_START : X.POSITION_BEFORE_START) } if (c) { f.reset(); (f = f[b == X.SHRINK_ELEMENT ? "lastBackward" : "previous"]()) && this.setEndAt(f, a ? X.POSITION_BEFORE_END : X.POSITION_AFTER_END) } return !!(d || c) } }, getTouchedStartNode: function () { var D = this.startContainer; if (this.collapsed || D[0].nodeType != Z.NODE_ELEMENT) { return D } return D.childNodes[this.startOffset] || D }, createBookmark2: function (E) { var D = this.startContainer, d = this.endContainer, c = this.startOffset, e = this.endOffset, a, b; if (!D || !d) { return { start: 0, end: 0} } if (E) { if (D[0].nodeType == Z.NODE_ELEMENT) { if ((a = new M(D[0].childNodes[c])) && a[0] && a[0].nodeType == Z.NODE_TEXT && c > 0 && a[0].previousSibling.nodeType == Z.NODE_TEXT) { D = a; c = 0 } } for (; D[0].nodeType == Z.NODE_TEXT && (b = D._4e_previous()) && b[0].nodeType == Z.NODE_TEXT; ) { D = b; c += b[0].nodeValue.length } if (!this.collapsed) { if (d[0].nodeType == Z.NODE_ELEMENT) { if ((a = new M(d[0].childNodes[e])) && a[0] && a[0].nodeType == Z.NODE_TEXT && e > 0 && a[0].previousSibling.nodeType == Z.NODE_TEXT) { d = a; e = 0 } } for (; d[0].nodeType == Z.NODE_TEXT && (b = d._4e_previous()) && b[0].nodeType == Z.NODE_TEXT; ) { d = b; e += b[0].nodeValue.length } } } return { start: D._4e_address(E), end: this.collapsed ? Y : d._4e_address(E), startOffset: c, endOffset: e, normalized: E, is2: Q} }, createBookmark: function (E) { var D, c, b, d, a = this.collapsed; D = new M("<span>", Y, this.document); D.attr("_ke_bookmark", 1); D.css("display", "none"); D.html("&nbsp;"); if (E) { b = z.guid("ke_bm_"); D.attr("id", b + "S") } if (!a) { c = D._4e_clone(); c.html("&nbsp;"); E && c.attr("id", b + "E"); d = this.clone(); d.collapse(); d.insertNode(c) } d = this.clone(); d.collapse(Q); d.insertNode(D); if (c) { this.setStartAfter(D); this.setEndBefore(c) } else { this.moveToPosition(D, X.POSITION_AFTER_END) } return { startNode: E ? b + "S" : D, endNode: E ? b + "E" : c, serializable: E, collapsed: a} }, moveToPosition: function (E, D) { this.setStartAt(E, D); this.collapse(Q) }, trim: function (E, D) { var c = this.startContainer, b = this.startOffset, d = this.collapsed; if ((!E || d) && c[0] && c[0].nodeType == Z.NODE_TEXT) { if (b) { if (b >= c[0].nodeValue.length) { b = c._4e_index() + 1; c = c.parent() } else { var a = c._4e_splitText(b); b = c._4e_index() + 1; c = c.parent(); if (k._4e_equals(this.startContainer, this.endContainer)) { this.setEnd(a, this.endOffset - this.startOffset) } else { if (k._4e_equals(c, this.endContainer)) { this.endOffset += 1 } } } } else { b = c._4e_index(); c = c.parent() } this.setStart(c, b); if (d) { this.collapse(Q); return } } c = this.endContainer; b = this.endOffset; if (!(D || d) && c[0] && c[0].nodeType == Z.NODE_TEXT) { if (b) { b >= c.nodeValue.length || c._4e_splitText(b); b = c._4e_index() + 1 } else { b = c._4e_index() } c = c.parent(); this.setEnd(c, b) } }, insertNode: function (E) { this.optimizeBookmark(); this.trim(V, Q); var D = this.startContainer; D[0].insertBefore(E[0] || E, D[0].childNodes[this.startOffset] || null); k._4e_equals(E.parent(), this.endContainer) && this.endOffset++; this.setStartBefore(E) }, moveToBookmark: function (E) { if (E.is2) { var D = W(this.document, E.start, E.normalized), b = E.startOffset, a = E.end && W(this.document, E.end, E.normalized); E = E.endOffset; this.setStart(D, b); a ? this.setEnd(a, E) : this.collapse(Q) } else { D = (b = E.serializable) ? z.one("#" + E.startNode, this.document) : E.startNode; E = b ? z.one("#" + E.endNode, this.document) : E.endNode; this.setStartBefore(D); D._4e_remove(); if (E && E[0]) { this.setEndBefore(E); E._4e_remove() } else { this.collapse(Q) } } }, getCommonAncestor: function (E, D) { var b = this.startContainer, a = this.endContainer; b = k._4e_equals(b, a) ? E && b[0].nodeType == Z.NODE_ELEMENT && this.startOffset == this.endOffset - 1 ? new M(b[0].childNodes[this.startOffset]) : b : b._4e_commonAncestor(a); return D && b[0].nodeType == Z.NODE_TEXT ? b.parent() : b }, enlarge: function (e) { switch (e) { case X.ENLARGE_ELEMENT: if (this.collapsed) { break } e = this.getCommonAncestor(); var b = new M(this.document.body), m, D, E, p, j, i = V, h, n; h = this.startContainer; n = this.startOffset; if (h[0].nodeType == Z.NODE_TEXT) { if (n) { h = !z.trim(h[0].nodeValue.substring(0, n)).length && h; i = !!h } if (h) { if (!(p = h[0].previousSibling)) { E = h.parent() } } } else { if (n) { p = h[0].childNodes[n - 1] || h[0].lastChild } p || (E = h) } for (; E || p; ) { if (E && !p) { if (!j && k._4e_equals(E, e)) { j = Q } if (!b.contains(E)) { break } if (!i || E.css("display") != "inline") { i = V; if (j) { m = E } else { this.setStartBefore(E) } } p = E[0].previousSibling } for (; p; ) { h = V; if (p.nodeType == Z.NODE_TEXT) { n = p.nodeValue; if (/[^\s\ufeff]/.test(n)) { p = Y } h = /[\s\ufeff]$/.test(n) } else { if (p.offsetWidth > 0 && !p.getAttribute("_ke_bookmark")) { if (i && T.$removeEmpty[p.nodeName.toLowerCase()]) { n = k.text(p); if (/[^\s\ufeff]/.test(n)) { p = Y } else { for (var g = p.all || p.getElementsByTagName("*"), f = 0, d; d = g[f++]; ) { if (!T.$removeEmpty[d.nodeName.toLowerCase()]) { p = Y; break } } } if (p) { h = !!n.length } } else { p = Y } } } if (h) { if (i) { if (j) { m = E } else { E && this.setStartBefore(E) } } else { i = Q } } if (p) { h = p.previousSibling; if (!E && !h) { E = new M(p); p = Y; break } p = h } else { E = Y } } if (E) { E = E.parent() } } h = this.endContainer; n = this.endOffset; E = p = Y; j = i = V; if (h[0].nodeType == Z.NODE_TEXT) { h = !z.trim(h[0].nodeValue.substring(n)).length && h; i = !(h && h[0].nodeValue.length); if (h) { if (!(p = h[0].nextSibling)) { E = h.parent() } } } else { (p = h[0].childNodes[n]) || (E = h) } for (; E || p; ) { if (E && !p) { if (!j && k._4e_equals(E, e)) { j = Q } if (!b.contains(E)) { break } if (!i || E.css("display") != "inline") { i = V; if (j) { D = E } else { E && this.setEndAfter(E) } } p = E[0].nextSibling } for (; p; ) { h = V; if (p.nodeType == Z.NODE_TEXT) { n = p.nodeValue; if (/[^\s\ufeff]/.test(n)) { p = Y } h = /^[\s\ufeff]/.test(n) } else { if (p.offsetWidth > 0 && !p.getAttribute("_ke_bookmark")) { if (i && T.$removeEmpty[p.nodeName.toLowerCase()]) { n = k.text(p); if (/[^\s\ufeff]/.test(n)) { p = Y } else { g = p.all || p.getElementsByTagName("*"); for (f = 0; d = g[f++]; ) { if (!T.$removeEmpty[d.nodeName.toLowerCase()]) { p = Y; break } } } if (p) { h = !!n.length } } else { p = Y } } } if (h) { if (i) { if (j) { D = E } else { this.setEndAfter(E) } } } if (p) { h = p.nextSibling; if (!E && !h) { E = new M(p); p = Y; break } p = h } else { E = Y } } if (E) { E = E.parent() } } if (m && D) { e = m.contains(D) ? D : m; this.setStartBefore(e); this.setEndAfter(e) } break; case X.ENLARGE_BLOCK_CONTENTS: case X.ENLARGE_LIST_ITEM_CONTENTS: E = new N(this.document); b = new M(this.document.body); E.setStartAt(b, X.POSITION_AFTER_START); E.setEnd(this.startContainer, this.startOffset); E = new U(E); var a, c, o = U.blockBoundary(e == X.ENLARGE_LIST_ITEM_CONTENTS ? { br: 1} : Y), l = function (r) { var q = o(r); q || (a = r); return q }; m = function (r) { var q = l(r); if (!q && r[0] && r._4e_name() == "br") { c = r } return q }; E.guard = l; E = E.lastBackward(); a = a || b; this.setStartAt(a, a._4e_name() != "br" && (!E && this.checkStartOfBlock() || E && a.contains(E)) ? X.POSITION_AFTER_START : X.POSITION_AFTER_END); E = this.clone(); E.collapse(); E.setEndAt(b, X.POSITION_BEFORE_END); E = new U(E); E.guard = e == X.ENLARGE_LIST_ITEM_CONTENTS ? m : l; a = Y; E = E.lastForward(); a = a || b; this.setEndAt(a, !E && this.checkEndOfBlock() || E && a.contains(E) ? X.POSITION_BEFORE_END : X.POSITION_BEFORE_START); c && this.setEndAfter(c) } }, checkStartOfBlock: function () { var E = this.startContainer, D = this.startOffset; if (D && E[0].nodeType == Z.NODE_TEXT) { if (z.trim(E[0].nodeValue.substring(0, D)).length) { return V } } this.trim(); E = new S(this.startContainer); D = this.clone(); D.collapse(Q); D.setStartAt(E.block || E.blockLimit, X.POSITION_AFTER_START); E = new U(D); E.evaluator = K(Q); return E.checkBackward() }, checkEndOfBlock: function () { var E = this.endContainer, D = this.endOffset; if (E[0].nodeType == Z.NODE_TEXT) { if (z.trim(E[0].nodeValue.substring(D)).length) { return V } } this.trim(); E = new S(this.endContainer); D = this.clone(); D.collapse(V); D.setEndAt(E.block || E.blockLimit, X.POSITION_BEFORE_END); E = new U(D); E.evaluator = K(V); return E.checkForward() }, deleteContents: function () { this.collapsed || this.execContentsAction(0) }, extractContents: function () { var D = this.document.createDocumentFragment(); this.collapsed || this.execContentsAction(1, D); return D }, checkBoundaryOfElement: function (E, D) { var a = this.clone(); a[D == X.START ? "setStartAt" : "setEndAt"](E, D == X.START ? X.POSITION_AFTER_START : X.POSITION_BEFORE_END); a = new U(a); a.evaluator = I; return a[D == X.START ? "checkBackward" : "checkForward"]() }, getBoundaryNodes: function () { var E = this.startContainer, D = this.endContainer, b = this.startOffset, a = this.endOffset, c; if (E[0].nodeType == Z.NODE_ELEMENT) { c = E[0].childNodes.length; if (c > b) { E = new M(E[0].childNodes[b]) } else { if (c < 1) { E = E._4e_previousSourceNode() } else { for (E = E[0]; E.lastChild; ) { E = E.lastChild } E = new M(E); E = E._4e_nextSourceNode() || E } } } if (D[0].nodeType == Z.NODE_ELEMENT) { c = D[0].childNodes.length; if (c > a) { D = (new M(D[0].childNodes[a]))._4e_previousSourceNode(Q) } else { if (c < 1) { D = D._4e_previousSourceNode() } else { for (D = D[0]; D.lastChild; ) { D = D.lastChild } D = new M(D) } } } if (E._4e_position(D) & L.POSITION_FOLLOWING) { E = D } return { startNode: E, endNode: D} }, fixBlock: function (E, D) { var d = this.createBookmark(), c = new M(this.document.createElement(D)); this.collapse(E); this.enlarge(X.ENLARGE_BLOCK_CONTENTS); c[0].appendChild(this.extractContents()); c._4e_trim(); F.ie || c._4e_appendBogus(); for (var e = c[0].childNodes, a = 0; a < e.length; a++) { var b = e[a]; b.nodeType == 8 && this.insertNode(new M(b)) } this.insertNode(c); this.moveToBookmark(d); return c }, splitBlock: function (E) { var D = new S(this.startContainer), c = new S(this.endContainer), b = D.block, d = c.block, a = Y; if (!D.blockLimit._4e_equals(c.blockLimit)) { return Y } if (E != "br") { if (!b) { b = this.fixBlock(Q, E); d = (new S(this.endContainer)).block } d || (d = this.fixBlock(V, E)) } E = b && this.checkStartOfBlock(); D = d && this.checkEndOfBlock(); this.deleteContents(); if (b && k._4e_equals(b, d)) { if (D) { a = new S(this.startContainer); this.moveToPosition(d, X.POSITION_AFTER_END); d = Y } else { if (E) { a = new S(this.startContainer); this.moveToPosition(b, X.POSITION_BEFORE_START); b = Y } else { d = this.splitElement(b); !F.ie && !z.inArray(b._4e_name(), ["ul", "ol"]) && b._4e_appendBogus() } } } return { previousBlock: b, nextBlock: d, wasStartOfBlock: E, wasEndOfBlock: D, elementPath: a} }, splitElement: function (E) { if (!this.collapsed) { return Y } this.setEndAt(E, X.POSITION_BEFORE_END); var D = this.extractContents(), a = E._4e_clone(V); a[0].appendChild(D); a.insertAfter(E); this.moveToPosition(E, X.POSITION_AFTER_END); return a }, moveToElementEditablePosition: function (E, D) { var b, a = R.XHTML_DTD; if (a.$empty[E._4e_name()]) { return V } for (; E && E[0].nodeType == Z.NODE_ELEMENT; ) { if (b = E._4e_isEditable()) { this.moveToPosition(E, D ? X.POSITION_BEFORE_END : X.POSITION_AFTER_START) } else { if (a.$inline[E._4e_name()]) { this.moveToPosition(E, D ? X.POSITION_AFTER_END : X.POSITION_BEFORE_START); return Q } } if ((E = a.$empty[E._4e_name()] ? E[D ? "_4e_previous" : "_4e_next"](G) : E[D ? "_4e_last" : "_4e_first"](G)) && E[0].nodeType == Z.NODE_TEXT) { this.moveToPosition(E, D ? X.POSITION_AFTER_END : X.POSITION_BEFORE_START); return Q } } return b }, selectNodeContents: function (D) { this.setStart(D, 0); this.setEnd(D, D[0].nodeType == Z.NODE_TEXT ? D[0].nodeValue.length : D[0].childNodes.length) } }); var B = { abbr: 1, acronym: 1, b: 1, bdo: 1, big: 1, cite: 1, code: 1, del: 1, dfn: 1, em: 1, font: 1, i: 1, ins: 1, label: 1, kbd: 1, q: 1, samp: 1, small: 1, span: 1, strike: 1, strong: 1, sub: 1, sup: 1, tt: 1, u: 1, "var": 1 }, A = new U.whitespaces, H = new U.bookmark; R.Range = N; R.Range = N; var J = N.prototype; R.Utils.extern(J, { updateCollapsed: J.updateCollapsed, optimize: J.optimize, setStartAfter: J.setStartAfter, setEndAfter: J.setEndAfter, setStartBefore: J.setStartBefore, setEndBefore: J.setEndBefore, optimizeBookmark: J.optimizeBookmark, setStart: J.setStart, setEnd: J.setEnd, setStartAt: J.setStartAt, setEndAt: J.setEndAt, execContentsAction: J.execContentsAction, collapse: J.collapse, clone: J.clone, getEnclosedNode: J.getEnclosedNode, shrink: J.shrink, getTouchedStartNode: J.getTouchedStartNode, createBookmark2: J.createBookmark2, createBookmark: J.createBookmark, moveToPosition: J.moveToPosition, trim: J.trim, insertNode: J.insertNode, moveToBookmark: J.moveToBookmark, getCommonAncestor: J.getCommonAncestor, enlarge: J.enlarge, checkStartOfBlock: J.checkStartOfBlock, checkEndOfBlock: J.checkEndOfBlock, deleteContents: J.deleteContents, extractContents: J.extractContents, checkBoundaryOfElement: J.checkBoundaryOfElement, getBoundaryNodes: J.getBoundaryNodes, fixBlock: J.fixBlock, splitBlock: J.splitBlock, splitElement: J.splitElement, moveToElementEditablePosition: J.moveToElementEditablePosition, selectNodeContents: J.selectNodeContents }) }); KISSY.Editor.add("domiterator", function (E) { function B(O) { if (!(arguments.length < 1)) { this.range = O; this.forceBrBreak = L; this.enlargeBr = M; this.enforceRealBlocks = L; this._ || (this._ = {}) } } var M = true, L = false, N = KISSY, K = N.UA, C = E.Walker, D = E.Range, F = E.RANGE, H = E.NODE, J = E.ElementPath, I = N.Node, G = N.DOM, A = /^[\r\n\t ]*$/; N.augment(B, { getNextParagraph: function (T) { var W, U, Y, S, R; if (!this._.lastNode) { U = this.range.clone(); U.shrink(F.SHRINK_ELEMENT, M); U.enlarge(this.forceBrBreak || !this.enlargeBr ? F.ENLARGE_LIST_ITEM_CONTENTS : F.ENLARGE_BLOCK_CONTENTS); var P = new C(U), Q = C.bookmark(M, M); P.evaluator = Q; this._.nextNode = P.next(); P = new C(U); P.evaluator = Q; P = P.previous(); this._.lastNode = P._4e_nextSourceNode(M); if (this._.lastNode && this._.lastNode[0].nodeType == H.NODE_TEXT && !N.trim(this._.lastNode[0].nodeValue) && this._.lastNode.parent()._4e_isBlockBoundary()) { Q = new D(U.document); Q.moveToPosition(this._.lastNode, F.POSITION_AFTER_END); if (Q.checkEndOfBlock()) { Q = new J(Q.endContainer); this._.lastNode = (Q.block || Q.blockLimit)._4e_nextSourceNode(M) } } if (!this._.lastNode) { this._.lastNode = this._.docEndMarker = new I(U.document.createTextNode("")); G.insertAfter(this._.lastNode[0], P[0]) } U = null } Q = this._.nextNode; P = this._.lastNode; for (this._.nextNode = null; Q; ) { var X = L, V = Q[0].nodeType != H.NODE_ELEMENT, Z = L; if (V) { if (Q[0].nodeType == H.NODE_TEXT) { if (A.test(Q[0].nodeValue)) { V = L } } } else { var O = Q._4e_name(); if (Q._4e_isBlockBoundary(this.forceBrBreak && { br: 1 })) { if (O == "br") { V = M } else { if (!U && !Q[0].childNodes.length && O != "hr") { W = Q; Y = Q._4e_equals(P); break } } if (U) { U.setEndAt(Q, F.POSITION_BEFORE_START); if (O != "br") { this._.nextNode = Q } } X = M } else { if (Q[0].firstChild) { if (!U) { U = new D(this.range.document); U.setStartAt(Q, F.POSITION_BEFORE_START) } Q = new I(Q[0].firstChild); continue } V = M } } if (V && !U) { U = new D(this.range.document); U.setStartAt(Q, F.POSITION_BEFORE_START) } Y = (!X || V) && Q._4e_equals(P); if (U && !X) { for (; !Q[0].nextSibling && !Y; ) { O = Q.parent(); if (O._4e_isBlockBoundary(this.forceBrBreak && { br: 1 })) { X = M; Y || O._4e_equals(P); break } Q = O; V = M; Y = Q._4e_equals(P); Z = M } } V && U.setEndAt(Q, F.POSITION_AFTER_END); Q = Q._4e_nextSourceNode(Z, null, P); if ((Y = !Q) || X && U) { break } } if (!W) { if (!U) { this._.docEndMarker && this._.docEndMarker._4e_remove(); return this._.nextNode = null } W = new J(U.startContainer); Q = W.blockLimit; X = { div: 1, th: 1, td: 1 }; W = W.block; if ((!W || !W[0]) && !this.enforceRealBlocks && X[Q._4e_name()] && U.checkStartOfBlock() && U.checkEndOfBlock()) { W = Q } else { if (!W || this.enforceRealBlocks && W._4e_name() == "li") { W = new I(this.range.document.createElement(T || "p")); W[0].appendChild(U.extractContents()); W._4e_trim(); U.insertNode(W); S = R = M } else { if (W._4e_name() != "li") { if (!U.checkStartOfBlock() || !U.checkEndOfBlock()) { W = W._4e_clone(L); W[0].appendChild(U.extractContents()); W._4e_trim(); R = U.splitBlock(); S = !R.wasStartOfBlock; R = !R.wasEndOfBlock; U.insertNode(W) } } else { if (!Y) { this._.nextNode = W._4e_equals(P) ? null : U.getBoundaryNodes().endNode._4e_nextSourceNode(M, null, P) } } } } } if (S) { U = new I(W[0].previousSibling); if (U[0] && U[0].nodeType == H.NODE_ELEMENT) { if (U._4e_name() == "br") { U._4e_remove() } else { U[0].lastChild && G._4e_name(U[0].lastChild) == "br" && G._4e_remove(U[0].lastChild) } } } if (R) { U = C.bookmark(L, M); S = new I(W[0].lastChild); if (S[0] && S[0].nodeType == H.NODE_ELEMENT && S._4e_name() == "br") { if (K.ie || S._4e_previous(U) || S._4e_next(U)) { S._4e_remove() } } } if (!this._.nextNode) { this._.nextNode = Y || W._4e_equals(P) ? null : W._4e_nextSourceNode(M, null, P) } return W } }); D.prototype.createIterator = function () { return new B(this) } }); KISSY.Editor.add("selection", function (L) { function H(W) { this.document = this.document = W; this._ = { cache: {} }; if (U) { var X = this.getNative().createRange(); if (!X || X.item && X.item(0).ownerDocument != W || X.parentElement && X.parentElement().ownerDocument != W) { this.isInvalid = E } } } function D(W) { W = new H(W); return !W || W.isInvalid ? I : W } function C(g) { var f = g.document, i = new T(f.body), W = new T(f.documentElement); if (P.ie) { P.ieEngine < 8 && W.on("click", function (j) { (new T(j.target))._4e_name() === "html" && g.getSelection().getNative().createRange().select() }); var a, Z, e = 1; W.on("mousedown", function () { e = 0 }); W.on("mouseup", function () { e = 1 }); i.on("focusin", function (j) { if ((new T(j.target))._4e_name() == "body") { if (a) { try { e && a.select() } catch (k) { } a = I } } }); i.on("focus", function () { Z = E; Y() }); i.on("beforedeactivate", function (j) { if (!j.relatedTarget) { X(); e = 1 } }); g.on("blur", function () { try { var j = document.documentElement || document.body, m = j.scrollTop, l = j.scrollLeft; f && f.selection.empty(); j.scrollTop = m; j.scrollLeft = l } catch (k) { } }); i.on("mousedown", function () { X() }); i.on("mouseup", function () { Z = E; setTimeout(function () { Y(E) }, 0) }); var X = function () { Z = A }, Y = function (k) { if (Z) { var n = g.document, m = g.getSelection(), l = m && m.getType(), o = m && n.selection; if (k && o && l == R.SELECTION_NONE) { if (!n.queryCommandEnabled("InsertImage")) { setTimeout(function () { Y(E) }, 50); return } } var j; if (!(o && o.type && o.type != "Control" && (j = o.createRange()) && (j = j.parentElement()) && (j = j.nodeName) && j.toLowerCase() in { input: 1, textarea: 1 })) { a = o && m.getRanges()[0]; g._monitor() } } }; i.on("keydown", X); i.on("keyup", function () { Z = E; Y() }); V.on(f, "selectionchange", Y) } else { V.on(f, "mouseup", g._monitor, g); V.on(f, "keyup", g._monitor, g) } var h = { table: 1, pre: 1 }, d = /\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi, c = L.Walker.whitespaces(E), b = function (j) { return c(j) && j && j[0].nodeType != 8 }; g.on("selectionChange", function (j) { var l = j.path; j = (j = j.selection) && j.getRanges()[0]; if (!(!j || !j.collapsed || l.block)) { if (l.blockLimit._4e_name() == "body") { if (l = j.fixBlock(E, "p")) { if (l._4e_outerHtml().match(d)) { var k = l._4e_next(b); if (k && k[0].nodeType == O.NODE_ELEMENT && !h[k._4e_name()]) { j.moveToElementEditablePosition(k); l._4e_remove() } else { if ((k = l._4e_previous(b)) && k[0].nodeType == O.NODE_ELEMENT && !h[k._4e_name()]) { j.moveToElementEditablePosition(k, k._4e_outerHtml().match(d) ? A : E); l._4e_remove() } } } j.select(); U || g.notifySelectionChange() } } } }) } L.SELECTION = { SELECTION_NONE: 1, SELECTION_TEXT: 2, SELECTION_ELEMENT: 3 }; var E = true, A = false, I = null, K = KISSY, P = K.UA, S = K.DOM, V = K.Event, T = K.Node, R = L.SELECTION, F = L.RANGE, O = L.NODE, U = !window.getSelection, Q = L.Walker, B = L.Range, N = { img: 1, hr: 1, li: 1, table: 1, tr: 1, td: 1, th: 1, embed: 1, object: 1, ol: 1, ul: 1, a: 1, input: 1, form: 1, select: 1, textarea: 1, button: 1, fieldset: 1, thead: 1, tfoot: 1 }; K.augment(H, { getNative: !U ? function () { var W = this._.cache; return W.nativeSel || (W.nativeSel = S._4e_getWin(this.document).getSelection()) } : function () { var W = this._.cache; return W.nativeSel || (W.nativeSel = this.document.selection) }, getType: !U ? function () { var W = this._.cache; if (W.type) { return W.type } var Z = R.SELECTION_TEXT, X = this.getNative(); if (X) { if (X.rangeCount == 1) { X = X.getRangeAt(0); var Y = X.startContainer; if (Y == X.endContainer && Y.nodeType == O.NODE_ELEMENT && Number(X.endOffset - X.startOffset) == 1 && N[Y.childNodes[X.startOffset].nodeName.toLowerCase()]) { Z = R.SELECTION_ELEMENT } } } else { Z = R.SELECTION_NONE } return W.type = Z } : function () { var W = this._.cache; if (W.type) { return W.type } var a = R.SELECTION_NONE; try { var Y = this.getNative(), Z = Y.type; if (Z == "Text") { a = R.SELECTION_TEXT } if (Z == "Control") { a = R.SELECTION_ELEMENT } if (Y.createRange().parentElement) { a = R.SELECTION_TEXT } } catch (X) { } return W.type = a }, getRanges: U ? function () { var W = function (d, f) { d = d.duplicate(); d.collapse(f); for (var X = d.parentElement(), b = X.childNodes, a, c = 0; c < b.length; c++) { var Y = b[c]; if (Y.nodeType == O.NODE_ELEMENT) { a = d.duplicate(); a.moveToElementText(Y); Y = a.compareEndPoints("StartToStart", d); var Z = a.compareEndPoints("EndToStart", d); a.collapse(); if (Y > 0) { break } else { if (!Y || Z == 1 && Y == -1) { return { container: X, offset: c} } else { if (!Z) { return { container: X, offset: c + 1} } } } a = I } } if (!a) { a = d.duplicate(); a.moveToElementText(X); a.collapse(A) } a.setEndPoint("StartToStart", d); a = String(a.text).replace(/\r\n|\r/g, "\n").length; try { for (; a > 0; ) { a -= b[--c].nodeValue.length } } catch (e) { a = 0 } return a === 0 ? { container: X, offset: c} : { container: b[c], offset: -a} }; return function (d) { var Z = this._.cache; if (Z.ranges && !d) { return Z.ranges } var a = this.getNative(); d = a && a.createRange(); var Y = this.getType(); if (!a) { return [] } if (Y == R.SELECTION_TEXT) { a = new B(this.document); Y = W(d, E); a.setStart(new T(Y.container), Y.offset); Y = W(d); a.setEnd(new T(Y.container), Y.offset); return Z.ranges = [a] } else { if (Y == R.SELECTION_ELEMENT) { Z = Z.ranges = []; for (Y = 0; Y < d.length; Y++) { var X = d.item(Y), c = X.parentNode, b = 0; for (a = new B(this.document); b < c.childNodes.length && c.childNodes[b] != X; b++) { } a.setStart(new T(c), b); a.setEnd(new T(c), b + 1); Z.push(a) } return Z } } return Z.ranges = [] } } () : function (X) { var b = this._.cache; if (b.ranges && !X) { return b.ranges } X = []; var Z = this.getNative(); if (!Z) { return [] } for (var a = 0; a < Z.rangeCount; a++) { var Y = Z.getRangeAt(a), W = new B(this.document); W.setStart(new T(Y.startContainer), Y.startOffset); W.setEnd(new T(Y.endContainer), Y.endOffset); X.push(W) } return b.ranges = X }, getStartElement: function () { var W = this._.cache; if (W.startElement !== undefined) { return W.startElement } var Z, X = this.getNative(); switch (this.getType()) { case R.SELECTION_ELEMENT: return this.getSelectedElement(); case R.SELECTION_TEXT: var Y = this.getRanges()[0]; if (Y) { if (!Y.collapsed) { for (Y.optimize(); E; ) { Z = Y.startContainer; if (Y.startOffset == (Z[0].nodeType === O.NODE_ELEMENT ? Z[0].childNodes.length : Z[0].nodeValue.length) && !Z._4e_isBlockBoundary()) { Y.setStartAfter(Z) } else { break } } Z = Y.startContainer; if (Z[0].nodeType != O.NODE_ELEMENT) { return Z.parent() } Z = new T(Z[0].childNodes[Y.startOffset]); if (!Z[0] || Z[0].nodeType != O.NODE_ELEMENT) { return Y.startContainer } for (Y = Z[0].firstChild; Y && Y.nodeType == O.NODE_ELEMENT; ) { Z = new T(Y); Y = Y.firstChild } return Z } } if (U) { Y = X.createRange(); Y.collapse(E); Z = Y.parentElement() } else { if ((Z = X.anchorNode) && Z.nodeType != O.NODE_ELEMENT) { Z = Z.parentNode } } } return W.startElement = Z ? S._4e_wrap(Z) : I }, getSelectedElement: function () { var W = this, Y, X = W._.cache; if (X.selectedElement !== undefined) { return X.selectedElement } if (U) { Y = W.getNative().createRange(); Y = Y.item && Y.item(0) } Y || (Y = function () { for (var b = W.getRanges()[0], a, Z, c = 2; c && !((a = b.getEnclosedNode()) && a[0].nodeType == O.NODE_ELEMENT && N[a._4e_name()] && (Z = a)); c--) { b.shrink(F.SHRINK_ELEMENT) } return Z && Z[0] } ()); return X.selectedElement = S._4e_wrap(Y) }, reset: function () { this._.cache = {} }, selectElement: function (W) { var Z, X = this.document; if (U) { try { Z = X.body.createControlRange(); Z.addElement(W[0]); Z.select() } catch (Y) { Z = X.body.createTextRange(); Z.moveToElementText(W[0]); Z.select() } finally { } } else { Z = X.createRange(); Z.selectNode(W[0]); W = this.getNative(); W.removeAllRanges(); W.addRange(Z) } this.reset() }, selectRanges: function (X) { if (U) { if (X.length > 1) { var b = X[X.length - 1]; X[0].setEnd(b.endContainer, b.endOffset); X.length = 1 } X[0] && X[0].select() } else { b = this.getNative(); if (!b) { return } b.removeAllRanges(); for (var Z = 0; Z < X.length; Z++) { var a = X[Z], Y = this.document.createRange(), W = a.startContainer; a.collapsed && P.gecko && P.gecko < 1.09 && W[0].nodeType == O.NODE_ELEMENT && !W[0].childNodes.length && W[0].appendChild(this.document.createTextNode("")); Y.setStart(W[0], a.startOffset); Y.setEnd(a.endContainer[0], a.endOffset); b.addRange(Y) } } this.reset() }, createBookmarks2: function (W) { for (var Z = [], X = this.getRanges(), Y = 0; Y < X.length; Y++) { Z.push(X[Y].createBookmark2(W)) } return Z }, createBookmarks: function (f, e) { var h = [], W = this.document, a; e = e || this.getRanges(); for (var Z = e.length, d = 0; d < Z; d++) { h.push(a = e[d].createBookmark(f, E)); var X = (f = a.serializable) ? K.one("#" + a.startNode, W) : a.startNode; a = f ? K.one("#" + a.endNode, W) : a.endNode; for (var Y = d + 1; Y < Z; Y++) { var g = e[Y], c = g.startContainer, b = g.endContainer; S._4e_equals(c, X.parent()) && g.startOffset++; S._4e_equals(c, a.parent()) && g.startOffset++; S._4e_equals(b, X.parent()) && g.endOffset++; S._4e_equals(b, a.parent()) && g.endOffset++ } } return h }, selectBookmarks: function (W) { for (var Z = [], X = 0; X < W.length; X++) { var Y = new B(this.document); Y.moveToBookmark(W[X]); Z.push(Y) } this.selectRanges(Z); return this }, getCommonAncestor: function () { var W = this.getRanges(); return W[0].startContainer._4e_commonAncestor(W[W.length - 1].endContainer) }, scrollIntoView: function () { var W = this.getStartElement(); W && W._4e_scrollIntoView() }, removeAllRanges: function () { var W = this.getNative(); if (U) { W && W.clear() } else { W && W.removeAllRanges() } } }); var M = { table: 1, tbody: 1, tr: 1 }, G = Q.whitespaces(E), J = /\ufeff|\u00a0/; B.prototype.select = B.prototype.select = !U ? function () { var W = this.startContainer; this.collapsed && W[0].nodeType == O.NODE_ELEMENT && !W[0].childNodes.length && W[0].appendChild(this.document.createTextNode("")); var Y = this.document.createRange(); Y.setStart(W[0], this.startOffset); try { Y.setEnd(this.endContainer[0], this.endOffset) } catch (X) { if (X.toString().indexOf("NS_ERROR_ILLEGAL_VALUE") >= 0) { this.collapse(E); Y.setEnd(this.endContainer[0], this.endOffset) } else { throw X } } W = D(this.document).getNative(); W.removeAllRanges(); W.addRange(Y) } : function (X) { var c = this.collapsed, Z, a; if (this.startContainer[0] === this.endContainer[0] && this.endOffset - this.startOffset == 1) { var Y = this.startContainer[0].childNodes[this.startOffset]; if (Y.nodeType == O.NODE_ELEMENT) { (new H(this.document)).selectElement(new T(Y)); return } } if (this.startContainer[0].nodeType == O.NODE_ELEMENT && this.startContainer._4e_name() in M || this.endContainer[0].nodeType == O.NODE_ELEMENT && this.endContainer._4e_name() in M) { this.shrink(F.SHRINK_ELEMENT, E) } var W = this.createBookmark(); Y = W.startNode; var b; if (!c) { b = W.endNode } W = this.document.body.createTextRange(); W.moveToElementText(Y[0]); W.moveStart("character", 1); if (b) { X = this.document.body.createTextRange(); X.moveToElementText(b[0]); W.setEndPoint("EndToEnd", X); W.moveEnd("character", -1) } else { for (Z = Y[0].nextSibling; Z && !G(Z); ) { Z = Z.nextSibling } Z = !(Z && Z.nodeValue && Z.nodeValue.match(J)) && (X || !Y[0].previousSibling || Y[0].previousSibling && S._4e_name(Y[0].previousSibling) == "br"); a = new T(this.document.createElement("span")); a.html("&#65279;"); a.insertBefore(Y); if (Z) { S.insertBefore(this.document.createTextNode("\ufeff"), Y[0] || Y) } } this.setStartBefore(Y); Y._4e_remove(); if (c) { if (Z) { W.moveStart("character", -1); W.select(); this.document.selection.clear() } else { W.select() } if (a) { this.moveToPosition(a, F.POSITION_BEFORE_START); a._4e_remove() } } else { this.setEndBefore(b); b._4e_remove(); W.select() } }; H.getSelection = D; L.Selection = H; L.Selection = H; Q = H.prototype; L.Utils.extern(Q, { getNative: Q.getNative, getType: Q.getType, getRanges: Q.getRanges, getStartElement: Q.getStartElement, getSelectedElement: Q.getSelectedElement, reset: Q.reset, selectElement: Q.selectElement, selectRanges: Q.selectRanges, createBookmarks2: Q.createBookmarks2, createBookmarks: Q.createBookmarks, getCommonAncestor: Q.getCommonAncestor, scrollIntoView: Q.scrollIntoView, selectBookmarks: Q.selectBookmarks, removeAllRanges: Q.removeAllRanges }); L.on("instanceCreated", function (W) { C(W.editor) }) }); KISSY.Editor.add("styles", function (AS) { function AO(A) { return !A.attr("_ke_bookmark") } function AK(B, A) { for (var C in B) { if (B.hasOwnProperty(C)) { if (Z.isString(B[C])) { B[C] = B[C].replace(G, function (D, E) { return A[E] }) } else { AK(B[C], A) } } } } function AJ(B, A) { if (A) { B = Z.clone(B); AK(B, A) } var C = this.element = this.element = (B.element || "*").toLowerCase(); this.type = this.type = C == "#" || L[C] ? AD.STYLE_BLOCK : J[C] ? AD.STYLE_OBJECT : AD.STYLE_INLINE; this._ = { definition: B} } function AL(D, A) { var E = A ? this.removeFromRange : this.applyToRange; D.body.focus(); for (var B = new AB(D), C = B.getRanges(), F = 0; F < C.length; F++) { E.call(this, C[F]) } B.selectRanges(C) } function AH(C, A, D) { var B = C.element; if (B == "*") { B = "span" } A = new O(A.createElement(B)); D && D._4e_copyAttributes(A); return AP(A, C) } function AP(D, A) { var E = A._.definition, B = E.attributes; E = AJ.getStyleText(E); if (B) { for (var C in B) { D.attr(C, B[C]) } } if (E) { D[0].style.cssText = E } return D } function AR(N) { var E = N.createBookmark(AQ), P = N.createIterator(); P.enforceRealBlocks = AQ; P.enlargeBr = AQ; for (var F, K = N.document; F = P.getNextParagraph(); ) { var C = AH(this, K, F); F = F; var D = C; C = D._4e_name == "pre"; var B = F._4e_name == "pre", A = !C && B; if (C && !B) { B = F; D = D; A = B.html(); A = AX(A, /(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g, ""); A = A.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi, "$1"); A = A.replace(/([ \t\n\r]+|&nbsp;)/g, " "); A = A.replace(/<br\b[^>]*>/gi, "\n"); if (M.ie) { B = B[0].ownerDocument.createElement("div"); B.appendChild(D[0]); D[0].outerHTML = "<pre>" + A + "</pre>"; D = new O(B.firstChild); D._4e_remove() } else { D.html(A) } D = D } else { if (A) { D = Ad(Aa(F), D) } else { F._4e_moveChildren(D) } } F[0].parentNode.replaceChild(D[0], F[0]); if (C) { F = D; C = void 0; if ((C = F._4e_previousSourceNode(AQ, AC.NODE_ELEMENT)) && C._4e_name() == "pre") { D = AX(C.html(), /\n$/, "") + "\n\n" + AX(F.html(), /^\n/, ""); if (M.ie) { F[0].outerHTML = "<pre>" + D + "</pre>" } else { F.html(D) } C._4e_remove() } } } N.moveToBookmark(E) } function AX(D, A, E) { var B = "", C = ""; D = D.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi, function (K, N, F) { N && (B = N); F && (C = F); return "" }); return B + D.replace(A, E) + C } function Aa(B) { var A = []; AX(B._4e_outerHtml(), /(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi, function (E, C, D) { return C + "</pre>" + D + "<pre>" }).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi, function (D, C) { A.push(C) }); return A } function Ad(D, A) { for (var E = A[0].ownerDocument.createDocumentFragment(), B = 0; B < D.length; B++) { var C = D[B]; C = C.replace(/(\r\n|\r)/g, "\n"); C = AX(C, /^[ \t]*\n/, ""); C = AX(C, /\n$/, ""); C = AX(C, /^[ \t]+|[ \t]+$/g, function (N, K) { return N.length == 1 ? "&nbsp;" : K ? " " + Array(N.length).join("&nbsp;") : Array(N.length).join("&nbsp;") + " " }); C = C.replace(/\n/g, "<br>"); C = C.replace(/[ \t]{2,}/g, function (K) { return Array(K.length).join("&nbsp;") + " " }); var F = A._4e_clone(); F.html(C); E.appendChild(F[0]) } return E } function Ab(T) { var Q = T.document; if (T.collapsed) { Q = AH(this, Q, undefined); T.insertNode(Q); T.moveToPosition(Q, AE.POSITION_BEFORE_END) } else { var W = this.element, R = this._.definition, S, N = AS.XHTML_DTD[W] || (S = AQ, AS.XHTML_DTD.span), P = T.createBookmark(); T.enlarge(AE.ENLARGE_ELEMENT); T.trim(); var D = T.createBookmark(), C = D.startNode; D = D.endNode; for (var A = C, b; A && A[0]; ) { var B = AG; if (AT._4e_equals(A, D)) { A = AF; B = AQ } else { var E = A[0].nodeType, X = E == AC.NODE_ELEMENT ? A._4e_name() : AF; if (X && A.attr("_ke_bookmark")) { A = A._4e_nextSourceNode(AQ); continue } if (!X || N[X] && (A._4e_position(D) | Y.POSITION_PRECEDING | Y.POSITION_IDENTICAL | Y.POSITION_IS_CONTAINED) == Y.POSITION_PRECEDING + Y.POSITION_IDENTICAL + Y.POSITION_IS_CONTAINED && (!R.childRule || R.childRule(A))) { var K = A.parent(); if (K && K[0] && ((AS.XHTML_DTD[K._4e_name()] || AS.XHTML_DTD.span)[W] || S) && (!R.parentRule || R.parentRule(K))) { if (!b && (!X || !AS.XHTML_DTD.$removeEmpty[X] || (A._4e_position(D) | Y.POSITION_PRECEDING | Y.POSITION_IDENTICAL | Y.POSITION_IS_CONTAINED) == Y.POSITION_PRECEDING + Y.POSITION_IDENTICAL + Y.POSITION_IS_CONTAINED)) { b = new U(Q); b.setStartBefore(A) } if (E == AC.NODE_TEXT || E == AC.NODE_ELEMENT && !A[0].childNodes.length) { E = A; for (var c; (B = !E._4e_next(AO)) && (c = E.parent(), N[c._4e_name()]) && (c._4e_position(C) | Y.POSITION_FOLLOWING | Y.POSITION_IDENTICAL | Y.POSITION_IS_CONTAINED) == Y.POSITION_FOLLOWING + Y.POSITION_IDENTICAL + Y.POSITION_IS_CONTAINED && (!R.childRule || R.childRule(c)); ) { E = c } b.setEndAfter(E) } } else { B = AQ } } else { B = AQ } A = A._4e_nextSourceNode() } if (B && b && !b.collapsed) { B = AH(this, Q, undefined); E = b.getCommonAncestor(); X = { styles: {}, attrs: {}, blockedStyles: {}, blockedAttrs: {} }; for (var F, a, d; B && E && B[0] && E[0]; ) { if (E._4e_name() == W) { for (F in R.attributes) { if (!(X.blockedAttrs[F] || !(d = E.attr(a)))) { if (B.attr(F) == d) { B.removeAttr(F) } else { X.blockedAttrs[F] = 1 } } } for (a in R.styles) { if (!(X.blockedStyles[a] || !(d = E._4e_style(a)))) { if (B._4e_style(a) == d) { B._4e_style(a, "") } else { X.blockedStyles[a] = 1 } } } if (!B._4e_hasAttributes()) { B = AF; break } } E = E.parent() } if (B) { B[0].appendChild(b.extractContents()); AV(this, B); b.insertNode(B); B._4e_mergeSiblings(); M.ie || B[0].normalize() } else { B = new O(Q.createElement("span")); B[0].appendChild(b.extractContents()); b.insertNode(B); AV(this, B); B._4e_remove(true) } b = AF } } C._4e_remove(); D._4e_remove(); T.moveToBookmark(P); T.shrink(AE.SHRINK_TEXT) } } function AZ(Q) { Q.enlarge(AE.ENLARGE_ELEMENT); var K = Q.createBookmark(), R = K.startNode; if (Q.collapsed) { for (var N = new V(R.parent()), P, E = 0, F; E < N.elements.length && (F = N.elements[E]); E++) { if (F == N.block || F == N.blockLimit) { break } if (this.checkElementRemovable(F)) { var D = Q.checkBoundaryOfElement(F, AE.END), C = !D && Q.checkBoundaryOfElement(F, AE.START); if (C || D) { P = F; P.match = C ? "start" : "end" } else { F._4e_mergeSiblings(); if (F._4e_name() != this.element) { D = Ac(this); AU(F, D[F._4e_name()] || D["*"]) } else { AY(this, F) } } } } if (P && P[0]) { F = R; for (E = 0; ; E++) { D = N.elements[E]; if (AT._4e_equals(D, P)) { break } else { if (D.match) { continue } else { D = D._4e_clone() } } D[0].appendChild(F[0]); F = D } AT[P.match == "start" ? "insertBefore" : "insertAfter"](AT._4e_unwrap(F), AT._4e_unwrap(P)) } } else { var B = K.endNode, A = this; N = function () { for (var a = new V(R.parent()), X = new V(B.parent()), S = AF, W = AF, T = 0; T < a.elements.length; T++) { var b = a.elements[T]; if (b == a.block || b == a.blockLimit) { break } if (A.checkElementRemovable(b)) { S = b } } for (T = 0; T < X.elements.length; T++) { b = X.elements[T]; if (b == X.block || b == X.blockLimit) { break } if (A.checkElementRemovable(b)) { W = b } } W && B._4e_breakParent(W); S && R._4e_breakParent(S) }; N(); for (P = new O(R[0].nextSibling); P[0] !== B[0]; ) { E = P._4e_nextSourceNode(); if (P[0] && P[0].nodeType == AC.NODE_ELEMENT && this.checkElementRemovable(P)) { if (P._4e_name() == this.element) { AY(this, P) } else { F = Ac(this); AU(P, F[P._4e_name()] || F["*"]) } if (E[0].nodeType == AC.NODE_ELEMENT && E.contains(R)) { N(); E = new O(R[0].nextSibling) } } P = E } } Q.moveToBookmark(K) } function AM(B) { B = String(B); var A = {}; B.replace(/&quot;/g, '"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g, function (E, C, D) { A[C] = D }); return A } function AW(B, A) { var C = ""; if (A !== AG) { C = document.createElement("span"); C.style.cssText = B; C = C.style.cssText || "" } else { C = B } return C.replace(/\s*([;:])\s*/, "$1").replace(/([^\s;])$/, "$1;").replace(/,\s+/g, ",").toLowerCase() } function Ac(P) { if (P._.overrides) { return P._.overrides } var F = P._.overrides = {}, Q = P._.definition.overrides; if (Q) { Z.isArray(Q) || (Q = [Q]); for (var K = 0; K < Q.length; K++) { var N = Q[K], D, E, C; if (typeof N == "string") { D = N.toLowerCase() } else { D = N.element ? N.element.toLowerCase() : P.element; E = N.attributes; C = N.styles } N = F[D] || (F[D] = {}); if (E) { D = N.attributes = N.attributes || []; for (var B in E) { E.hasOwnProperty(B) && D.push([B.toLowerCase(), E[B]]) } } if (C) { N = N.styles = N.styles || []; for (var A in C) { C.hasOwnProperty(A) && N.push([A.toLowerCase(), C[A]]) } } } } return F } function AY(D, A) { var E = D._.definition, B = Ac(D), C = AA.mix(E.attributes, (B[A._4e_name()] || B["*"] || {}).attributes); E = AA.mix(E.styles, (B[A._4e_name()] || B["*"] || {}).styles); B = Z.isEmptyObject(C) && Z.isEmptyObject(E); for (var F in C) { if (C.hasOwnProperty(F)) { if (!((F == "class" || D._.definition.fullMatch) && A.attr(F) != AI(F, C[F]))) { B = B || !!A._4e_hasAttribute(F); A.removeAttr(F) } } } for (var K in E) { if (E.hasOwnProperty(K)) { if (!(D._.definition.fullMatch && A._4e_style(K) != AI(K, E[K], AQ))) { B = B || !!A._4e_style(K); A._4e_style(K, "") } } } AN(A) } function AI(C, A, D) { var B = new O("<span>"); B[D ? "_4e_style" : "attr"](C, A); return B[D ? "_4e_style" : "attr"](C) } function AV(D, A) { for (var E = Ac(D), B = A.all(D.element), C = B.length; --C >= 0; ) { AY(D, new O(B[C])) } for (var F in E) { if (F != D.element) { B = A.all(F); for (C = B.length - 1; C >= 0; C--) { var K = new O(B[C]); AU(K, E[F]) } } } } function AU(E, A) { var F, C = A && A.attributes; if (C) { for (F = 0; F < C.length; F++) { var D = C[F][0], K; if (K = E.attr(D)) { var N = C[F][1]; if (N === AF || N.test && N.test(K) || typeof N == "string" && K == N) { E[0].removeAttribute(D) } } } } if (C = A && A.styles) { for (F = 0; F < C.length; F++) { D = C[F][0]; if (N = E.css(D)) { var B = C[F][1]; if (B === AF || B.test && B.test(K) || typeof B == "string" && N == B) { E.css(D, "") } } } } AN(E) } function AN(B) { if (!B._4e_hasAttributes()) { var A = B[0].firstChild, C = B[0].lastChild; B._4e_remove(AQ); if (A) { A.nodeType == AC.NODE_ELEMENT && AT._4e_mergeSiblings(A); C && A != C && C.nodeType == AC.NODE_ELEMENT && AT._4e_mergeSiblings(C) } } } var AQ = true, AG = false, AF = null, Z = KISSY, AA = AS.Utils, AT = Z.DOM, AD = { STYLE_BLOCK: 1, STYLE_INLINE: 2, STYLE_OBJECT: 3 }, AE = AS.RANGE, AB = AS.Selection, AC = AS.NODE, Y = AS.POSITION, U = AS.Range, O = Z.Node, M = Z.UA, V = AS.ElementPath, L = { address: 1, div: 1, h1: 1, h2: 1, h3: 1, h4: 1, h5: 1, h6: 1, p: 1, pre: 1 }, J = { embed: 1, hr: 1, img: 1, li: 1, object: 1, ol: 1, table: 1, td: 1, tr: 1, th: 1, ul: 1, dl: 1, dt: 1, dd: 1, form: 1 }, I = /\s*(?:;\s*|$)/g, G = /#\((.+?)\)/g; AS.STYLE = AD; AJ.prototype = { apply: function (A) { AL.call(this, A, AG) }, remove: function (A) { AL.call(this, A, AQ) }, applyToRange: function (A) { return (this.applyToRange = this.type == AD.STYLE_INLINE ? Ab : this.type == AD.STYLE_BLOCK ? AR : this.type == AD.STYLE_OBJECT ? AF : AF).call(this, A) }, removeFromRange: function (A) { return (this.removeFromRange = this.type == AD.STYLE_INLINE ? AZ : AF).call(this, A) }, applyToObject: function (A) { AP(A, this) }, checkElementRemovable: function (N, E) { if (!N) { return AG } var P = this._.definition, F; if (N._4e_name() == this.element) { if (!E && !N._4e_hasAttributes()) { return AQ } var K = P._AC; if (K) { P = K } else { K = {}; var C = 0, D = P.attributes; if (D) { for (var B in D) { C++; K[B] = D[B] } } if (D = AJ.getStyleText(P)) { K.style || C++; K.style = D } K._length = C; P = P._AC = K } if (P._length) { for (var A in P) { if (A != "_length") { C = N.attr(A) || ""; if (A == "style") { Ad: { K = P[A]; C = AW(C, AG); typeof K == "string" && (K = AM(K)); typeof C == "string" && (C = AM(C)); D = void 0; for (D in K) { if (!(D in C && (C[D] == K[D] || K[D] == "inherit" || C[D] == "inherit"))) { K = AG; break Ad } } K = AQ } } else { K = P[A] == C } if (K) { if (!E) { return AQ } } else { if (E) { return AG } } } } if (E) { return AQ } } else { return AQ } } A = Ac(this); if (A = A[N._4e_name()] || A["*"]) { if (!(P = A.attributes) && !(F = A.styles)) { return AQ } if (P) { for (K = 0; K < P.length; K++) { A = P[K][0]; if (A = N.attr(A)) { C = P[K][1]; if (C === AF || typeof C == "string" && A == C || C.test && C.test(A)) { return AQ } } } } if (F) { for (K = 0; K < F.length; K++) { if (A = N.css(F[K][0])) { P = F[K][1]; if (P === AF || typeof P == "string" && A == P || P.test && P.test(A)) { return AQ } } } } } return AG }, checkActive: function (C) { switch (this.type) { case AD.STYLE_BLOCK: return this.checkElementRemovable(C.block || C.blockLimit, AQ); case AD.STYLE_OBJECT: case AD.STYLE_INLINE: for (var A = C.elements, D = 0, B; D < A.length; D++) { B = A[D]; if (!(this.type == AD.STYLE_INLINE && (AT._4e_equals(B, C.block) || AT._4e_equals(B, C.blockLimit)))) { if (!(this.type == AD.STYLE_OBJECT && !(B._4e_name() in J))) { if (this.checkElementRemovable(B, AQ)) { return AQ } } } } } return AG } }; AJ.getStyleText = function (D) { var A = D._ST; if (A) { return A } A = D.styles; var E = D.attributes && D.attributes.style || "", B = ""; if (E.length) { E = E.replace(I, ";") } for (var C in A) { var F = A[C], K = (C + ":" + F).replace(I, ";"); if (F == "inherit") { B += K } else { E += K } } if (E.length) { E = AW(E) } E += B; return D._ST = E }; AS.Style = AJ; AS.Style = AJ; var H = AJ.prototype; AS.Utils.extern(H, { apply: H.apply, remove: H.remove, applyToRange: H.applyToRange, removeFromRange: H.removeFromRange, applyToObject: H.applyToObject, checkElementRemovable: H.checkElementRemovable, checkActive: H.checkActive }) }); KISSY.Editor.add("htmlparser", function () { function B() { this._ = { htmlPartsRegex: RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)-->)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))", "g")} } var F = KISSY, D = function () { }, C = F.Editor, E = /([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g, A = { checked: 1, compact: 1, declare: 1, defer: 1, disabled: 1, ismap: 1, multiple: 1, nohref: 1, noresize: 1, noshade: 1, nowrap: 1, readonly: 1, selected: 1 }, G = C.XHTML_DTD; F.augment(B, { onTagOpen: D, onTagClose: D, onText: D, onCDATA: D, onComment: D, parse: function (I) { for (var K, M, P = 0, N; K = this._.htmlPartsRegex.exec(I); ) { M = K.index; if (M > P) { P = I.substring(P, M); N ? N.push(P) : this.onText(P) } P = this._.htmlPartsRegex.lastIndex; if (M = K[1]) { M = M.toLowerCase(); if (N && G.$cdata[M]) { this.onCDATA(N.join("")); N = null } if (!N) { this.onTagClose(M); continue } } if (N) { N.push(K[0]) } else { if (M = K[3]) { M = M.toLowerCase(); if (!/="/.test(M)) { var L = {}, H; K = K[4]; var J = !!(K && K.charAt(K.length - 1) == "/"); if (K) { for (; H = E.exec(K); ) { var O = H[1].toLowerCase(); H = H[2] || H[3] || H[4] || ""; L[O] = !H && A[O] ? O : H } } this.onTagOpen(M, L, J); if (!N && G.$cdata[M]) { N = [] } } } else { if (M = K[2]) { this.onComment(M) } } } } I.length > P && this.onText(I.substring(P, I.length)) } }); C.HtmlParser = B; C.HtmlParser = B }); KISSY.Editor.add("htmlparser-basicwriter", function () { function A() { this._ = { output: []} } var D = KISSY, C = D.Editor, B = C.Utils; D.augment(A, { openTag: function (E) { this._.output.push("<", E) }, openTagClose: function (F, E) { E ? this._.output.push(" />") : this._.output.push(">") }, attribute: function (F, E) { if (typeof E == "string") { E = B.htmlEncodeAttr(E) } this._.output.push(" ", F, '="', E, '"') }, closeTag: function (E) { this._.output.push("</", E, ">") }, text: function (E) { this._.output.push(E) }, comment: function (E) { this._.output.push("<!--", E, "-->") }, write: function (E) { this._.output.push(E) }, reset: function () { this._.output = []; this._.indent = false }, getHtml: function (F) { var E = this._.output.join(""); F && this.reset(); return E } }); C.HtmlParser.BasicWriter = A; C.HtmlParser.BasicWriter = A; D = A.prototype; C.Utils.extern(D, { openTag: D.openTag, openTagClose: D.openTagClose, attribute: D.attribute, closeTag: D.closeTag, text: D.text, comment: D.comment, write: D.write, reset: D.reset, getHtml: D.getHtml }) }); KISSY.Editor.add("htmlparser-htmlwriter", function () { function B() { B.superclass.constructor.call(this); this.indentationChars = "\t"; this.selfClosingEnd = " />"; this.lineBreakChars = "\n"; this.forceSimpleAmpersand = A; this.sortAttributes = E; this._.indent = A; this._.indentation = ""; this._.rules = {}; var H = D.XHTML_DTD, G; for (G in C.mix({}, H.$nonBodyContent, H.$block, H.$listItem, H.$tableContent)) { this.setRules(G, { indent: E, breakBeforeOpen: E, breakAfterOpen: E, breakBeforeClose: !H[G]["#"], breakAfterClose: E }) } this.setRules("br", { breakAfterOpen: E }); this.setRules("title", { indent: A, breakAfterOpen: A }); this.setRules("style", { indent: A, breakBeforeClose: E }); this.setRules("pre", { indent: A }) } var F = KISSY, D = F.Editor, C = D.Utils, E = true, A = false; F.extend(B, D.HtmlParser.BasicWriter, { openTag: function (H) { var G = this._.rules[H]; if (this._.indent) { this.indentation() } else { if (G && G.breakBeforeOpen) { this.lineBreak(); this.indentation() } } this._.output.push("<", H) }, openTagClose: function (I, G) { var H = this._.rules[I]; if (G) { this._.output.push(this.selfClosingEnd) } else { this._.output.push(">"); if (H && H.indent) { this._.indentation += this.indentationChars } } H && H.breakAfterOpen && this.lineBreak() }, attribute: function (H, G) { if (typeof G == "string") { this.forceSimpleAmpersand && (G = G.replace(/&amp;/g, "&")); G = C.htmlEncodeAttr(G) } this._.output.push(" ", H, '="', G, '"') }, closeTag: function (H) { var G = this._.rules[H]; if (G && G.indent) { this._.indentation = this._.indentation.substr(this.indentationChars.length) } if (this._.indent) { this.indentation() } else { if (G && G.breakBeforeClose) { this.lineBreak(); this.indentation() } } this._.output.push("</", H, ">"); G && G.breakAfterClose && this.lineBreak() }, text: function (G) { if (this._.indent) { this.indentation(); G = C.ltrim(G) } this._.output.push(G) }, comment: function (G) { this._.indent && this.indentation(); this._.output.push("<!--", G, "-->") }, lineBreak: function () { this._.output.length > 0 && this._.output.push(this.lineBreakChars); this._.indent = E }, indentation: function () { this._.output.push(this._.indentation); this._.indent = A }, setRules: function (I, G) { var H = this._.rules[I]; if (H) { C.mix(H, G) } else { this._.rules[I] = G } } }); D.HtmlParser.HtmlWriter = B; D.HtmlParser.HtmlWriter = B; F = B.prototype; D.Utils.extern(F, { openTag: F.openTag, openTagClose: F.openTagClose, attribute: F.attribute, closeTag: F.closeTag, text: F.text, comment: F.comment, lineBreak: F.lineBreak, indentation: F.indentation, setRules: F.setRules }) }); KISSY.Editor.add("htmlparser-fragment", function () { function D() { this.children = []; this.parent = J; this._ = { isBlockLike: A, hasInlineStarted: K} } var A = true, K = false, J = null, L = KISSY.Editor, I = { colgroup: 1, dd: 1, dt: 1, li: 1, option: 1, p: 1, td: 1, tfoot: 1, th: 1, thead: 1, tr: 1 }, B = KISSY, C = L.Utils, E = L.NODE, F = L.XHTML_DTD; C.mix({ table: 1, ul: 1, ol: 1, dl: 1 }, F.table, F.ul, F.ol, F.dl); var H = F.$list, G = F.$listItem; D.FromHtml = function (U, N) { function S(b) { var a; if (Q.length > 0) { for (var f = 0; f < Q.length; f++) { var e = Q[f], g = e.name, c = F[g], d = P.name && F[P.name]; if ((!d || d[g]) && (!b || !c || c[b] || !F[b])) { if (!a) { W(); a = 1 } e = e.clone(); e.parent = P; P = e; Q.splice(f, 1); f-- } } } } function W() { for (; O.length; ) { P.add(O.shift()) } } function T(b, a, d) { a = a || P || R; if (N && !a.type) { var c, e; if ((c = b.attributes && (e = b.attributes._ke_real_element_type) ? e : b.name) && !(c in F.$body) && !(c in F.$nonBodyContent)) { e = P; P = a; Y.onTagOpen({ li: "ul", dt: "dl", dd: "dl"}[c] || N, {}); a = P; if (d) { P = e } } } if (b._.isBlockLike && b.name != "pre") { d = b.children.length; if ((c = b.children[d - 1]) && c.type == E.NODE_TEXT) { if (e = C.rtrim(c.value)) { c.value = e } else { b.children.length = d - 1 } } } a.add(b); if (b.returnPoint) { P = b.returnPoint; delete b.returnPoint } } var Y = new L.HtmlParser, R = new D, Q = [], O = [], P = R, X = K, V; Y.onTagOpen = function (b, a, f) { var e = new L.HtmlParser.Element(b, a); if (e.isUnknown && f) { e.isEmpty = A } if (F.$removeEmpty[b]) { Q.push(e) } else { if (String(b) === "pre") { X = A } else { if (String(b) === "br" && X) { P.add(new L.HtmlParser.Text("\n")); return } } if (String(b) === "br") { O.push(e) } else { var g = P.name, c = g && (F[g] || (P._.isBlockLike ? F.div : F.span)); if (c && !e.isUnknown && !P.isUnknown && !c[b]) { c = K; var d; if (b in H && g in H) { g = P.children; (g = g[g.length - 1]) && g.name in G || T(g = new L.HtmlParser.Element("li"), P); V = P; d = g } else { if (b == g) { T(P, P.parent) } else { T(P, P.parent, A); !I[g] && g in F.$inline && Q.unshift(P); c = A } } P = d ? d : P.returnPoint || P.parent; if (c) { Y.onTagOpen.apply(this, arguments); return } } S(b); W(); e.parent = P; e.returnPoint = V; V = 0; if (e.isEmpty) { T(e) } else { P = e } } } }; Y.onTagClose = function (b) { for (var a = Q.length - 1; a >= 0; a--) { if (b == Q[a].name) { Q.splice(a, 1); return } } for (var e = [], d = [], f = P; f.type && f.name != b; ) { f._.isBlockLike || d.unshift(f); e.push(f); f = f.parent } if (f.type) { for (a = 0; a < e.length; a++) { var c = e[a]; T(c, c.parent) } P = f; if (P.name == "pre") { X = K } f._.isBlockLike && W(); T(f, f.parent); if (f == P) { P = P.parent } Q = Q.concat(d) } if (b == "body") { N = K } }; Y.onText = function (a) { if (!P._.hasInlineStarted && !X) { a = C.ltrim(a); if (a.length === 0) { return } } W(); S(); if (N && (!P.type || P.name == "body") && C.trim(a)) { this.onTagOpen(N, {}) } X || (a = a.replace(/[\t\r\n ]{2,}|[\t\r\n]/g, " ")); P.add(new L.HtmlParser.Text(a)) }; Y.onCDATA = function (a) { P.add(new L.HtmlParser.cdata(a)) }; Y.onComment = function (a) { P.add(new L.HtmlParser.Comment(a)) }; Y.parse(U); for (W(); P.type; ) { var Z = P.parent, M = P; if (N && (!Z.type || Z.name == "body") && !F.$body[M.name]) { P = Z; Y.onTagOpen(N, {}); Z = P } Z.add(M); P = Z } return R }; B.augment(D, { add: function (N) { var M = this.children.length; if (M = M > 0 && this.children[M - 1] || J) { if (N._.isBlockLike && M.type == E.NODE_TEXT) { M.value = C.rtrim(M.value); if (M.value.length === 0) { this.children.pop(); this.add(N); return } } M.next = N } N.previous = M; N.parent = this; this.children.push(N); this._.hasInlineStarted = N.type == E.NODE_TEXT || N.type == E.NODE_ELEMENT && !N._.isBlockLike }, writeHtml: function (O, N) { var M; this.filterChildren = this.filterChildren = function () { var P = new L.HtmlParser.BasicWriter; this.writeChildrenHtml.call(this, P, N, A); P = P.getHtml(); this.children = (new D.FromHtml(P)).children; M = 1 }; !this.name && N && N.onFragment(this); this.writeChildrenHtml(O, M ? J : N) }, writeChildrenHtml: function (O, N) { for (var M = 0; M < this.children.length; M++) { this.children[M].writeHtml(O, N) } } }); L.HtmlParser.Fragment = D; L.HtmlParser.Fragment = D; D.FromHtml = D.FromHtml; B = D.prototype; L.Utils.extern(B, { add: B.add, writeHtml: B.writeHtml, writeChildrenHtml: B.writeChildrenHtml }) }); KISSY.Editor.add("htmlparser-element", function () { function A(G, J) { this.name = G; this.attributes = J || (J = {}); this.children = []; var F = J._ke_real_element_type || G, H = E.XHTML_DTD; F = !!(H.$nonBodyContent[F] || H.$block[F] || H.$listItem[F] || H.$tableContent[F] || H.$nonEditable[F] || F == "br"); var I = !!H.$empty[G]; this.isEmpty = I; this.isUnknown = !H[G]; this._ = { isBlockLike: F, hasInlineStarted: I || !F} } var E = KISSY.Editor, C = E.NODE, B = function (F, G) { F = F[0]; G = G[0]; return F < G ? -1 : F > G ? 1 : 0 }; KISSY.augment(A, { type: C.NODE_ELEMENT, add: E.HtmlParser.Fragment.prototype.add, clone: function () { return new A(this.name, this.attributes) }, writeHtml: function (P, G) { var H = this.attributes, J = this, L = J.name, O, M, K, F; J.filterChildren = function () { if (!F) { var Q = new E.HtmlParser.BasicWriter; E.HtmlParser.Fragment.prototype.writeChildrenHtml.call(J, Q, G); J.children = (new E.HtmlParser.Fragment.FromHtml(Q.getHtml())).children; F = 1 } }; J.filterChildren = J.filterChildren; if (G) { for (; ; ) { if (!(L = G.onElementName(L))) { return } J.name = L; if (!(J = G.onElement(J))) { return } J.parent = this.parent; if (J.name == L) { break } if (J.type != C.NODE_ELEMENT) { J.writeHtml(P, G); return } L = J.name; if (!L) { this.writeChildrenHtml.call(J, P, F ? null : G); return } } H = J.attributes } P.openTag(L, H); for (var I = [], N = 0; N < 2; N++) { for (O in H) { M = O; K = H[O]; if (N == 1) { I.push([O, K]) } else { if (G) { for (; ; ) { if (M = G.onAttributeName(O)) { if (M != O) { delete H[O]; O = M } else { break } } else { delete H[O]; break } } if (M) { if ((K = G.onAttribute(J, M, K)) === false) { delete H[M] } else { H[M] = K } } } } } } P.sortAttributes && I.sort(B); H = I.length; for (N = 0; N < H; N++) { O = I[N]; P.attribute(O[0], O[1]) } P.openTagClose(L, J.isEmpty); if (!J.isEmpty) { this.writeChildrenHtml.call(J, P, F ? null : G); P.closeTag(L) } }, writeChildrenHtml: function () { E.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this, arguments) } }); E.HtmlParser.Element = A; E.HtmlParser.Element = A; var D = A.prototype; E.Utils.extern(D, { type: D.type, add: D.add, clone: D.clone, writeHtml: D.writeHtml, writeChildrenHtml: D.writeChildrenHtml }) }); KISSY.Editor.add("htmlparser-filter", function () { function D(K) { this._ = { elementNames: [], attributeNames: [], elements: { $length: 0 }, attributes: { $length: 0} }; K && this.addRules(K, 10) } function A(K, N) { for (var M = 0; K && M < N.length; M++) { var L = N[M]; K = K.replace(L[0], L[1]) } return K } function I(L, P, O) { if (typeof P == "function") { P = [P] } var N, M; M = L.length; var K = P && P.length; if (K) { for (N = 0; N < M && L[N].pri < O; N++) { } for (M = K - 1; M >= 0; M--) { if (K = P[M]) { K.pri = O; L.splice(N, 0, K) } } } } function H(K, O, N) { if (O) { for (var M in O) { var L = K[M]; K[M] = J(L, O[M], N); L || K.$length++ } } } function J(K, M, L) { if (M) { M.pri = L; if (K) { if (K.splice) { I(K, M, L) } else { K = K.pri > L ? [M, K] : [K, M]; K.filter = G } return K } else { return M.filter = M } } } function G(L) { for (var P = L.type || L instanceof C.HtmlParser.Fragment, O = 0; O < this.length; O++) { if (P) { var N = L.type, M = L.name } var K = this[O].apply(window, arguments); if (K === F) { return K } if (P) { if (K && (K.name != M || K.type != N)) { return K } } else { if (typeof K != "string") { return K } } K != undefined && (L = K) } return L } var B = KISSY, C = B.Editor, E = C.NODE, F = false; B.augment(D, { addRules: function (K, L) { if (typeof L != "number") { L = 10 } I(this._.elementNames, K.elementNames, L); I(this._.attributeNames, K.attributeNames, L); H(this._.elements, K.elements, L); H(this._.attributes, K.attributes, L); this._.text = J(this._.text, K.text, L) || this._.text; this._.comment = J(this._.comment, K.comment, L) || this._.comment; this._.root = J(this._.root, K.root, L) || this._.root }, onElementName: function (K) { return A(K, this._.elementNames) }, onAttributeName: function (K) { return A(K, this._.attributeNames) }, onText: function (K) { var L = this._.text; return L ? L.filter(K) : K }, onComment: function (K, M) { var L = this._.comment; return L ? L.filter(K, M) : K }, onFragment: function (K) { var L = this._.root; return L ? L.filter(K) : K }, onElement: function (K) { for (var N = [this._.elements["^"], this._.elements[K.name], this._.elements.$], M, L = 0; L < 3; L++) { if (M = N[L]) { M = M.filter(K, this); if (M === F) { return null } if (M && M != K) { return this.onNode(M) } if (K.parent && !K.name) { break } } } return K }, onNode: function (K) { var L = K.type; return L == E.NODE_ELEMENT ? this.onElement(K) : L == E.NODE_TEXT ? new C.HtmlParser.Text(this.onText(K.value)) : null }, onAttribute: function (K, M, L) { if (M = this._.attributes[M]) { K = M.filter(L, K, this); if (K === F) { return F } if (typeof K != "undefined") { return K } } return L } }); C.HtmlParser.Filter = D; B = D.prototype; C.Utils.extern(B, { addRules: B.addRules, onElementName: B.onElementName, onAttributeName: B.onAttributeName, onText: B.onText, onComment: B.onComment, onFragment: B.onFragment, onElement: B.onElement, onNode: B.onNode, onAttribute: B.onAttribute }); C.HtmlParser.Filter = D }); KISSY.Editor.add("htmlparser-text", function () { function A(E) { this.value = E; this._ = { isBlockLike: B} } var D = KISSY, C = D.Editor, B = false; D.augment(A, { type: C.NODE.NODE_TEXT, writeHtml: function (F, E) { var G = this.value; E && !(G = E.onText(G, this)) || F.text(G) } }); C.HtmlParser.Text = A; C.HtmlParser.Text = A }); KISSY.Editor.add("htmlparser-cdata", function (A) { A.HtmlParser.cdata = function (B) { this.value = B }; A.HtmlParser.cdata.prototype = { type: A.NODE.NODE_TEXT, writeHtml: function (B) { B.write(this.value) } } }); KISSY.Editor.add("htmlparser-comment", function () { function A(D) { this.value = D; this._ = { isBlockLike: false} } var C = KISSY.Editor, B = C.NODE; C.HtmlParser.Comment = A; C.HtmlParser.Comment = A; A.prototype = { constructor: A, type: B.NODE_COMMENT, writeHtml: function (E, F) { var D = this.value; if (F) { if (!(D = F.onComment(D, this))) { return } if (typeof D != "string") { D.parent = this.parent; D.writeHtml(E, F); return } } E.comment(D) } } }); KISSY.Editor.add("button", function () { var A = KISSY, C = A.Editor; if (C.TripleButton) { A.log("TripleButton attach twice", "warn") } else { var B = A.UIBase.create([A.UIBase.Box.Render || A.UIBase.Box], { bindUI: function () { var D = this, E = D.get("el"); E.on("click", D._action, D); E.on("mousedown", function () { D.get("state") == "off" && E.addClass("ke-triplebutton-active") }); E.on("mouseup mouseleave", function () { D.get("state") == "off" && E.hasClass("ke-triplebutton-active") && setTimeout(function () { E.removeClass("ke-triplebutton-active") }, 300) }) }, _uiSetTitle: function () { this.get("el").attr("title", this.get("title")) }, _uiSetContentCls: function (D) { var E = this.get("el"); if (D !== undefined) { E.html("<span class='ke-toolbar-item " + D + "'>"); E._4e_unselectable() } }, _uiSetText: function (D) { var E = this.get("el"); D !== undefined && E.html(D) }, _uiSetState: function (D) { this["_" + D]() }, disable: function () { this._savedState = this.get("state"); this.set("state", "disabled") }, enable: function () { this.get("state") == "disabled" && this.set("state", this._savedState) }, _action: function (D) { this.fire(this.get("state") + "Click", { TripleEvent: D }); this.fire("click", { TripleClickType: this.get("state") + "Click" }); D && D.preventDefault() }, bon: function () { this.set("state", "on") }, boff: function () { this.set("state", "off") }, _on: function () { var D = this.get("el"); D.removeClass("ke-triplebutton-off ke-triplebutton-disabled"); D.addClass("ke-triplebutton-on") }, _off: function () { var D = this.get("el"); D.removeClass("ke-triplebutton-on ke-triplebutton-disabled"); D.addClass("ke-triplebutton-off") }, _disabled: function () { var D = this.get("el"); D.removeClass("ke-triplebutton-off ke-triplebutton-on"); D.addClass("ke-triplebutton-disabled") } }, { ATTRS: { state: { value: "off" }, elCls: { value: "ke-triplebutton ke-triplebutton-off" }, elAttrs: { value: { hideFocus: true, tabIndex: 0} }, elTagName: { value: "a" }, title: {}, contentCls: {}, text: {}} }); B.ON = "on"; B.OFF = "off"; B.DISABLED = "disabled"; B.ON_CLASS = "ke-triplebutton-on"; B.OFF_CLASS = "ke-triplebutton-off"; B.DISABLED_CLASS = "ke-triplebutton-disabled"; C.TripleButton = B; C.prototype.addButton = function (F, G) { var E = this, H = new B({ render: E.toolBarDiv, autoRender: true, title: G.title, text: G.text, contentCls: G.contentCls }), D = { btn: H, editor: E, cfg: G, call: function () { var I = A.makeArray(arguments), J = I.shift(); return G[J].apply(D, I) }, reload: function (I) { A.mix(G, I); H.enable(); E.on("selectionChange", function () { E.getMode() != C.SOURCE_MODE && G.selectionChange && G.selectionChange.apply(D, arguments) }); H.on("click", function (K) { var J = K.TripleClickType; G[J] && G[J].apply(D, arguments); K && K.halt() }); if (G.mode == C.WYSIWYG_MODE) { E.on("wysiwygmode", H.enable, H); E.on("sourcemode", H.disable, H) } G.init && G.init.call(D) }, destroy: function () { G.destroy && G.destroy.call(D); H.destroy() } }; G.loading ? H.disable() : D.reload(undefined); return D } } }, { attach: false }); KISSY.Editor.add("select", function () { function D(J) { D.superclass.constructor.call(this, J); this._init() } var A = KISSY, H = A.Node, G = A.Event, I = A.DOM, F = A.Editor; if (F.Select) { A.log("ke select attach more") } else { D.DISABLED = 0; D.ENABLED = 1; var B = F.XHTML_DTD; D.ATTRS = { showValue: {}, el: {}, cls: {}, container: {}, doc: {}, value: {}, width: {}, title: {}, items: {}, emptyText: {}, align: { value: ["l", "b"] }, menuContainer: { valueFn: function () { for (var K = this.el.parent(); K; ) { var J = K._4e_name(); if (B[J] && B[J].div) { return K } K = K.parent() } return new H(document.body) } }, state: { value: 1} }; D.decorate = function (N) { for (var J = N.width(), O = [], M = N.all("option"), L = 0; L < M.length; L++) { var K = M[L]; O.push({ name: I.html(K), value: I.attr(K, "value") }) } return new D({ width: J + "px", el: N, items: O, cls: "ke-combox", value: N.val() }) }; var C = F.Utils.addRes, E = F.Utils.destroyRes; A.extend(D, A.Base, { _init: function () { var O = this.get("container"), K = this.get("el"), P = new H("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"), N = this.get("title") || "", M = this.get("cls"), L = P.one(".ke-select-text"), J = P.one(".ke-select-text-inner"); P.one(".ke-select-drop"); this.get("value") !== undefined ? J.html(this._findNameByV(this.get("value"))) : J.html(N); L.css("width", this.get("width")); P._4e_unselectable(); N && P.attr("title", N); M && P.addClass(M); if (K) { K[0].parentNode.replaceChild(P[0], K[0]) } else { O && P.appendTo(O) } P.on("click", this._click, this); this.el = P; this.title = J; this._focusA = P.one("a.ke-select"); F.Utils.lazyRun(this, "_prepare", "_real"); this.on("afterValueChange", this._valueChange, this); this.on("afterStateChange", this._stateChange, this) }, _findNameByV: function (M) { var J = this.get("title") || "", N = this.get("items"); if (this.get("showValue")) { return M || J } for (var L = 0; L < N.length; L++) { var K = N[L]; if (K.value == M) { J = K.name; break } } return J }, _valueChange: function (J) { this.title.html(this._findNameByV(J.newVal)) }, _itemsChange: function (L) { var J; J = L.newVal; L = this._selectList; L.html(""); if (J && J.length) { for (var M = 0; M < J.length; M++) { var K = J[M]; (new H("<a class='ke-select-menu-item' href='#' data-value='" + K.value + "'>" + K.name + "</a>", K.attrs)).appendTo(L)._4e_unselectable() } } else { if (J = this.get("emptyText")) { (new H("<a class='ke-select-menu-item' href='#'>" + J + "</a>")).appendTo(L)._4e_unselectable() } } this.as = L.all("a") }, val: function (J) { if (J !== undefined) { this.set("value", J); return this } else { return this.get("value") } }, _resize: function () { this.menu.get("visible") && this._real() }, _prepare: function () { function O(Q) { Q = new H(Q.target); P.contains(Q) || P._4e_equals(Q) || L.hide() } var K = this, P = K.el, N = K.get("popUpWidth"), M = K._focusA, L = new F.Overlay({ autoRender: true, render: K.get("menuContainer"), content: "<div>", focus4e: false, elCls: "ke-menu", width: N ? N : P.width(), zIndex: F.baseZIndex(F.zIndexManager.SELECT), focusMgr: false }), J = K.get("items"); C.call(K, L); N = L.get("contentEl").one("div"); K.menu = L; G.on(window, "resize", K._resize, K); C.call(K, function () { G.remove(window, "resize", K._resize, K) }); K.get("title") && (new H("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >" + K.get("title") + "</div>")).appendTo(N); K._selectList = (new H("<div>")).appendTo(N); K._itemsChange({ newVal: J }); L.on("show", function () { M.addClass("ke-select-active") }); L.on("hide", function () { M.removeClass("ke-select-active") }); G.on(document, "click", O); C.call(K, function () { G.remove(document, "click", O) }); K.get("doc") && G.on(K.get("doc"), "click", O); N.on("click", K._select, K); K.as = K._selectList.all("a"); G.on(N[0], "mouseenter", function () { K.as.removeClass("ke-menu-selected") }); C.call(K, N); K.on("afterItemsChange", K._itemsChange, K); K.menuNode = N }, _stateChange: function (K) { var J = this.el; K.newVal == 1 ? J.removeClass("ke-select-disabled") : J.addClass("ke-select-disabled") }, enable: function () { this.set("state", 1) }, disable: function () { this.set("state", 0) }, _select: function (M) { M && M.halt(); var J = this.menu, N = this.menuNode; if ((M = (new H(M.target))._4e_ascendant(function (O) { return N.contains(O) && O._4e_name() == "a" }, true)) && M._4e_hasAttribute("data-value")) { var L = this.get("value"), K = M.attr("data-value"); this.set("value", K); this.fire("click", { newVal: K, prevVal: L, name: M.html() }); J.hide() } }, _real: function () { var Q = this.el, T = Q.offset(), R = A.clone(T), P = this.menu.get("el").height(), J = this.menu.get("el").width(), N = I.scrollTop(), S = I.scrollLeft(), O = I.viewportHeight(), U = I.viewportWidth(); U = S + U - 60; O = N + O; var M = T.top + (Q.height() - 2); Q = T.left + Q.width() - 2; var L = this.get("align"), K = L[0]; if (L[1] == "b") { T.top = M; if (T.top + P > O && R.top - N > O - M) { T.top = R.top - P } } else { T.top = R.top - P; if (T.top < N && R.top - N < O - M) { T.top = M } } if (K == "l") { if (T.left + J > U && Q - S > U - R.left) { T.left = Q - J } } else { T.left = Q - J; if (T.left < S && Q - S < U - R.left) { T.left = R.left } } this.menu.set("xy", [T.left, T.top]); this.menu.show() }, _click: function (K) { if (!this.loading) { K && K.preventDefault(); var J = this; K = J.el; var L = J.get("value"); if (!K.hasClass("ke-select-disabled")) { if (J._focusA.hasClass("ke-select-active")) { J.menu && J.menu.hide() } else { J.loading = true; F.use("overlay", function () { J.loading = false; J.fire("select"); J._prepare(); L && J.menu && J.as.each(function (M) { M.attr("data-value") == L ? M.addClass("ke-menu-selected") : M.removeClass("ke-menu-selected") }) }) } } } }, destroy: function () { E.call(this); this.el.detach(); this.el.remove() } }); F.Select = D; F.prototype.addSelect = function (M, J) { var N = this; J = A.mix({ container: N.toolBarDiv, doc: N.document, menuContainer: new H(document.body) }, J); var L = new D(J), K = { btn: L, editor: N, cfg: J, call: function () { var P = A.makeArray(arguments), O = P.shift(); return J[O].apply(K, P) }, reload: function (O) { A.mix(J, O); L.enable(); N.on("selectionChange", function () { N.getMode() != F.SOURCE_MODE && J.selectionChange && J.selectionChange.apply(K, arguments) }); L.on("click", function (P) { var Q = P.type; J[Q] && J[Q].apply(K, arguments); P && P.halt() }); if (J.mode == F.WYSIWYG_MODE) { N.on("wysiwygmode", L.enable, L); N.on("sourcemode", L.disable, L) } J.init && J.init.call(K) }, destroy: function () { J.destroy && J.destroy.call(K); L.destroy() } }; J.loading ? L.disable() : K.reload(undefined); return K } } }, { attach: false }); KISSY.Editor.add("bubbleview", function () { function B(H) { H = G[H]; if (!H.bubble) { H.bubble = new A({ autoRender: true }); H.cfg.init && H.cfg.init.call(H.bubble) } return H.bubble } var F = KISSY, D = F.Editor, C = F.Event, E = F.DOM; if (D.BubbleView) { F.log("attach bubbleview more", "warn") } else { var A = F.UIBase.create(D.Overlay, [], { renderUI: function () { this.get("el").addClass("ke-bubbleview-bubble") }, show: function () { var H = this._selectedEl, L = H._4e_getOffset(document); L.top += H.height() + 5; this.set("xy", [L.left, L.top]); var N, I; for (I in G) { H = G[I]; if (H.bubble) { var O; if (O = this != H.bubble) { if (O = H.bubble.get("visible")) { var M = H.bubble; O = this.get("y"); var K = O + this.get("el")[0].offsetHeight, J = M.get("y"); M = J + M.get("el")[0].offsetHeight; O = !(K < J || M < O) } O = O } if (O) { if (N) { if (N.get("y") < H.bubble.get("y")) { N = H.bubble } } else { N = H.bubble } } } } if (N = N) { L.top = N.get("y") + N.get("el")[0].offsetHeight } A.superclass.show.call(this); this.set("xy", [L.left, L.top]) }, destructor: function () { D.Utils.destroyRes.call(this) } }, { ATTRS: { focus4e: { value: false }, zIndex: { value: D.baseZIndex(D.zIndexManager.BUBBLE_VIEW)}} }), G = {}; A.destroy = function (H) { if ((H = G[H]) && H.bubble) { H.bubble.destroy(); H.bubble = null } }; A.attach = function (H) { function K() { J && J.hide() } var M = H.pluginName; F.mix(H, G[M].cfg, false); var I = H.pluginContext, N = H.func, L = H.editor, J = H.bubble; L.on("selectionChange", function (P) { P = P.path; var O = P.elements; if (P && O) { if (P = P.lastElement) { if (P = N(P)) { J = B(M); J._selectedEl = P; J._plugin = I; J.hide(); setTimeout(function () { J.show() }, 10) } else { if (J) { J._selectedEl = J._plugin = null; J.hide() } } } } }); L.on("sourcemode blur", K); C.on(E._4e_getWin(L.document), "scroll", K) }; A.register = function (H) { var I = H.pluginName; G[I] = G[I] || { cfg: H }; C.on(document, "click", function () { H.bubble && H.bubble.hide() }); H.editor && A.attach(H) }; D.BubbleView = A } }, { attach: false, requires: ["overlay"] }); KISSY.Editor.add("clipboard", function (C) { var G = KISSY, E = G.Editor, D = G.Node, F = G.UA, B = E.Range, H = E.RANGE, A = G.Event; E.Paste || function () { function K(S) { this.editor = S; this._init() } function N(U) { if (!(!F.ie || U.document.compatMode == "BackCompat")) { var T = U.getSelection(), V; if (T.getType() == P.SELECTION_ELEMENT && (V = T.getSelectedElement())) { var W = T.getRanges()[0], S = new D(U.document.createTextNode("")); S.insertBefore(V); W.setStartBefore(S); W.setEndAfter(V); T.selectRanges([W]); setTimeout(function () { if (V.parent()) { S.remove(); T.selectElement(V) } }, 0) } } } function Q(T, S) { R = 1; var U = true; try { U = S.queryCommandEnabled(T) ? true : false } catch (V) { } R = 0; return U } G.augment(K, { _init: function () { var S = this.editor; A.on(S.document.body, F.webkit ? "paste" : F.gecko ? "keydown" : "beforepaste", this._paste, this); A.on(S.document.body, "contextmenu", function () { R = 1; setTimeout(function () { R = 0 }, 10) }); S.addCommand("copy", new J("copy")); S.addCommand("cut", new J("cut")); S.addCommand("paste", new J("paste")) }, _paste: function (U) { if (!R) { if (!(U.type === "keydown" && !(U.keyCode === 86 && (U.ctrlKey || U.metaKey)))) { G.log(U.type + " :  paste event happen"); var T = this.editor, V = T.document; if (V.getElementById("ke_pastebin")) { G.log(U.type + " : trigger twice ...") } else { var X = T.getSelection(); U = new B(V); var S = new D(F.webkit ? "<body></body>" : "<div></div>", null, V); S.attr("id", "ke_pastebin"); F.webkit && S[0].appendChild(V.createTextNode("\u00a0")); V.body.appendChild(S[0]); S.css({ position: "absolute", top: X.getStartElement().offset().top + "px", width: "1px", height: "1px", overflow: "hidden" }); S.css("left", "-1000px"); var W = X.createBookmarks(); U.setStartAt(S, H.POSITION_AFTER_START); U.setEndAt(S, H.POSITION_BEFORE_END); U.select(true); setTimeout(function () { S._4e_remove(); var Y; S = F.webkit && (Y = S._4e_first()) && Y.hasClass("Apple-style-span") ? Y : S; X.selectBookmarks(W); Y = S.html(); if (Y = G.trim(Y.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig, ""))) { G.log("paster " + Y); var Z = T.fire("paste", { html: Y, holder: S }); if (Z !== undefined) { Y = Z } Z = null; if (/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(Y)) { Z = T.htmlDataProcessor.wordFilter } T.insertHtml(Y, Z) } }, 0) } } } } }); E.Paste = K; var O = function (U, T) { var V = U.document, X = new D(V.body), S = false, W = function () { S = true }; X.on(T, W); (F.ie > 7 ? V : V.selection.createRange()).execCommand(T); X.detach(T, W); return S }, M = F.ie ? function (T, S) { return O(T, S) } : function (T, S) { try { return T.document.execCommand(S) } catch (U) { return false } }, I = { cut: "\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210", copy: "\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210", paste: "\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210" }, J = function (S) { this.type = S; this.canUndo = this.type == "cut" }; J.prototype = { exec: function (S) { this.type == "cut" && N(S); (S = M(S, this.type)) || alert(I[this.type]); return S } }; var P = E.Selection, L = { copy: "\u590d\u5236", paste: "\u7c98\u8d34", cut: "\u526a\u5207" }, R; E.on("contextmenu", function (U) { var T = U.contextmenu, V = T.cfg.editor, X = T.elDom, S = { copy: 0, cut: 0, paste: 0 }, W; for (W in S) { if (!S.hasOwnProperty(W)) { break } S[W] = X.one(".ke-paste-" + W); (function (Y) { var Z = S[Y]; if (!Z) { Z = (new D("<a href='#'class='ke-paste-" + Y + "'>" + L[Y] + "</a>")).appendTo(X); Z.on("click", function (a) { a.halt(); if (!Z.hasClass("ke-menuitem-disable")) { T.hide(); setTimeout(function () { V.execCommand(Y) }, 30) } }) } S[Y] = Z })(W); U = S[W]; Q(W, V.document) ? U.removeClass("ke-menuitem-disable") : U.addClass("ke-menuitem-disable") } }) } (); C.ready(function () { new E.Paste(C) }) }, { attach: false }); KISSY.Editor.add("color", function (A) { A.addPlugin("color", function () { var D = KISSY.Editor, C = A.cfg.pluginConfig, B = []; false !== C.forecolor && function () { var E = A.addButton("color", { styles: { element: "span", styles: { color: "#(color)" }, overrides: [{ element: "font", attributes: { color: null}}] }, mode: D.WYSIWYG_MODE, title: "\u6587\u672c\u989c\u8272", loading: true, contentCls: "ke-toolbar-color" }); D.use("colorsupport", function () { E.reload(D.ColorSupport) }); B.push(function () { E.destroy() }) } (); false !== C.bgcolor && function () { var E = A.addButton("color", { styles: { element: "span", styles: { "background-color": "#(color)" }, overrides: [{ element: "*", styles: { "background-color": null}}] }, title: "\u80cc\u666f\u989c\u8272", mode: D.WYSIWYG_MODE, loading: true, contentCls: "ke-toolbar-bgcolor" }); D.use("colorsupport", function () { E.reload(D.ColorSupport) }); B.push(function () { E.destroy() }) } (); this.destroy = function () { for (var E = 0; E < B.length; E++) { B[E]() } } }) }, { attach: false }); KISSY.Editor.add("colorsupport", function () { function D() { if (!C) { C = "<div class='ke-color-panel'><a class='ke-color-remove' href=\"javascript:void('\u6e05\u9664');\">\u6e05\u9664</a>"; for (var L = 0; L < 3; L++) { C += "<div class='ke-color-palette'><table>"; for (var P = B[L], O = P.length / 8, N = 0; N < O; N++) { C += "<tr>"; for (var M = 0; M < 8; M++) { var K = "#" + P[8 * N + M]; C += "<td>"; C += "<a href='javascript:void(0);' class='ke-color-a' style='background-color:" + K + "'></a>"; C += "</td>" } C += "</tr>" } C += "</table></div>" } C += "<div><a class='ke-button ke-color-others'>\u5176\u4ed6\u989c\u8272</a></div></div>" } } var A = KISSY, I = A.Editor, H = A.Node, J = A.Event, G = A.DOM; G.addStyleSheet(".ke-color-panel a {display: block;color:black;text-decoration: none;}.ke-color-panel a:hover {color:black;text-decoration: none;}.ke-color-panel a:active {color:black;}.ke-color-palette {    margin: 5px 8px 8px;}.ke-color-palette table {    border: 1px solid #666666;    border-collapse: collapse;}.ke-color-palette td {    border-right: 1px solid #666666;    height: 18px;    width: 18px;}a.ke-color-a {    height: 18px;    width: 18px;}a.ke-color-a:hover {    border: 1px solid #ffffff;    height: 16px;    width: 16px;}a.ke-color-remove {  padding:3px 8px;  margin:2px 0 3px 0;}a.ke-color-remove:hover {    background-color: #D6E9F8;}", "ke-color-plugin"); var B = [["000", "444", "666", "999", "CCC", "EEE", "F3F3F3", "FFF"], ["F00", "F90", "FF0", "0F0", "0FF", "00F", "90F", "F0F"], ["F4CCCC", "FCE5CD", "FFF2CC", "D9EAD3", "D0E0E3", "CFE2F3", "D9D2E9", "EAD1DC", "EA9999", "F9CB9C", "FFE599", "B6D7A8", "A2C4C9", "9FC5E8", "B4A7D6", "D5A6BD", "E06666", "F6B26B", "FFD966", "93C47D", "76A5AF", "6FA8DC", "8E7CC3", "C27BAD", "CC0000", "E69138", "F1C232", "6AA84F", "45818E", "3D85C6", "674EA7", "A64D79", "990000", "B45F06", "BF9000", "38761D", "134F5C", "0B5394", "351C75", "741B47", "660000", "783F04", "7F6000", "274E13", "0C343D", "073763", "20124D", "4C1130"]], C, E = I.Utils.addRes, F = I.Utils.destroyRes; I.ColorSupport = { offClick: function (K) { var M = this, L = M.cfg; I.use("overlay", function () { L._prepare.call(M, K) }) }, onClick: function () { this.colorWin && this.colorWin.hide() }, _prepare: function () { var L = this, Q = L.cfg, P = document, N = L.btn, M = L.editor, K; D(); L.colorWin = new I.Overlay({ elCls: "ks-popup", content: C, focus4e: false, autoRender: true, width: "170px", zIndex: I.baseZIndex(I.zIndexManager.POPUP_MENU) }); var O = L.colorWin; K = O.get("contentEl"); K.on("click", Q._selectColor, L); J.on(P, "click", Q._hidePanel, L); J.on(M.document, "click", Q._hidePanel, L); O.on("show", N.bon, N); O.on("hide", N.boff, N); P = K.one(".ke-color-others"); P.on("click", function (R) { R.halt(); O.hide(); M.useDialog("color/dialog", function (S) { S.show(L) }) }); Q._prepare = Q._show; Q._show.call(L); E.call(L, K, O, P) }, _show: function () { var K = this.btn.get("el"), N = this.colorWin, M = parseInt(N.get("width")), L = G.viewportWidth(); N.align(K, ["bl", "tl"], [0, 2]); N.get("x") + M > L - 30 && N.set("x", L - 30 - M); N.show() }, _hidePanel: function (K) { var M = this.btn.get("el"); K = new H(K.target); var L = this.colorWin; M._4e_equals(K) || M.contains(K) || L.hide() }, _selectColor: function (K) { K.halt(); var L = this.cfg; K = new H(K.target); if (K._4e_name() == "a" && !K.hasClass("ke-button")) { L._applyColor.call(this, K._4e_style("background-color")); this.colorWin.hide() } }, _applyColor: function (K) { var N = this.editor, M = N.document, L = this.cfg.styles; N.fire("save"); K ? (new I.Style(L, { color: K })).apply(M) : (new I.Style(L, { color: "inherit" })).remove(M); N.fire("save") }, destroy: function () { F.call(this); var K = this.editor; J.remove(document, "click", this.cfg._hidePanel, this); K.destroyDialog("color/dialog") } } }, { attach: false }); KISSY.Editor.add("contextmenu", function () { function D(J) { this.cfg = J; G.Utils.lazyRun(this, "_prepareShow", "_realShow") } function A(L, J) { for (var M = 0; M < J.length; M++) { var K = J[M]; if (H.isFunction(K)) { if (K(new I(L))) { return true } } else { if (F.test(L, K)) { return true } } } return false } var H = KISSY, G = H.Editor, I = H.Node, F = H.DOM, B = H.Event; if (G.ContextMenu) { H.log("attach ContextMenu twice", "warn") } else { D.ATTRS = { editor: {} }; var C = []; D.register = function (L) { var J = new D(L), M = L.editor, K = M.document; C.push({ doc: K, rules: L.rules || [], instance: J }); if (!K.ke_contextmenu) { K.ke_contextmenu = 1; B.on(K, "mousedown", D.hide); M.on("sourcemode", D.hide, K); B.on(K.body, "contextmenu", function (S) { D.hide.call(this); for (var R = new I(S.target); R; ) { var N = false; if (R._4e_name() == "body") { break } for (var U = 0; U < C.length; U++) { var O = C[U].instance, Q = C[U].rules; if (K === C[U].doc && A(R[0], Q)) { S.preventDefault(); N = true; var P = S.pageX, T = S.pageY; if (!P) { U = R._4e_getOffset(); P = U.left; T = U.top } setTimeout(function () { O.show(G.Utils.getXY(P, T, K, document)) }, 30); break } } if (N) { break } R = R.parent() } }) } return J }; D.hide = function () { for (var K = 0; K < C.length; K++) { var J = C[K].instance; this === C[K].doc && J.hide() } }; var E = G.Overlay; H.augment(D, { _init: function () { var M = this, J = M.cfg, N = J.funcs; M.el = new E({ content: "<div>", autoRender: true, width: J.width, elCls: "ke-menu" }); M.elDom = M.el.get("contentEl").one("div"); J = M.elDom; for (var L in N) { var K = new I("<a href='#'>" + L + "</a>"); J[0].appendChild(K[0]); (function (P, O) { P._4e_unselectable(); P.on("click", function (Q) { Q.halt(); if (!P.hasClass("ke-menuitem-disable")) { M.hide(); setTimeout(O, 30) } }) })(K, N[L]) } }, destroy: function () { if (this.el) { this.elDom.children().detach(); this.el.destroy() } }, hide: function () { this.el && this.el.hide() }, _realShow: function (N) { G.fire("contextmenu", { contextmenu: this }); this.el.set("xy", [N.left, N.top]); N = this.cfg; var J = N.statusChecker; if (J) { for (var O = this.elDom.children("a"), M = 0; M < O.length; M++) { var L = new I(O[M]), K = J[H.trim(L.text())]; if (K) { K(N.editor) ? L.removeClass("ke-menuitem-disable") : L.addClass("ke-menuitem-disable") } } } this.el.show() }, _prepareShow: function () { this._init() }, show: function (J) { this._prepareShow(J) } }); G.ContextMenu = D } }, { attach: false, requires: ["overlay"] }); KISSY.Editor.add("draft", function (A) { var B = KISSY.Editor; A.addPlugin("draft", function () { var C = this; B.use("draft/support", function () { B.storeReady(function () { var D = new B.Draft(A); C.destroy = function () { D.destroy() } }) }) }) }, { attach: false }); KISSY.Editor.add("draft/support", function () { function D(K, M, L) { for (K += ""; K.length < M; ) { K = L + K } return K } function A(K) { if (H.isNumber(K)) { K = new Date(K) } return K instanceof Date ? [K.getFullYear(), "-", D(K.getMonth() + 1, 2, "0"), "-", D(K.getDate(), 2, "0"), " ", D(K.getHours(), 2, "0"), ":", D(K.getMinutes(), 2, "0"), ":", D(K.getSeconds(), 2, "0")].join("") : K } function I(K) { this.editor = K; this._init() } var H = KISSY, J = H.Editor, G = H.Node, B = H.Event, C = H.JSON, E = J.Utils.addRes, F = J.Utils.destroyRes; H.augment(I, { _getSaveKey: function () { var K = this.editor.cfg.pluginConfig; return K.draft && K.draft.saveKey || "ke-draft-save20110503" }, _getDrafts: function () { var K = J.localStorage; if (!this.drafts) { var M = K.getItem(this._getSaveKey()), L = []; if (M) { L = K == window.localStorage ? C.parse(decodeURIComponent(M)) : M } this.drafts = L } return this.drafts }, _init: function () { var L = this, Q = L.editor, P = Q.statusDiv, N = Q.cfg.pluginConfig; N.draft = N.draft || {}; L.draftInterval = N.draft.interval = N.draft.interval || 5; L.draftLimit = N.draft.limit = N.draft.limit || 5; P = (new G("<div class='ke-draft'><span class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf" + N.draft.interval + "\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(P); L.timeTip = (new G("<span class='ke-draft-time'/>")).appendTo(P); var M = (new G("<a class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(P), K = new J.Select({ container: P, menuContainer: document.body, doc: Q.document, width: "85px", popUpWidth: "225px", align: ["r", "t"], emptyText: "&nbsp;&nbsp;&nbsp;\u5c1a\u65e0\u7f16\u8f91\u5668\u5386\u53f2\u5b58\u5728", title: "\u6062\u590d\u7f16\u8f91\u5386\u53f2" }); L.versions = K; K.on("select", function () { K.detach("select", arguments.callee); L.sync() }); M._4e_unselectable(); M.on("click", function (R) { L.save(false); R.halt() }); E.call(L, M); Q.textarea[0].form && function () { function R() { L.save(true) } var S = Q.textarea[0].form; B.on(S, "submit", R); E.call(L, function () { B.remove(S, "submit", R) }) } (); var O = setInterval(function () { L.save(true) }, L.draftInterval * 60 * 1000); E.call(L, function () { clearInterval(O) }); K.on("click", L.recover, L); E.call(L, K); L.holder = P; if (N.draft.helpHtml) { N = new J.TripleButton({ elCls: "ke-draft-help", title: "\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9", text: "\u70b9\u51fb\u67e5\u770b\u5e2e\u52a9", render: P }); N.render(); N.on("click", function (R) { L._prepareHelp(); R && R.halt() }); E.call(L, N); J.Utils.lazyRun(L, "_prepareHelp", "_realHelp"); L.helpBtn = N.get("el") } E.call(L, P) }, _prepareHelp: function () { function L(Q) { Q && Q.halt(); Q = new G(Q.target); Q[0] == N[0] || N.contains(Q) || P._help.hide() } var P = this, O = P.editor, N = P.helpBtn, M = new G(O.cfg.pluginConfig.draft.helpHtml || ""), K = new G("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>"); M.append(K); M.css({ border: "1px solid #ACB4BE", "text-align": "left" }); P._help = new H.Overlay({ content: M, autoRender: true, width: M.width() + "px", mask: false }); P._help.get("el").css("border", "none"); P._help.arrow = K; B.on([document, O.document], "click", L); E.call(P, P._help, function () { B.remove([document, O.document], "click", L) }) }, _realHelp: function () { var K = this._help, M = this.helpBtn, L = K.arrow; K.show(); M = M.offset(); K.get("el").offset({ left: M.left - K.get("el").width() + 17, top: M.top - K.get("el").height() - 7 }); L.offset({ left: M.left - 2, top: M.top - 8 }) }, disable: function () { this.holder.css("visibility", "hidden") }, enable: function () { this.holder.css("visibility", "") }, sync: function () { var L = J.localStorage, Q = this.draftLimit, P = this.timeTip, N = this.versions, M = this._getDrafts(); M.length > Q && M.splice(0, M.length - Q); Q = []; for (var K, O = 0; O < M.length; O++) { K = M[O]; K = (K.auto ? "\u81ea\u52a8" : "\u624b\u52a8") + "\u4fdd\u5b58\u4e8e : " + A(K.date); Q.push({ name: K, value: O }) } N.set("items", Q.reverse()); P.html(K); L.setItem(this._getSaveKey(), L == window.localStorage ? encodeURIComponent(C.stringify(M)) : M) }, save: function (K) { var M = this._getDrafts(), L = this.editor.getData(true); if (L) { if (M[M.length - 1] && L == M[M.length - 1].content) { M.length -= 1 } this.drafts = M.concat({ content: L, date: (new Date).getTime(), auto: K }); this.sync() } }, recover: function (K) { var O = this.editor, N = this.versions, M = this._getDrafts(), L = K.newVal; N.reset("value"); if (confirm("\u786e\u8ba4\u6062\u590d " + A(M[L].date) + " \u7684\u7f16\u8f91\u5386\u53f2\uff1f")) { O.fire("save"); O.setData(M[L].content); O.fire("save") } K && K.halt() }, destroy: function () { F.call(this) } }); J.Draft = I }, { attach: false, requires: ["localstorage"] }); KISSY.Editor.add("dragupload", function (J) { function G(S) { S = S.originalEvent.target; if (L._4e_name(S) == "img" && S.src.match(/^file:\/\//)) { M[S.src] = S } } function D(T, S) { var U = new window.FileReader; U.onload = function (Z) { var V = T.name; Z = Z.target.result; var Y = new XMLHttpRequest; Y.open("POST", F, true); Y.onreadystatechange = function () { if (Y.readyState == 4) { if (Y.status == 200 || Y.status == 304) { if (Y.responseText != "") { var a = window.JSON.parse(Y.responseText); S[0].src = a.imgUrl } } else { alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01"); S._4e_remove(); C.log(Y) } Y.onreadystatechange = null } }; var W = "\r\n------kissy-editor-2.1\r\n"; W += 'Content-Disposition: form-data; name="' + R + '"; filename="' + encodeURIComponent(V) + '"\r\n'; W += "Content-Type: " + (T.type || "application/octet-stream") + "\r\n\r\n"; W += Z + "\r\n"; N = E.Utils.normParams(N); for (var X in N) { if (N.hasOwnProperty(X)) { W += "------kissy-editor-2.1\r\n"; W += 'Content-Disposition: form-data; name="' + X + '"\r\n\r\n'; W += N[X] + "\r\n" } } W += "------kissy-editor-2.1--"; Y.setRequestHeader("Content-Type", "multipart/form-data, boundary=----kissy-editor-2.1"); Y.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-2.1\r\nContent-Length: " + W.length + "\r\n" + W + "\r\n"); U.onload = null }; U.readAsBinaryString(T) } var C = KISSY, E = C.Editor, A = C.Node, H = C.Event, I = C.UA, L = C.DOM, O = J.cfg.pluginConfig.dragupload || {}, R = O.fileInput || "Filedata", P = O.sizeLimit || Number.MAX_VALUE, N = O.serverParams || {}, F = O.serverUrl || "", K = RegExp((O.suffix || "png,jpg,jpeg,gif").split(/,/).join("|") + "$", "i"), Q = J.document; if (!I.ie) { var M = {}, B = false; H.on(Q, "dragenter", function () { if (!B) { H.on(Q, "DOMNodeInserted", G); B = true } }); H.on(Q, "drop", function (U) { H.remove(Q, "DOMNodeInserted", G); B = false; U.halt(); U = U.originalEvent; C.log(U); var T, W; if (C.isEmptyObject(M)) { W = Q.elementFromPoint(U.clientX, U.clientY); T = W.lastChild } else { C.each(M, function (a) { if (L._4e_name(a) == "img") { T = a.nextSibling; W = a.parentNode; L._4e_remove(a) } }); M = {} } U = U.dataTransfer; U.dropEffect = "copy"; if (U = U.files) { for (var Z = 0; Z < U.length; Z++) { var S = U[Z], Y = S.size; if (S.name.match(K)) { if (!(Y / 1000 > P)) { Y = new A("<img src='" + (E.Config.base + "../theme/loading.gif") + "'/>"); var V = Y[0]; W.insertBefore(V, T); var X = L._4e_name(V.parentNode); if (X == "head" || X == "html") { L.insertBefore(V, Q.body.firstChild) } D(S, Y) } } } } }); if (window.XMLHttpRequest && !XMLHttpRequest.prototype.sendAsBinary) { XMLHttpRequest.prototype.sendAsBinary = function (U, T) { for (var V = new (window.BlobBuilder || window.WebKitBlobBuilder), X = U.length, S = new window.Uint8Array(X), W = 0; W < X; W++) { S[W] = U.charCodeAt(W) } V.append(S.buffer); this.send(V.getBlob(T)) } } } }, { attach: false }); KISSY.Editor.add("elementpaths", function (A) { var E = KISSY.Editor, C = KISSY, B = C.Node, D = C.DOM; E.ElementPaths || function () { function F(G) { this.cfg = G; this._cache = []; this._init() } D.addStyleSheet(".elementpath {   padding: 0 5px;    text-decoration: none;}.elementpath:hover {    background: #CCFFFF;    text-decoration: none;}", "ke-ElementPaths"); C.augment(F, { _init: function () { var G = this.cfg.editor; this.holder = new B("<span>"); this.holder.appendTo(G.statusDiv); G.on("selectionChange", this._selectionChange, this); E.Utils.sourceDisable(G, this) }, disable: function () { this.holder.css("visibility", "hidden") }, enable: function () { this.holder.css("visibility", "") }, _selectionChange: function (K) { var G = this.cfg.editor, I = this.holder; K = K.path.elements; var J, H; J = this._cache; for (H = 0; H < J.length; H++) { J[H].detach("click"); J[H]._4e_remove() } this._cache = []; for (H = 0; H < K.length; H++) { J = K[H]; var L = new B("<a href='#' class='elementpath'>" + (J.attr("_ke_real_element_type") || J._4e_name()) + "</a>"); this._cache.push(L); (function (M) { L.on("click", function (N) { N.halt(); G.focus(); setTimeout(function () { G.getSelection().selectElement(M) }, 50) }) })(J); I.prepend(L) } }, destroy: function () { this.holder.remove() } }); E.ElementPaths = F } (); A.addPlugin("elementpaths", function () { var F = new E.ElementPaths({ editor: A }); this.destroy = function () { F.destroy() } }) }, { attach: false }); KISSY.Editor.add("enterkey", function (D) { var A = KISSY, I = A.Editor, H = A.UA, J = /^h[1-6]$/, G = I.XHTML_DTD, B = A.Node, C = A.Event, E = I.Walker, F = I.ElementPath; I.enterBlock || function () { function K(L) { C.on(L.document, "keydown", function (N) { if (N.keyCode === 13) { if (!N.shiftKey) { L.fire("save"); var M = L.execCommand("enterBlock"); L.fire("save"); M !== false && N.preventDefault() } } }) } K.enterBlock = function (T) { var S; S = T.getSelection().getRanges(); for (var L = S.length - 1; L > 0; L--) { S[L].deleteContents() } S = S[0]; L = S.document; if (S.checkStartOfBlock() && S.checkEndOfBlock()) { var Q = (new F(S.startContainer)).block; if (Q && (Q._4e_name() == "li" || Q.parent()._4e_name() == "li")) { if (T.hasCommand("outdent")) { T.fire("save"); T.execCommand("outdent"); T.fire("save"); return true } else { return false } } } var U = S.splitBlock("p"); if (!U) { return true } T = U.previousBlock; Q = U.nextBlock; var R = U.wasStartOfBlock, V = U.wasEndOfBlock, P; if (Q) { P = Q.parent(); if (P._4e_name() == "li") { Q._4e_breakParent(P); Q._4e_move(Q._4e_next(), true) } } else { if (T && (P = T.parent()) && P._4e_name() == "li") { T._4e_breakParent(P); S.moveToElementEditablePosition(T._4e_next()); T._4e_move(T._4e_previous()) } } if (!R && !V) { if (Q._4e_name() == "li" && (P = Q._4e_first(E.invisible(true))) && A.inArray(P._4e_name(), ["ul", "ol"])) { (H.ie ? new B(L.createTextNode("\u00a0")) : new B(L.createElement("br"))).insertBefore(P) } Q && S.moveToElementEditablePosition(Q) } else { var O; if (T) { if (T._4e_name() == "li" || !J.test(T._4e_name())) { O = T._4e_clone() } } else { if (Q) { O = Q._4e_clone() } } O || (O = new B("<p>", null, L)); if (P = U.elementPath) { U = 0; for (var M = P.elements.length; U < M; U++) { var N = P.elements[U]; if (N._4e_equals(P.block) || N._4e_equals(P.blockLimit)) { break } if (G.$removeEmpty[N._4e_name()]) { N = N._4e_clone(); O._4e_moveChildren(N); O.append(N) } } } H.ie || O._4e_appendBogus(); S.insertNode(O); if (H.ie && R && (!V || !T[0].childNodes.length)) { S.moveToElementEditablePosition(V ? T : O); S.select() } S.moveToElementEditablePosition(R && !V ? Q : O) } if (!H.ie) { if (Q) { O = new B(L.createElement("span")); O.html("&nbsp;"); S.insertNode(O); O._4e_scrollIntoView(); S.deleteContents() } else { O._4e_scrollIntoView() } } S.select(); return true }; I.EnterKey = K } (); D.addCommand("enterBlock", { exec: I.EnterKey.enterBlock }); I.EnterKey(D) }, { attach: false }); KISSY.Editor.add("fakeobjects", function (D) { var A = KISSY.Editor, I = KISSY, H = I.Node, J = A.NODE, G = A.Config.base + "../theme/spacer.gif", B = A.HtmlParser; A = I.Editor; var C = D.htmlDataProcessor, E = C && C.htmlFilter, F = { elements: { $: function (K) { var N = K.attributes; if ((N = (N = (N = N && N._ke_realelement) && new B.Fragment.FromHtml(decodeURIComponent(N))) && N.children[0]) && K.attributes._ke_resizable) { var M = K.attributes.style; if (M) { var L = /(?:^|\s)width\s*:\s*(\d+)/i.exec(M); K = L && L[1]; M = (L = /(?:^|\s)height\s*:\s*(\d+)/i.exec(M)) && L[1]; if (K) { N.attributes.width = K } if (M) { N.attributes.height = M } } } return N } } }; E && E.addRules(F); C && I.mix(C, { createFakeParserElement: function (L, Q, P, N, M) { var K; K = new B.BasicWriter; L.writeHtml(K); K = K.getHtml(); var O = L.attributes.style || ""; if (L.attributes.width) { O = "width:" + L.attributes.width + "px;" + O } if (L.attributes.height) { O = "height:" + L.attributes.height + "px;" + O } L = { "class": Q, src: G, _ke_realelement: encodeURIComponent(K), _ke_real_node_type: L.type, style: O, align: L.attributes.align || "" }; M && delete M.width; M && delete M.height; M && I.mix(L, M, false); if (P) { L._ke_real_element_type = P } if (N) { L._ke_resizable = N } return new B.Element("img", L) } }); D.createFakeElement || I.augment(A, { createFakeElement: function (L, Q, P, N, M, K) { var O = L.attr("style") || ""; if (L.attr("width")) { O = "width:" + L.attr("width") + "px;" + O } if (L.attr("height")) { O = "height:" + L.attr("height") + "px;" + O } L = { "class": Q, src: G, _ke_realelement: encodeURIComponent(M || L._4e_outerHtml()), _ke_real_node_type: L[0].nodeType, style: O }; K && delete K.width; K && delete K.height; K && I.mix(L, K, false); if (P) { L._ke_real_element_type = P } if (N) { L._ke_resizable = N } return new H("<img/>", L, this.document) }, restoreRealElement: function (K) { if (K.attr("_ke_real_node_type") != J.NODE_ELEMENT) { return null } K = decodeURIComponent(K.attr("_ke_realelement")); var L = new H("<div>", null, this.document); L.html(K); return L._4e_first(function (M) { return M[0].nodeType == J.NODE_ELEMENT })._4e_remove() } }) }, { attach: false, requires: ["htmldataprocessor"] }); KISSY.Editor.add("flash", function (A) { var E = KISSY.Editor, C = A.htmlDataProcessor, B = A.cfg.pluginConfig, D = C && C.dataFilter; D && D.addRules({ elements: { object: function (F) { var G = F.attributes; if (!(G.classid && String(G.classid).toLowerCase())) { for (G = 0; G < F.children.length; G++) { if (F.children[G].name == "embed") { if (!E.Utils.isFlashEmbed(F.children[G])) { break } return C.createFakeParserElement(F, "ke_flash", "flash", true) } } return null } return C.createFakeParserElement(F, "ke_flash", "flash", true) }, embed: function (F) { if (!E.Utils.isFlashEmbed(F)) { return null } return C.createFakeParserElement(F, "ke_flash", "flash", true) } } }, 5); A.addPlugin("flash", function () { var F; if (!B.flash || B.flash.btn !== false) { F = A.addButton("flash", { contentCls: "ke-toolbar-flash", title: "\u63d2\u5165Flash", mode: E.WYSIWYG_MODE, loading: true }) } E.use("flash/support", function () { var G = new E.Flash(A); F && F.reload({ offClick: function () { G.show() }, destroy: function () { G.destroy() } }) }); this.destroy = function () { F.destroy() } }) }, { attach: false, requires: ["fakeobjects"] }); KISSY.Editor.add("flash/support", function () { function D(M) { this.editor = M; this._init() } function A(M) { return M._4e_name() === "img" && !!M.hasClass(F) && M } var K = KISSY, J = K.Editor, L = K.UA, I = K.Event, B = J.ContextMenu, C = K.Node, E = J.BubbleView, F = "ke_flash", H = J.Utils.flash; K.augment(D, { _config: function () { this._cls = F; this._type = "flash"; this._contextMenu = G; this._flashRules = ["img." + F] }, _init: function () { this._config(); var Q = this, O = Q.editor, N = {}, M = Q._contextMenu; if (M) { for (var P in M) { (function (R) { N[R] = function () { M[R](Q) } })(P) } } Q._contextMenu = B.register({ editor: O, rules: Q._flashRules, width: "120px", funcs: N }); E.attach({ pluginName: Q._type, editor: Q.editor, pluginContext: Q }); I.on(O.document, "dblclick", Q._dbclick, Q) }, _getFlashUrl: function (M) { return H.getUrl(M) }, _updateTip: function (O, N) { var M = this.editor.restoreRealElement(N); if (M) { M = this._getFlashUrl(M); O.html(M); O.attr("href", M) } }, _dbclick: function (N) { var M = new C(N.target); if (M._4e_name() === "img" && M.hasClass(this._cls)) { this.show(null, M); N.halt() } }, show: function (N, M) { this.editor.useDialog(this._type + "/dialog", function (O) { O.show(M) }) }, destroy: function () { var M = this.editor; this._contextMenu.destroy(); E.destroy(this._type); I.remove(M.document, "dblclick", this._dbclick, this); M.destroyDialog(this._type + "/dialog") } }); J.Flash = D; D.registerBubble = function (O, N, M) { E.register({ pluginName: O, func: M, init: function () { var P = this, T = P.get("contentEl"); T.html(N + ' <a class="ke-bubbleview-url" target="_blank" href="#"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>'); var Q = T.one(".ke-bubbleview-url"), S = T.one(".ke-bubbleview-change"), R = T.one(".ke-bubbleview-remove"); J.Utils.preventFocus(T); S.on("click", function (U) { P._plugin.show(null, P._selectedEl); U.halt() }); R.on("click", function (V) { var W = P._plugin; if (L.webkit) { var U = W.editor.getSelection().getRanges(); U && U[0] && (U[0].collapse(true) || 1) && U[0].select() } P._selectedEl._4e_remove(); P.hide(); W.editor.notifySelectionChange(); V.halt() }); J.Utils.addRes.call(P, S, R); P.on("show", function () { var U = P._selectedEl; U && P._plugin._updateTip(Q, U) }) } }) }; D.registerBubble("flash", "Flash \u7f51\u5740\uff1a ", A); D.checkFlash = A; var G = { "Flash\u5c5e\u6027": function (N) { var M = N.editor.getSelection(); M = M && M.getStartElement(); (M = A(M)) && N.show(null, M) } }; D.CLS_FLASH = F; D.TYPE_FLASH = "flash"; D.Insert = function (S, Q, P, M, R, N) { Q = H.createSWF(Q, { attrs: P }, S.document); var O = Q.el; P = S.createFakeElement ? S.createFakeElement(O, M || "ke_flash", R || "flash", true, Q.html, P) : O; S.insertElement(P, null, N) }; J.Flash = D }, { attach: false, requires: ["bubbleview", "contextmenu", "flashutils"] }); KISSY.Editor.add("flashbridge", function () { function D(K) { this._init(K) } function A(K) { var L = H.isString(K) ? K.match(/(\d)+/g) : K; K = K; if (H.isArray(L)) { K = parseFloat(L[0] + "." + I(L[1], 3) + I(L[2], 5)) } return K || 0 } function I(K, M) { for (var L = (K + "").length; L++ < M; ) { K = "0" + K } return K } var H = KISSY, J = H.Editor; if (J.FlashBridge) { H.log("KE.FlashBridge attach more", "warn") } else { var G = {}; H.augment(D, H.EventTarget, { _init: function (K) { var N = H.guid("flashbridge-"); K.flashVars = K.flashVars || {}; K.attrs = K.attrs || {}; K.params = K.params || {}; var M = K.flashVars, L = K.params; H.mix(K.attrs, { id: N, width: "100%", height: "100%" }, false); H.mix(L, { allowScriptAccess: "always", allowNetworking: "all", scale: "noScale" }, false); H.mix(M, { shareData: false, useCompression: false }, false); L = { YUISwfId: N, YUIBridgeCallback: "KISSY.Editor.FlashBridge.EventHandler" }; if (K.ajbridge) { L = { swfID: N, jsEntry: "KISSY.Editor.FlashBridge.EventHandler"} } H.mix(M, L); G[N] = this; this.id = N; this.swf = J.Utils.flash.createSWFRuntime(K.movie, K); this._expose(K.methods) }, _expose: function (K) { for (var M = this, L = 0; L < K.length; L++) { (function (N) { M[N] = function () { return M._callSWF(N, H.makeArray(arguments)) } })(K[L]) } }, _callSWF: function (K, N) { N = N || []; try { if (this.swf[K]) { return this.swf[K].apply(this.swf, N) } } catch (M) { var L = ""; if (N.length !== 0) { L = "'" + N.join("', '") + "'" } return (new Function("self", "return self.swf." + K + "(" + L + ");"))(this) } }, _eventHandler: function (K) { var L = K.type; if (L === "log") { H.log(K.message) } else { L && this.fire(L, K) } }, _destroy: function () { delete G[this.id] } }); D.EventHandler = function (K, M) { H.log("flash fire event : " + M.type); var L = G[K]; L && setTimeout(function () { L._eventHandler.call(L, M) }, 100) }; J.FlashBridge = D; var B = H.UA, C, E, F = true; B.fpv = function (K) { if (K || F) { F = false; var M; if (navigator.plugins && navigator.mimeTypes.length) { M = (navigator.plugins["Shockwave Flash"] || {}).description } else { if (window.ActiveXObject) { try { M = (new ActiveXObject("ShockwaveFlash.ShockwaveFlash")).GetVariable("$version") } catch (L) { } } } C = M ? M.match(/(\d)+/g) : void 0; E = A(C) } return C }; B.fpvGEQ = function (K, L) { F && B.fpv(L); return !!E && E >= A(K) } } }, { attach: false }); KISSY.Editor.add("flashutils", function () { var B = KISSY, F = B.Editor, D = F.Utils.flash; if (D) { B.log("flashUtils attach more") } else { var C = B.DOM, E = B.Node, A = B.UA; D = { getUrl: function (J) { var G = "", H = F.NODE; if (J._4e_name() == "object") { J = J[0].childNodes; for (var I = 0; I < J.length; I++) { if (J[I].nodeType == H.NODE_ELEMENT) { if ((C.attr(J[I], "name") || "").toLowerCase() == "movie") { G = C.attr(J[I], "value") } else { if (C._4e_name(J[I]) == "embed") { G = C.attr(J[I], "src") } else { if (C._4e_name(J[I]) == "object") { G = C.attr(J[I], "data") } } } } } } else { if (J._4e_name() == "embed") { G = J.attr("src") } } return G }, createSWF: function (H, I, K) { var N = I.attrs || {}, Q = I.flashVars, O = "", M = ""; I = I.params || {}; var G = ""; K = K || document; B.mix(N, { wmode: "transparent" }); for (var J in N) { if (N.hasOwnProperty(J)) { O += J + "='" + N[J] + "' " } } B.mix(I, { quality: "high", movie: H, wmode: "transparent" }); for (var P in I) { if (I.hasOwnProperty(P)) { M += "<param name='" + P + "' value='" + I[P] + "'/>" } } if (Q) { for (var L in Q) { if (Q.hasOwnProperty(L)) { G += "&" + L + "=" + encodeURIComponent(Q[L]) } } G = G.substring(1) } H = "<object " + O + ' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >' + M + (G ? '<param name="flashVars" value="' + G + '"/>' : "") + "<embed " + O + " " + (G ? 'FlashVars="' + G + '"' : "") + ' pluginspage="http://www.macromedia.com/go/getflashplayer"  quality="high"  src="' + H + '"  type="application/x-shockwave-flash"/></object>'; return { el: new E(H, null, K), html: H} }, createSWFRuntime2: function (J, G, H) { H = H || document; var I = (new E("<div style='width:0;height:0;overflow:hidden;'>", null, H)).appendTo(H.body); I = D.createSWF.apply(this, arguments).el.appendTo(I); A.ie || (I = I.one("object")); return I[0] }, createSWFRuntime: function (H, I, L) { var O = I.attrs || {}, R = I.flashVars || {}, P = I.params || {}, N = "", G = "", K = ""; L = L || document; O.id = O.id || B.guid("ke-runtimeflash-"); for (var Q in O) { if (O.hasOwnProperty(Q)) { N += Q + "='" + O[Q] + "' " } } for (var M in P) { if (P.hasOwnProperty(M)) { G += "<param name='" + M + "' value='" + P[M] + "'/>" } } for (var S in R) { if (R.hasOwnProperty(S)) { K += "&" + S + "=" + encodeURIComponent(R[S]) } } K = K.substring(1); H = A.ie ? "<object " + N + ' classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" >' + G + '<param name="movie" value="' + H + '" />' + (K ? '<param name="flashVars" value="' + K + '" />' : "") + "</object>" : "<object type='application/x-shockwave-flash' data='" + H + "' " + N + ">" + G + (K ? '<param name="flashVars" value="' + K + '"/>' : "") + "</object>"; var J = I.holder; if (!J) { J = (new E("<div style='" + (I.style ? I.style : "width:1px;height:1px;position:absolute;" + +"overflow:hidden;") + "'>", null, L)).appendTo(L.body); setTimeout(function () { J.offset({ left: C.scrollLeft(), top: C.scrollTop() }) }, 100) } J.html(H); return L.getElementById(O.id) } }; F.Utils.flash = D } }, { attach: false }); KISSY.Editor.add("font", function (A) { A.addPlugin("font", function () { function H(T) { for (var U = [], V = 0; V < T.length; V++) { U.push({ name: T[V], value: T[V] }) } return U } var E = KISSY, D = E.Editor, F = D.Style, B = D.TripleButton, I = A.cfg.pluginConfig, J = I["font-size"], M, P, S, Q = []; if (J !== false) { J = J || {}; E.mix(J, { items: H(["8px", "10px", "12px", "14px", "18px", "24px", "36px", "48px", "60px", "72px", "84px", "96px"]), width: "55px" }, false); var O = {}, G = [], L = { element: "span", styles: { "font-size": "#(size)" }, overrides: [{ element: "font", attributes: { size: null}}] }; for (K = 0; K < J.items.length; K++) { M = J.items[K]; P = M.name; S = M.attrs; M = M.value; O[M] = new F(L, { size: M }); G.push({ name: P, value: M, attrs: S }) } I["font-size"] = J } L = I["font-family"]; if (L !== false) { L = L || {}; E.mix(L, { items: [{ name: "\u5b8b\u4f53", value: "SimSun" }, { name: "\u9ed1\u4f53", value: "SimHei" }, { name: "\u96b6\u4e66", value: "LiSu" }, { name: "\u6977\u4f53", value: "KaiTi_GB2312" }, { name: "\u5fae\u8f6f\u96c5\u9ed1", value: "Microsoft YaHei" }, { name: "Georgia", value: "Georgia" }, { name: "Times New Roman", value: "Times New Roman" }, { name: "Impact", value: "Impact" }, { name: "Courier New", value: "Courier New" }, { name: "Arial", value: "Arial" }, { name: "Verdana", value: "Verdana" }, { name: "Tahoma", value: "Tahoma"}], width: "130px" }, false); var R = {}, N = [], C = { element: "span", styles: { "font-family": "#(family)" }, overrides: [{ element: "font", attributes: { face: null}}] }, K; I["font-family"] = L; for (K = 0; K < L.items.length; K++) { M = L.items[K]; P = M.name; S = M.attrs || {}; M = M.value; S.style = S.style || ""; S.style += ";font-family:" + M; R[M] = new F(C, { family: M }); N.push({ name: P, value: M, attrs: S }) } } P = { click: function (T) { var U = T.newVal; T = T.prevVal; var V = this.cfg.styles; A.focus(); A.fire("save"); V = V[U]; if (U == T) { V.remove(A.document); this.btn.set("value", "") } else { V.apply(A.document) } A.fire("save") }, selectionChange: function (U) { U = U.path.elements; for (var V = this.cfg.styles, X = 0, T; X < U.length; X++) { T = U[X]; for (var W in V) { if (V[W].checkElementRemovable(T, true)) { this.btn.set("value", W); return } } } this.btn.reset("value") } }; false !== I["font-size"] && Q.push(A.addSelect("font-size", E.mix({ title: "\u5927\u5c0f", width: "30px", mode: D.WYSIWYG_MODE, showValue: true, popUpWidth: J.width, items: G, styles: O }, P))); false !== I["font-family"] && Q.push(A.addSelect("font-family", E.mix({ title: "\u5b57\u4f53", width: "110px", mode: D.WYSIWYG_MODE, popUpWidth: L.width, items: N, styles: R }, P))); D = { mode: D.WYSIWYG_MODE, offClick: function () { var T = this.editor, U = this.cfg.style; T.fire("save"); U.apply(T.document); T.fire("save"); T.notifySelectionChange(); T.focus() }, onClick: function () { var T = this.editor, U = this.cfg.style; T.fire("save"); U.remove(T.document); T.fire("save"); T.notifySelectionChange(); T.focus() }, selectionChange: function (T) { var U = this.btn; this.cfg.style.checkActive(T.path) ? U.set("state", B.ON) : U.set("state", B.OFF) } }; false !== I["font-bold"] && Q.push(A.addButton("font-bold", E.mix({ contentCls: "ke-toolbar-bold", title: "\u7c97\u4f53 ", style: new F({ element: "strong", overrides: [{ element: "b" }, { element: "span", attributes: { style: "font-weight: bold;"}}] }) }, D))); false !== I["font-italic"] && Q.push(A.addButton("font-italic", E.mix({ contentCls: "ke-toolbar-italic", title: "\u659c\u4f53 ", style: new F({ element: "em", overrides: [{ element: "i" }, { element: "span", attributes: { style: "font-style: italic;"}}] }) }, D))); false !== I["font-underline"] && Q.push(A.addButton("font-underline", E.mix({ contentCls: "ke-toolbar-underline", title: "\u4e0b\u5212\u7ebf ", style: new F({ element: "u", overrides: [{ element: "span", attributes: { style: "text-decoration: underline;"}}] }) }, D))); if (false !== I["font-strikeThrough"]) { Q.push(A.addButton("font-underline", E.mix({ contentCls: "ke-toolbar-strikeThrough", title: "\u5220\u9664\u7ebf ", style: new F((I["font-strikeThrough"] || {}).style || { element: "del", overrides: [{ element: "span", attributes: { style: "text-decoration: line-through;"} }, { element: "s" }, { element: "strike"}] }) }, D))) } this.destroy = function () { for (var T = 0; T < Q.length; T++) { Q[T].destroy() } } }) }, { attach: false }); KISSY.Editor.add("format", function (A) { A.addPlugin("format", function () { var H = KISSY.Editor, E = [], D = { "\u666e\u901a\u6587\u672c": "p", "\u6807\u98981": "h1", "\u6807\u98982": "h2", "\u6807\u98983": "h3", "\u6807\u98984": "h4", "\u6807\u98985": "h5", "\u6807\u98986": "h6" }, F = { p: "1em", h1: "2em", h2: "1.5em", h3: "1.17em", h4: "1em", h5: "0.83em", h6: "0.67em" }, C = {}, I = H.Style, B; for (B in D) { if (D[B]) { C[D[B]] = new I({ element: D[B] }); E.push({ name: B, value: D[B], attrs: { style: "font-size:" + F[D[B]]} }) } } var G = A.addSelect("font-family", { items: E, title: "\u6807\u9898", width: "100px", mode: H.WYSIWYG_MODE, popUpWidth: "120px", click: function (K) { var J = K.newVal; K = K.prevVal; A.fire("save"); if (J != K) { C[J].apply(A.document) } else { C.p.apply(A.document); this.btn.set("value", "p") } A.fire("save") }, selectionChange: function (K) { K = K.path; for (var J in C) { if (C[J].checkActive(K)) { this.btn.set("value", J); break } } } }); this.destroy = function () { G.destroy() } }) }, { attach: false }); KISSY.Editor.add("htmldataprocessor", function (E) { function B(Q) { return Q.replace(A, function (R, T, S) { return "<" + T + S.replace(F, function (U, V) { if (S.indexOf("_ke_saved_" + V) == -1) { return " _ke_saved_" + U + " " + U } return U }) + ">" }) } var O = O, N = KISSY, P = N.Editor, M = N.Node, C = N.UA, D = P.NODE, G = P.HtmlParser, I = new G.Filter, L = new G.Filter, J = new G.Filter, H = P.XHTML_DTD; if (!E.htmlDataProcessor) { (function () { var R = P.HtmlParser.Fragment.prototype, Q = P.HtmlParser.Element.prototype; R.onlyChild = Q.onlyChild = function () { var S = this.children; return S.length == 1 && S[0] || null }; Q.removeAnyChildWithName = function (U) { for (var T = this.children, V = [], W, S = 0; S < T.length; S++) { W = T[S]; if (W.name) { if (W.name == U) { V.push(W); T.splice(S--, 1) } V = V.concat(W.removeAnyChildWithName(U)) } } return V }; Q.getAncestor = function (T) { for (var S = this.parent; S && !(S.name && S.name.match(T)); ) { S = S.parent } return S }; R.firstChild = Q.firstChild = function (T) { for (var S, U = 0; U < this.children.length; U++) { S = this.children[U]; if (T(S)) { return S } else { if (S.name) { if (S = S.firstChild(T)) { return S } } } } return null }; Q.addStyle = function (U, T, V) { var W = ""; if (typeof T == "string") { W += U + ":" + T + ";" } else { if (typeof U == "object") { for (var S in U) { if (U.hasOwnProperty(S)) { W += S + ":" + U[S] + ";" } } } else { W += U } V = T } if (!this.attributes) { this.attributes = {} } U = this.attributes.style || ""; U = (V ? [W, U] : [U, W]).join(";"); this.attributes.style = U.replace(/^;|;(?=;)/, "") }; H.parentOf = function (T) { var S = {}, U; for (U in this) { if (U.indexOf("$") == -1 && this[U][T]) { S[U] = 1 } } return S } })(); (function () { function X(c) { if (/mso-list\s*:\s*Ignore/i.test(c.attributes && c.attributes.style || "")) { return true } return O } function a(e, d) { var f = new P.HtmlParser.Element("ke:listbullet"), c; if (e) { if (e[2]) { e = isNaN(e[1]) ? /^[a-z]+$/.test(e[1]) ? "lower-alpha" : /^[A-Z]+$/.test(e[1]) ? "upper-alpha" : "decimal" : "decimal"; c = "ol" } else { e = /[l\u00B7\u2002]/.test(e[1]) ? "disc" : /[\u006F\u00D8]/.test(e[1]) ? "circle" : /[\u006E\u25C6]/.test(e[1]) ? "square" : "disc"; c = "ul" } } else { e = "decimal"; c = "ol" } f.attributes = { "ke:listtype": c, style: "list-style-type:" + e + ";" }; f.add(new P.HtmlParser.Text(d)); return f } function W(d) { var c = d.attributes, e; if ((e = d.removeAnyChildWithName("ke:listbullet")) && e.length && (e = e[0])) { d.name = "ke:li"; if (c.style) { c.style = V([["text-indent"], ["line-height"], [/^margin(:?-left)?$/, null, function (f) { f = f.split(" "); f = f[3] || f[1] || f[0]; f = parseInt(f, 10); if (!Z && Y && f > Y) { Z = f - Y } c["ke:margin"] = Y = f } ]], O)(c.style, d) || "" } e = e.attributes; d.addStyle(e.style); N.mix(c, e); return true } return false } function V(d, c) { return function (h, e) { var g = []; String(h).replace(/&quot;/g, '"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g, function (n, j, m) { j = j.toLowerCase(); j == "font-family" && (m = m.replace(/["']/g, "")); for (var l, k, o, i = 0; i < d.length; i++) { if (d[i]) { n = d[i][0]; l = d[i][1]; k = d[i][2]; o = d[i][3]; if (j.match(n) && (!l || m.match(l))) { j = o || j; c && (k = k || m); if (typeof k == "function") { k = k(m, e, j) } if (k && k.push) { j = k[0]; k = k[1] } typeof k == "string" && g.push([j, k]); return } } } !c && g.push([j, m]) }); for (var f = 0; f < g.length; f++) { g[f] = g[f].join(":") } return g.length ? g.join(";") + ";" : false } } function R(j) { j = j.children; for (var c, d, l, i, h, g, k, f = 0; f < j.length; f++) { c = j[f]; if ("ke:li" == c.name) { c.name = "li"; c = c; d = c.attributes; l = c.attributes["ke:listtype"]; i = parseInt(d["ke:indent"], 10) || Z && Math.ceil(d["ke:margin"] / Z) || 1; d.style && (d.style = V([["list-style-type", l == "ol" ? "decimal" : "disc"]], O)(d.style) || ""); if (g) { if (i > k) { g = new P.HtmlParser.Element(l); g.add(c); h.add(g) } else { if (i < k) { h = k - i; for (var e; h-- && (e = g.parent); ) { g = e.parent } } g.add(c) } j.splice(f--, 1) } else { g = new P.HtmlParser.Element(l); g.add(c); j[f] = g } h = c; k = i } else { g = null } } Z = 0 } var T = V([[/mso/i], [/w:WordDocument/i], [/^-ms/i], [/^-moz/i], [/^-webkit/i], [/display/i, /none/i]], O), Z, Y = 0, b = H.parentOf("ol"), Q = { elementNames: [[/^script$/i, ""], [/^iframe$/i, ""], [/^style$/i, ""], [/^link$/i, ""], [/^meta$/i, ""], [/^\?xml.*$/i, ""], [/^.*namespace.*$/i, ""]], root: function (c) { c.filterChildren(); R(c) }, elements: { p: function (c) { c.filterChildren(); if (W(c)) { return O } }, $: function (d) { var c = d.name || ""; if (c.indexOf(":") != -1 && !/^ke/.test(c)) { if (c == "v:imagedata") { if (d.attributes["o:href"]) { d.attributes.src = d.attributes["o:href"]; delete d.attributes["o:href"] } if (c = d.attributes["o:title"]) { d.attributes.title = c; delete d.attributes["o:title"] } d.name = "img"; return } delete d.name } if (c in b) { d.filterChildren(); R(d) } }, span: function (d) { if (!C.gecko && X(d.parent)) { return false } if (!C.gecko && X(d)) { d = (d = d.firstChild(function (e) { return e.value || e.name == "img" })) && (d.value || "l."); var c = d.match(/^([^\s]+?)([.)]?)$/); return a(c, d) } } }, attributes: { "class": function (c) { if (/(^|\s+)Mso/.test(c)) { return false } return c }, style: function (c) { c = T(c); if (!c) { return false } return c } }, attributeNames: [[/^on/, "ke_on"], [/^lang$/, ""]] }, U = { comment: !C.ie ? function (e, d) { var f = e.match(/<img.*?>/), c = e.match(/^\[if !supportLists\]([\s\S]*?)\[endif\]$/); if (c) { c = (f = c[1] || f && "l.") && f.match(/>([^\s]+?)([.)]?)</); return a(c, f) } if (C.gecko && f) { f = P.HtmlParser.Fragment.FromHtml(f[0]).children[0]; (c = (c = (c = d.previous) && c.value.match(/<v:imagedata[^>]*o:href=['"](.*?)['"]/)) && c[1]) && (f.attributes.src = c); return f } return false } : function () { return false } }, S = { elementNames: [[/^ke:/, ""], [/^\?xml:namespace$/, ""]], elements: { $: function (f) { var e = f.attributes; if (e) { for (var g = ["name", "href", "src"], c, d = 0; d < g.length; d++) { c = "_ke_saved_" + g[d]; c in e && delete e[g[d]] } } return f }, embed: function (d) { var c = d.parent; if (c && c.name == "object") { var e = c.attributes.width; c = c.attributes.height; e && (d.attributes.width = e); c && (d.attributes.height = c) } }, param: function (c) { c.children = []; c.isEmpty = true; return c }, a: function (c) { if (!(c.children.length || c.attributes.name || c.attributes._ke_saved_name)) { return false } }, td: function (d) { d = d.children; if (!d.length) { var c = new P.HtmlParser.Text("&nbsp;"); d.push(c) } }, span: function (c) { if (!c.children.length && N.isEmptyObject(c.attributes)) { return false } } }, attributes: { style: function (c) { if (!N.trim(c)) { return false } } }, attributeNames: [[/^_ke_saved_/, ""], [/^ke_on/, "on"], [/^_ke.*/, ""], [/^_ks.*/, ""], [/^ke:.*$/, ""]], comment: function (c) { if (c.substr(0, K.length) == K) { c = c.substr(K.length, 3) == "{C}" ? c.substr(K.length + 3) : c.substr(K.length); return new P.HtmlParser.cdata(decodeURIComponent(c)) } return c } }; if (C.ie) { S.attributes.style = function (c) { return c.toLowerCase() } } I.addRules(S); L.addRules(Q); J.addRules(Q); J.addRules(U) })(); (function () { function V(b) { for (var a = b.children.length, c = b.children[a - 1]; c && c.type == D.NODE_TEXT && !N.trim(c.value); ) { c = b.children[--a] } return c } function Y(b) { var a = V(b); return !a || a.type == D.NODE_ELEMENT && a.name == "br" || b.name == "form" && a.name == "input" } function U(b, a) { var d = b.children, c = V(b); if (c) { if ((a || !C.ie) && c.type == D.NODE_ELEMENT && c.name == "br") { d.pop() } c.type == D.NODE_TEXT && S.test(c.value) && d.pop() } } function T(a) { U(a, true); if (Y(a)) { if (C.ie) { a.add(new P.HtmlParser.Text("\u00a0")) } else { a.add(new P.HtmlParser.Text("&nbsp;")); a.add(new P.HtmlParser.Element("br", {})) } } } function R(a) { U(a, false); Y(a) && a.add(new P.HtmlParser.Text("\u00a0")) } var S = /^[\t\r\n ]*(?:&nbsp;|\xa0)$/, X = P.XHTML_DTD, W = P.Utils.mix({}, X.$block, X.$listItem, X.$tableContent), Z; for (Z in W) { "br" in X[Z] || delete W[Z] } delete W.pre; X = { elements: {} }; var Q = { elements: {} }; for (Z in W) { X.elements[Z] = T; Q.elements[Z] = R } L.addRules(X); I.addRules(Q); J.addRules(X) })(); (function () { I.addRules({ text: function (Q) { return Q.replace(/\xa0/g, "&nbsp;") } }) })(); var A = /<(a|area|img|input)\b([^>]*)>/gi, F = /\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi, K = "{ke_protected}"; E.htmlDataProcessor = { wordFilter: J, dataFilter: L, htmlFilter: I, toHtml: function (S, Q) { var R = new G.HtmlWriter; G.Fragment.FromHtml(S, Q).writeHtml(R, I); return R.getHtml(true) }, toDataFormat: function (T, Q, S) { S = S || L; if (C.gecko) { T = T.replace(/(<!--\[if[^<]*?\])--\>([\S\s]*?)<!--(\[endif\]--\>)/gi, "$1$2$3") } T = B(T); var R = new M("<div>"); R.html("a" + T); T = R.html().substr(1); R = new G.BasicWriter; T = G.Fragment.FromHtml(T, Q); R.reset(); T.writeHtml(R, S); return T = R.getHtml(true) }, toServer: function (S, Q) { var R = new G.BasicWriter; G.Fragment.FromHtml(S, Q).writeHtml(R, I); return R.getHtml(true) } } } }, { attach: false }); KISSY.Editor.add("image", function (A) { A.addPlugin("image", function () { var B = KISSY, J = B.Editor, I = B.UA, K = B.Node, H = B.Event, C = function (L) { return L._4e_name() === "img" && !/(^|\s+)ke_/.test(L[0].className) && L }, D = {}, E = J.Utils.addRes, F = J.Utils.destroyRes, G = A.addButton("image", { contentCls: "ke-toolbar-image", title: "\u63d2\u5165\u56fe\u7247", mode: J.WYSIWYG_MODE, offClick: function () { this.call("show") }, _updateTip: function (N, M) { var L = M.attr("_ke_saved_src") || M.attr("src"); N.html(L); N.attr("href", L) }, show: function (M, L) { this.editor.useDialog("image/dialog", function (N) { N.show(L) }) } }); E.call(D, G, function () { A.destroyDialog("image/dialog") }); J.use("contextmenu", function () { function O(P) { var Q = new K(P.target); P.halt(); C(Q) && G.call("show", null, Q) } var N = { "\u56fe\u7247\u5c5e\u6027": function (P) { P = (P = P.getSelection()) && P.getStartElement(); (P = C(P)) && G.call("show", null, P) } }; H.on(A.document, "dblclick", O); E.call(D, function () { H.remove(A.document, "dblclick", O) }); var M = {}, L; for (L in N) { (function (P) { M[P] = function () { N[P](A) } })(L) } L = J.ContextMenu.register({ editor: A, rules: [C], width: "120px", funcs: M }); E.call(D, L) }); J.use("bubbleview", function () { J.BubbleView.register({ pluginName: "image", pluginContext: G, editor: A, func: C, init: function () { var P = this, O = P.get("contentEl"); O.html('\u56fe\u7247\u7f51\u5740\uff1a   <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>'); var N = O.one(".ke-bubbleview-url"), M = O.one(".ke-bubbleview-change"), L = O.one(".ke-bubbleview-remove"); J.Utils.preventFocus(O); M.on("click", function (Q) { P._plugin.call("show", null, P._selectedEl); Q.halt() }); L.on("click", function (S) { var Q = P._plugin; if (I.webkit) { var R = Q.editor.getSelection().getRanges(); R && R[0] && (R[0].collapse(true) || 1) && R[0].select() } P._selectedEl._4e_remove(); P.hide(); Q.editor.notifySelectionChange(); S.halt() }); J.Utils.addRes.call(P, M, L); P.on("show", function () { var Q = P._selectedEl; Q && P._plugin.call("_updateTip", N, Q) }) } }); E.call(D, function () { J.BubbleView.destroy("image") }) }); this.destroy = function () { F.call(D) } }) }, { attach: false }); KISSY.Editor.add("indent", function (A) { A.addPlugin("indent", function () { var D = KISSY.Editor, C = A.addButton("outdent", { title: "\u51cf\u5c11\u7f29\u8fdb\u91cf ", mode: D.WYSIWYG_MODE, contentCls: "ke-toolbar-outdent", type: "outdent", loading: true }), B = A.addButton("indent", { title: "\u589e\u52a0\u7f29\u8fdb\u91cf ", mode: D.WYSIWYG_MODE, contentCls: "ke-toolbar-indent", type: "indent", loading: true }); D.use("indent/support", function () { C.reload(D.IndentSupport); B.reload(D.IndentSupport) }); A.addCommand("indent", { exec: function () { B.call("offClick") } }); A.addCommand("outdent", { exec: function () { C.call("offClick") } }); this.destroy = function () { C.destroy(); B.destroy() } }) }, { attach: false }); KISSY.Editor.add("indent/support", function () { function E(O) { this.type = O; this.indentCssProperty = "margin-left"; this.indentOffset = 40; this.indentUnit = "px" } function B(O) { return O[0].nodeType == I.NODE_ELEMENT && O._4e_name() == "li" } function M(S, V) { for (var T = S.startContainer, X = S.endContainer; T && !T.parent()._4e_equals(V); ) { T = T.parent() } for (; X && !X.parent()._4e_equals(V); ) { X = X.parent() } if (T && X) { var R = T; T = []; for (var Q = false; !Q; ) { if (R._4e_equals(X)) { Q = true } T.push(R); R = R.next() } if (!(T.length < 1)) { R = V._4e_parents(true); for (X = 0; X < R.length; X++) { if (K[R[X]._4e_name()]) { V = R[X]; break } } R = this.type == "indent" ? 1 : -1; X = T[0]; Q = T[T.length - 1]; T = {}; var O = N.ListUtils.listToArray(V, T), P = O[Q.data("listarray_index")].indent; for (X = X.data("listarray_index"); X <= Q.data("listarray_index"); X++) { O[X].indent += R; var W = O[X].parent; O[X].parent = new H(W[0].ownerDocument.createElement(W._4e_name())) } for (X = Q.data("listarray_index") + 1; X < O.length && O[X].indent > P; X++) { O[X].indent += R } Q = N.ListUtils.arrayToList(O, T, null, "p", 0); R = []; if (this.type == "outdent") { var U; if ((U = V.parent()) && U._4e_name() == "li") { O = Q.listNode.childNodes; var Y; for (X = O.length - 1; X >= 0; X--) { if ((Y = new H(O[X])) && Y._4e_name() == "li") { R.push(Y) } } } } if (Q) { F.insertBefore(Q.listNode[0] || Q.listNode, V[0] || V); V._4e_remove() } if (R && R.length) { for (X = 0; X < R.length; X++) { for (Q = Y = R[X]; (Q = Q.next()) && Q._4e_name() in K; ) { J.ie && !Y._4e_first(function (Z) { return G(Z) && A(Z) }) && Y[0].appendChild(S.document.createTextNode("\u00a0")); Y[0].appendChild(Q[0]) } F.insertAfter(Y[0], U[0]) } } N.Utils.clearAllMarkers(T) } } } function L(P) { var O = parseInt(P._4e_style(this.indentCssProperty), 10); if (isNaN(O)) { O = 0 } O += (this.type == "indent" ? 1 : -1) * this.indentOffset; if (O < 0) { return false } O = Math.max(O, 0); O = Math.ceil(O / this.indentOffset, undefined) * this.indentOffset; P.css(this.indentCssProperty, O ? O + this.indentUnit : ""); P[0].style.cssText === "" && P.removeAttr("style"); return true } var N = KISSY.Editor, K = { ol: 1, ul: 1 }, C = KISSY, D = N.Walker, F = C.DOM, H = C.Node, J = C.UA, I = N.NODE, G = D.whitespaces(true), A = D.bookmark(false, true); C.augment(E, { exec: function (S) { for (var O = (S = S.getSelection()) && S.getRanges()[0], T = O.startContainer, P = O.endContainer, R = O.getCommonAncestor(); R && !(R[0].nodeType == I.NODE_ELEMENT && K[R._4e_name()]); ) { R = R.parent() } if (R && T[0].nodeType == I.NODE_ELEMENT && T._4e_name() in K) { T = new D(O); T.evaluator = B; O.startContainer = T.next() } if (R && P[0].nodeType == I.NODE_ELEMENT && P._4e_name() in K) { T = new D(O); T.evaluator = B; O.endContainer = T.previous() } P = S.createBookmarks(true); if (R) { for (T = R._4e_first(); T && T._4e_name() != "li"; ) { T = T.next() } var Q = O.startContainer; (T[0] == Q[0] || T.contains(Q)) && L.call(this, R) || M.call(this, O, R) } else { O = O.createIterator(); O.enforceRealBlocks = true; for (O.enlargeBr = true; R = O.getNextParagraph(); ) { L.call(this, R) } } S.selectBookmarks(P) } }); N.IndentSupport = { init: function () { this.indentCommand = new E(this.cfg.type) }, offClick: function () { var P = this, O = P.editor; O.fire("save"); setTimeout(function () { P.indentCommand.exec(O); O.fire("save"); O.notifySelectionChange() }, 10) }, selectionChange: function (P) { if (this.cfg.type == "outdent") { var O = P.path, Q = O.blockLimit; P = this.btn; if (O.contains(K)) { P.boff() } else { (O = O.block || Q) && O._4e_style(this.indentCommand.indentCssProperty) ? P.boff() : P.disable() } } } } }, { attach: false }); KISSY.Editor.add("justify", function (A) { A.addPlugin("justify", function () { var G = KISSY, E = G.Editor, D = E.TripleButton, F = /(-moz-|-webkit-|start|auto)/gi; E = { mode: E.WYSIWYG_MODE, offClick: function () { this.call("_change") }, onClick: function () { this.call("_change") }, _change: function () { var M = this.editor, O = M.getSelection(), J = this.btn.get("state"); if (O) { var P = O.createBookmarks(), N = O.getRanges(), L, K; M.fire("save"); for (var I = N.length - 1; I >= 0; I--) { L = N[I].createIterator(); for (L.enlargeBr = true; K = L.getNextParagraph(); ) { K.removeAttr("align"); J == D.OFF ? K.css("text-align", this.cfg.v) : K.css("text-align", "") } } M.notifySelectionChange(); O.selectBookmarks(P); M.fire("save") } }, selectionChange: function (I) { var J = this.btn; I = I.path; I = I.block || I.blockLimit; if (!I || I._4e_name() === "body") { J.boff() } else { (I.css("text-align").replace(F, "") || "left") == this.cfg.v ? J.bon() : J.boff() } } }; var C = A.addButton("alignleft", G.mix({ contentCls: "ke-toolbar-alignleft", title: "\u5de6\u5bf9\u9f50", v: "left" }, E)), H = A.addButton("aligncenter", G.mix({ contentCls: "ke-toolbar-aligncenter", title: "\u5c45\u4e2d\u5bf9\u9f50", v: "center" }, E)), B = A.addButton("alignright", G.mix({ contentCls: "ke-toolbar-alignright", title: "\u53f3\u5bf9\u9f50", v: "right" }, E)); this.destroy = function () { C.destroy(); H.destroy(); B.destroy() } }) }, { attach: false }); KISSY.Editor.add("link", function (A) { A.addPlugin("link", function () { function B(L) { return L._4e_ascendant(function (M) { return M._4e_name() === "a" }, true) } var J = KISSY, I = J.Editor, K = J.Node, H = I.Style, C = { element: "a", attributes: { href: "#(href)", title: "#(title)", _ke_saved_href: "#(_ke_saved_href)", target: "#(target)"} }, D = {}, E = I.Utils.addRes, F = I.Utils.destroyRes, G = A.addButton("link", { contentCls: "ke-toolbar-link", title: "\u63d2\u5165\u94fe\u63a5", mode: I.WYSIWYG_MODE, _getSelectedLink: function () { var L = this.editor.getSelection(); if (L = L && L.getStartElement()) { L = B(L) } return L }, _getSelectionLinkUrl: function () { var L = this.cfg._getSelectedLink.call(this); if (L) { return L.attr("_ke_saved_href") || L.attr("href") } }, _removeLink: function (Q) { var P = this.editor; P.fire("save"); var N = P.getSelection(), M = N.getRanges()[0]; if (M && M.collapsed) { M = N.createBookmarks(); Q._4e_remove(true); N.selectBookmarks(M) } else { if (M) { Q = Q[0]; N = Q.attributes; M = {}; for (var L = 0; L < N.length; L++) { var O = N[L]; if (O.specified) { M[O.name] = O.value } } if (Q.style.cssText) { M.style = Q.style.cssText } (new H(C, M)).remove(P.document) } } P.fire("save"); P.notifySelectionChange() }, _link: function (O, N) { var M = this.editor; O._ke_saved_href = O.href; if (N) { M.fire("save"); N.attr(O); M.fire("save") } else { var L = M.getSelection(); L = L && L.getRanges()[0]; if (!L || L.collapsed) { L = new K("<a>" + O.href + "</a>", O, M.document); M.insertElement(L) } else { M.fire("save"); (new H(C, O)).apply(M.document); M.fire("save") } } M.notifySelectionChange() }, offClick: function () { var L = this; L.editor.useDialog("link/dialog", function (M) { M.show(L) }) }, destroy: function () { this.editor.destroyDialog("link/dialog") } }); E.call(D, G); I.use("bubbleview", function () { I.BubbleView.register({ pluginName: "link", editor: A, pluginContext: G, func: B, init: function () { var P = this, O = P.get("contentEl"); O.html('\u524d\u5f80\u94fe\u63a5\uff1a  <a href=""  target="_blank" class="ke-bubbleview-url"></a> -  <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -  <span class="ke-bubbleview-link ke-bubbleview-remove">\u53bb\u9664</span>'); var N = O.one(".ke-bubbleview-url"), M = O.one(".ke-bubbleview-change"), L = O.one(".ke-bubbleview-remove"); I.Utils.preventFocus(O); M.on("click", function (Q) { P._plugin.call("offClick"); Q.halt() }); L.on("click", function (Q) { P._plugin.call("_removeLink", P._selectedEl); Q.halt() }); E.call(P, M, L); P.on("show", function () { var Q = P._selectedEl; if (Q) { Q = Q.attr("_ke_saved_href") || Q.attr("href"); N.html(Q); N.attr("href", Q) } }) } }); E.call(D, function () { I.BubbleView.destroy("link") }) }); this.destroy = function () { F.call(D) } }) }, { attach: false }); KISSY.Editor.add("list", function (A) { A.addPlugin("list", function () { var D = KISSY.Editor, C = A.addButton("ul", { title: "\u9879\u76ee\u5217\u8868", mode: D.WYSIWYG_MODE, contentCls: "ke-toolbar-ul", loading: true, type: "ul" }), B = A.addButton("ol", { title: "\u7f16\u53f7\u5217\u8868", mode: D.WYSIWYG_MODE, contentCls: "ke-toolbar-ol", loading: true, type: "ol" }); D.use("list/support", function () { C.reload(D.ListSupport); B.reload(D.ListSupport) }); this.destroy = function () { C.destroy(); B.destroy() } }) }, { attach: false }); KISSY.Editor.add("list/support", function () { function E(O) { this.type = O } var B = KISSY.Editor, M = { ol: 1, ul: 1 }, L = ["ol", "ul"], N = KISSY, K = B.RANGE, C = B.ElementPath, D = B.Walker, F = B.NODE, H = N.UA, J = N.Node, I = N.DOM, G = { listToArray: function (T, W, U, Y, S) { if (!M[T._4e_name()]) { return [] } Y || (Y = 0); U || (U = []); for (var R = 0, P = T[0].childNodes.length; R < P; R++) { var Q = new J(T[0].childNodes[R]); if (Q._4e_name() == "li") { var X = { parent: T, indent: Y, element: Q, contents: [] }; if (S) { X.grandparent = S } else { X.grandparent = T.parent(); if (X.grandparent && X.grandparent._4e_name() == "li") { X.grandparent = X.grandparent.parent() } } W && Q._4e_setMarker(W, "listarray_index", U.length); U.push(X); for (var V = 0, Z = Q[0].childNodes.length, O; V < Z; V++) { O = new J(Q[0].childNodes[V]); O[0].nodeType == F.NODE_ELEMENT && M[O._4e_name()] ? G.listToArray(O, W, U, Y + 1, X.grandparent) : X.contents.push(O) } } } return U }, arrayToList: function (T, W, U, Y) { U || (U = 0); if (!T || T.length < U + 1) { return null } for (var S = T[U].parent[0].ownerDocument, R = S.createDocumentFragment(), P = null, Q = U, X = Math.max(T[U].indent, 0), V = null; ; ) { var Z = T[Q]; if (Z.indent == X) { if (!P || T[Q].parent._4e_name() != P._4e_name()) { P = T[Q].parent._4e_clone(false, true); R.appendChild(P[0]) } V = P[0].appendChild(Z.element._4e_clone(false, true)[0]); for (var O = 0; O < Z.contents.length; O++) { V.appendChild(Z.contents[O]._4e_clone(true, true)[0]) } Q++ } else { if (Z.indent == Math.max(X, 0) + 1) { Q = G.arrayToList(T, null, Q, Y); V.appendChild(Q.listNode); Q = Q.nextIndex } else { if (Z.indent == -1 && !U && Z.grandparent) { if (M[Z.grandparent._4e_name()]) { V = Z.element._4e_clone(false, true)[0] } else { if (Z.grandparent._4e_name() != "td") { V = S.createElement(Y); Z.element._4e_copyAttributes(new J(V)) } else { V = S.createDocumentFragment() } } for (O = 0; O < Z.contents.length; O++) { P = Z.contents[O]._4e_clone(true, true); V.nodeType == F.NODE_DOCUMENT_FRAGMENT && Z.element._4e_copyAttributes(new J(P)); V.appendChild(P[0]) } if (V.nodeType == F.NODE_DOCUMENT_FRAGMENT && Q != T.length - 1) { V.lastChild && V.lastChild.nodeType == F.NODE_ELEMENT && V.lastChild.getAttribute("type") == "_moz" && I._4e_remove(V.lastChild); I._4e_appendBogus(V) } if (V.nodeType == F.NODE_ELEMENT && I._4e_name(V) == Y && V.firstChild) { I._4e_trim(V); P = V.firstChild; if (P.nodeType == F.NODE_ELEMENT && I._4e_isBlockBoundary(P)) { P = S.createDocumentFragment(); I._4e_moveChildren(V, P); V = P } } P = I._4e_name(V); if (!H.ie && (P == "div" || P == "p")) { I._4e_appendBogus(V) } R.appendChild(V); P = null; Q++ } else { return null } } } if (T.length <= Q || Math.max(T[Q].indent, 0) < X) { break } } if (W) { for (T = new J(R.firstChild); T && T[0]; ) { T[0].nodeType == F.NODE_ELEMENT && T._4e_clearMarkers(W, true); T = T._4e_nextSourceNode() } } return { listNode: R, nextIndex: Q} } }, A = /^h[1-6]$/; E.prototype = { changeListType: function (S, U, T, W) { var R = G.listToArray(U.root, T, undefined, undefined, undefined), Q = []; for (S = 0; S < U.contents.length; S++) { var O = U.contents[S]; O = O._4e_ascendant("li", true); if (!(!O || !O[0] || O.data("list_item_processed"))) { Q.push(O); O._4e_setMarker(T, "list_item_processed", true) } } O = new J(U.root[0].ownerDocument.createElement(this.type)); for (S = 0; S < Q.length; S++) { var P = Q[S].data("listarray_index"); R[P].parent = O } T = G.arrayToList(R, T, null, "p"); var V; R = T.listNode.childNodes.length; for (S = 0; S < R && (V = new J(T.listNode.childNodes[S])); S++) { V._4e_name() == this.type && W.push(V) } I.insertBefore(I._4e_unwrap(T.listNode), I._4e_unwrap(U.root)); U.root._4e_remove() }, createList: function (S, O, U) { var P = O.contents; S = O.root[0].ownerDocument; var R = []; if (P.length == 1 && P[0][0] === O.root[0]) { var Q = new J(S.createElement("div")); P[0][0].nodeType != F.NODE_TEXT && P[0]._4e_moveChildren(Q); P[0][0].appendChild(Q[0]); P[0] = Q } O = O.contents[0].parent(); for (Q = 0; Q < P.length; Q++) { O = O._4e_commonAncestor(P[Q].parent()) } for (Q = 0; Q < P.length; Q++) { for (var T = P[Q], V; V = T.parent(); ) { if (V[0] === O[0]) { R.push(T); break } T = V } } if (!(R.length < 1)) { P = new J(R[R.length - 1][0].nextSibling); Q = new J(S.createElement(this.type)); for (U.push(Q); R.length; ) { U = R.shift(); T = new J(S.createElement("li")); if (A.test(U._4e_name())) { T[0].appendChild(U[0]) } else { U._4e_copyAttributes(T); U._4e_moveChildren(T); U._4e_remove() } Q[0].appendChild(T[0]); H.ie || T._4e_appendBogus() } P[0] ? Q.insertBefore(P) : O.append(Q) } }, removeList: function (S, V, T) { function X(Z) { if ((U = new J(W[Z ? "firstChild" : "lastChild"])) && !(U[0].nodeType == F.NODE_ELEMENT && U._4e_isBlockBoundary()) && (Y = V.root[Z ? "_4e_previous" : "_4e_next"](D.whitespaces(true))) && !(U[0].nodeType == F.NODE_ELEMENT && Y._4e_isBlockBoundary({ br: 1 }))) { I[Z ? "insertBefore" : "insertAfter"](S.document.createElement("br"), I._4e_unwrap(U)) } } for (var R = G.listToArray(V.root, T, undefined, undefined, undefined), Q = [], O = 0; O < V.contents.length; O++) { var P = V.contents[O]; P = P._4e_ascendant("li", true); if (!(!P || P.data("list_item_processed"))) { Q.push(P); P._4e_setMarker(T, "list_item_processed", true) } } P = null; for (O = 0; O < Q.length; O++) { P = Q[O].data("listarray_index"); R[P].indent = -1; P = P } for (O = P + 1; O < R.length; O++) { if (R[O].indent > Math.max(R[O - 1].indent, 0)) { Q = R[O - 1].indent + 1 - R[O].indent; for (P = R[O].indent; R[O] && R[O].indent >= P; ) { R[O].indent += Q; O++ } O-- } } var W = G.arrayToList(R, T, null, "p").listNode, U, Y; X(true); X(undefined); I.insertBefore(I._4e_unwrap(W), I._4e_unwrap(V.root)); V.root._4e_remove() }, exec: function (W) { var a = W.getSelection(), X = a && a.getRanges(); if (!(!X || X.length < 1)) { for (var d = a.createBookmarks(true), V = [], U = {}; X.length > 0; ) { var Q = X.shift(), S = Q.getBoundaryNodes(), c = S.startNode, Z = S.endNode; c[0].nodeType == F.NODE_ELEMENT && c._4e_name() == "td" && Q.setStartAt(S.startNode, K.POSITION_AFTER_START); Z[0].nodeType == F.NODE_ELEMENT && Z._4e_name() == "td" && Q.setEndAt(S.endNode, K.POSITION_BEFORE_END); Q = Q.createIterator(); for (Q.forceBrBreak = false; S = Q.getNextParagraph(); ) { if (!S.data("list_block")) { S._4e_setMarker(U, "list_block", 1); Z = new C(S); var e = Z.elements, O = null, T = false, R = Z.blockLimit, Y; for (c = e.length - 1; c >= 0 && (Y = e[c]); c--) { if (M[Y._4e_name()] && R.contains(Y)) { R.removeData("list_group_object"); if (c = Y.data("list_group_object")) { c.contents.push(S) } else { c = { root: Y, contents: [S] }; V.push(c); Y._4e_setMarker(U, "list_group_object", c) } T = true; break } } if (!T) { Z = R || Z.block; if (Z.data("list_group_object")) { Z.data("list_group_object").contents.push(S) } else { c = { root: Z, contents: [S] }; Z._4e_setMarker(U, "list_group_object", c); V.push(c) } } } } } for (X = []; V.length > 0; ) { c = V.shift(); if (this.state == "off") { if (M[c.root._4e_name()]) { this.changeListType(W, c, U, X) } else { B.Utils.clearAllMarkers(U); this.createList(W, c, X) } } else { this.state == "on" && M[c.root._4e_name()] && this.removeList(W, c, U) } } for (c = 0; c < X.length; c++) { O = X[c]; var P = this; W = function (f) { var b = O[f ? "_4e_previous" : "_4e_next"](D.whitespaces(true)); if (b && b[0] && b._4e_name() == P.type) { b._4e_remove(); b._4e_moveChildren(O, f ? true : false) } }; W(undefined); W(true) } B.Utils.clearAllMarkers(U); a.selectBookmarks(d) } } }; B.ListUtils = G; B.ListSupport = { init: function () { this.listCommand = new E(this.cfg.type) }, selectionChange: function (S) { var O = this.cfg.type, U = S.path, P; S = this.btn; var R = U.blockLimit; U = U.elements; if (R) { if (U) { for (var Q = 0; Q < U.length && (P = U[Q]) && P[0] !== R[0]; Q++) { var T = N.indexOf(U[Q]._4e_name(), L); if (T !== -1) { if (L[T] === O) { S.bon(); return } else { break } } } } S.boff() } }, offClick: function () { this.call("_change") }, onClick: function () { this.call("_change") }, _change: function () { var P = this.editor, O = this.btn; P.fire("save"); this.listCommand.state = O.get("state"); this.listCommand.exec(P); P.fire("save"); P.notifySelectionChange() } } }, { attach: false }); KISSY.Editor.add("localstorage", function () { var A = KISSY, E = A.Editor; E.localStorage = null; if (E.storeReady) { A.log("localstorage attach more", "warn") } else { E.storeReady = function (F) { E.on("storeReady", F) }; E.on("storeReady", function () { E.storeReady = function (F) { F() }; E.detach("storeReady") }); if (!A.UA.ie && window.localStorage) { E.localStorage = window.localStorage; E.fire("storeReady") } else { var C = E.Utils.debugUrl("localstorage/swfstore.swf?t=" + +new Date), B = new E.FlashBridge({ movie: C, flashVars: { useCompression: true }, methods: ["setItem", "removeItem", "getItem", "setMinDiskSpace", "getValueOf"] }); A.use("overlay", function () { B.swf.height = 138; var F = new A.Overlay({ headerContent: "\u8bf7\u70b9\u5141\u8bb8", width: "0px", elStyle: { overflow: "hidden" }, content: "<h1 style='border:1px solid black;border-bottom:none;background:white;text-align:center;'>\u8bf7\u70b9\u51fb\u5141\u8bb8</h1>", zIndex: E.baseZIndex(E.zIndexManager.STORE_FLASH_SHOW) }); F.render(); F.get("contentEl").append(B.swf); F.center(); F.show(); B.on("pending", function () { F.set("width", 215); F.center(); F.show(); setTimeout(function () { B.retrySave() }, 1000) }); B.on("save", function () { F.set("width", 0) }) }); var D = B.setItem; A.mix(B, { _ke: 1, getItem: function (F) { return this.getValueOf(F) }, retrySave: function () { this.setItem(this.lastSave.k, this.lastSave.v) }, setItem: function (F, G) { this.lastSave = { k: F, v: G }; D.call(this, F, G) } }); B.on("contentReady", function () { E.localStorage = B; E.fire("storeReady") }) } } }, { attach: false, requires: ["flashutils", "flashbridge"] }); KISSY.Editor.add("maximize", function (A) { A.addPlugin("maximize", function () { var D = KISSY, C = D.Editor; if (!(D.UA.gecko < 1.92)) { var B = A.addButton("maximize", { title: "\u5168\u5c4f", contentCls: "ke-toolbar-maximize", loading: true }); C.use("maximize/support", function () { B.reload(C.Maximize) }); this.destroy = function () { B.destroy() } } }) }, { attach: false }); KISSY.Editor.add("maximize/support", function () { var C = KISSY.Editor, G = KISSY, E = G.UA, D = G.Node, F = G.Event, B = G.DOM, H; B.addStyleSheet(".ke-toolbar-padding {padding:5px;}", "ke-maximize"); var A = {}; G.mix(A, { onClick: function () { var I = this, J = I.editor; I._resize && F.remove(window, "resize", I._resize); I.call("_saveEditorStatus"); I.call("_restoreState"); I.btn.boff(); setTimeout(function () { I.call("_restoreEditorStatus"); J.notifySelectionChange(); J.fire("restoreWindow") }, 30) }, _restoreState: function () { var J = document, L = this.editor, I = this._savedParents; if (I) { for (var M = 0; M < I.length; M++) { var K = I[M]; K.el.css("position", K.position) } this._savedParents = null } L.wrap.css({ height: this.iframeHeight }); B.css(J.body, { width: "", height: "", overflow: "" }); J.documentElement.style.overflow = ""; L.editorWrap.css({ position: "static", width: this.editorWrapWidth }); H.css({ left: "-99999px", top: "-99999px" }); window.scrollTo(this.scrollLeft, this.scrollTop); J = this.btn.get("el"); J.one("span").removeClass("ke-toolbar-restore").addClass("ke-toolbar-maximize"); J.attr("title", "\u5168\u5c4f"); E.ie < 8 && this.editor.toolBarDiv.removeClass("ke-toolbar-padding") }, _saveSate: function () { var J = this.editor, K = [], I = J.editorWrap; this.iframeHeight = J.wrap._4e_style("height"); this.editorWrapWidth = I._4e_style("width"); this.scrollLeft = B.scrollLeft(); this.scrollTop = B.scrollTop(); window.scrollTo(0, 0); for (J = I.parent(); J; ) { I = J.css("position"); if (I != "static") { K.push({ el: J, position: I }); J.css("position", "static") } J = J.parent() } this._savedParents = K; K = this.btn.get("el"); K.one("span").removeClass("ke-toolbar-maximize").addClass("ke-toolbar-restore"); K.attr("title", "\u53d6\u6d88\u5168\u5c4f"); E.ie < 8 && this.editor.toolBarDiv.addClass("ke-toolbar-padding") }, _saveEditorStatus: function () { var I = this.editor; this.savedRanges = null; if (E.gecko && I.iframeFocus) { this.savedRanges = (I = I.getSelection()) && I.getRanges() } }, _restoreEditorStatus: function () { var J = this.editor, K = J.getSelection(), I = this.savedRanges; J.activateGecko(); I && K && K.selectRanges(I); if (J.iframeFocus && K) { (J = K.getStartElement()) && J[0] && J._4e_scrollIntoView() } E.ie < 8 && this.btn.get("el").one("span").css("background-image", "") }, _maximize: function (M) { var O = document, J = this.editor, P = J.editorWrap, N = B.viewportHeight(), L = B.viewportWidth(), K = J.statusDiv ? J.statusDiv[0].offsetHeight : 0, I = J.toolBarDiv[0].offsetHeight; if (E.ie) { O.body.style.overflow = "hidden" } else { B.css(O.body, { width: 0, height: 0, overflow: "hidden" }) } O.documentElement.style.overflow = "hidden"; P.css({ position: "absolute", zIndex: C.baseZIndex(C.zIndexManager.MAXIMIZE), width: L + "px" }); H.css({ zIndex: C.baseZIndex(C.zIndexManager.MAXIMIZE - 5), height: N + "px", width: L + "px" }); P.offset({ left: 0, top: 0 }); H.css({ left: 0, top: 0 }); J.wrap.css({ height: N - K - I + "px" }); M !== true && arguments.callee.call(this, true) }, _real: function () { var I = this, J = I.editor; I.call("_saveEditorStatus"); I.call("_saveSate"); I.call("_maximize"); I._resize = I._resize || C.Utils.buffer(I.cfg._maximize, I, 100); F.on(window, "resize", I._resize); I.btn.bon(); setTimeout(function () { I.call("_restoreEditorStatus"); J.notifySelectionChange(); J.fire("maximizeWindow") }, 30) }, offClick: function () { H || (H = (new D("<iframe  class='ke-maximize-shim' style='position:absolute;top:-9999px;left:-9999px;' frameborder='0'>")).prependTo(document.body)); this.call("_real") }, destroy: function () { } }); C.Maximize = A }, { attach: false }); KISSY.Editor.add("music", function (A) { A.addPlugin("music", function () { function F(H) { H = H || ""; return H.indexOf(C) != -1 } var D = KISSY.Editor, C = "niftyplayer.swf", E = A.htmlDataProcessor, B = E && E.dataFilter; B && B.addRules({ elements: { object: function (H) { var I = H.attributes; if (!(I.classid && String(I.classid).toLowerCase())) { for (I = 0; I < H.children.length; I++) { if (H.children[I].name == "embed") { if (!D.Utils.isFlashEmbed(H.children[I])) { break } if (F(H.children[I].attributes.src)) { return E.createFakeParserElement(H, "ke_music", "music", true) } } } return null } for (I = 0; I < H.children.length; I++) { var J = H.children[I]; if (J.name == "param" && J.attributes.name.toLowerCase() == "movie") { if (F(J.attributes.value)) { return E.createFakeParserElement(H, "ke_music", "music", true) } } } }, embed: function (H) { if (!D.Utils.isFlashEmbed(H)) { return null } if (F(H.attributes.src)) { return E.createFakeParserElement(H, "ke_music", "music", true) } } } }, 4); var G = A.addButton("music", { contentCls: "ke-toolbar-music", title: "\u63d2\u5165\u97f3\u4e50", mode: D.WYSIWYG_MODE, loading: true }); D.use("music/support", function () { var H = new D.MusicInserter(A); G.reload({ offClick: function () { H.show() }, destroy: function () { H.destroy() } }) }); this.destroy = function () { G.destroy() } }) }, { attach: false, requires: ["fakeobjects"] }); KISSY.Editor.add("music/support", function () { function D(K) { D.superclass.constructor.apply(this, arguments); K.cfg.disableObjectResizing || J.on(K.document.body, B.ie ? "resizestart" : "resize", function (L) { (new I.Node(L.target)).hasClass(C) && L.preventDefault() }) } function A(K) { return K._4e_name() === "img" && !!K.hasClass(C) && K } var I = KISSY, H = I.Editor, J = I.Event, G = H.Flash, B = I.UA, C = "ke_music", E = ["img." + C]; I.extend(D, G, { _config: function () { this._cls = C; this._type = "music"; this._contextMenu = F; this._flashRules = E }, _getFlashUrl: function () { return D.superclass._getFlashUrl.apply(this, arguments).replace(/^.+niftyplayer\.swf\?file=/, "") } }); G.registerBubble("music", "\u97f3\u4e50\u7f51\u5740\uff1a ", A); H.MusicInserter = D; var F = { "\u97f3\u4e50\u5c5e\u6027": function (K) { var L = K.editor.getSelection(); (L = (L = L && L.getStartElement()) && A(L)) && K.show(null, L) } } }, { attach: false, requires: ["flash/support"] }); KISSY.Editor.add("overlay/focus", function () { function A() { } var E = KISSY, C = E.UA, B = E.Editor, D = B.focusManager; B.namespace("UIBase"); if (B.UIBase.Focus) { E.log("ke uibase focus attach more", "warn") } else { A.ATTRS = { focus4e: { value: true} }; A.prototype = { _uiSetFocus4e: function (F) { if (F) { this.on("show", this._show4FocusExt, this); this.on("hide", this._hide4FocusExt, this) } else { this.detach("show", this._show4FocusExt, this); this.detach("hide", this._hide4FocusExt, this) } }, __syncUI: function () { }, __renderUI: function () { }, __bindUI: function () { this._focus4e = (new E.Node("<a href='#' class='ke-focus' style='width:0;height:0;margin:0;padding:0;overflow:hidden;outline:none;font-size:0;'></a>")).appendTo(this.get("el")) }, _show4FocusExt: function () { var F = this._focusEditor = D.currentInstance(); if (C.ie && F) { window.focus(); document.body.focus(); this._focus4e[0].focus(); var G = F.document.selection.createRange(); if (G) { if (G.item && G.item(0).ownerDocument == F.document) { F = document.body.createTextRange(); F.moveToElementText(this.get("el")._4e_first()[0]); F.collapse(true); F.select() } } } }, _hide4FocusExt: function () { var F = this._focusEditor; F && F.focus() } }; B.UIBase.Focus = A } }, { attach: false }); KISSY.Editor.add("overlay", function () { var B = KISSY, F = B.UIBase, D = B.Editor; if (D.Overlay) { B.log("ke overlay attach more") } else { B.use("overlay"); var C = F.create(B.Overlay, [D.UIBase.Focus], { syncUI: function () { D.Utils.preventFocus(this.get("contentEl")) } }, { ATTRS: { zIndex: { value: D.baseZIndex(D.zIndexManager.OVERLAY)}} }), E = F.create(B.Dialog, [D.UIBase.Focus], { show: function () { this.center(); var G = this.get("y"); if (G - B.DOM.scrollTop() > 200) { G = B.DOM.scrollTop() + 200; this.set("y", G) } E.superclass.show.call(this) } }, { ATTRS: { constrain: { value: true }, zIndex: { value: D.baseZIndex(D.zIndexManager.OVERLAY)}} }); D.Overlay = C; D.Dialog = E; var A; D.Overlay.loading = function () { A || (A = new D.Overlay({ x: 0, focus4e: false, width: B.UA.ie == 6 ? B.DOM.docWidth() : "100%", y: 0, zIndex: D.baseZIndex(D.zIndexManager.LOADING), elCls: "ke-global-loading" })); A.set("height", B.DOM.docHeight()); A.show(); A.loading() }; D.Overlay.unloading = function () { A && A.hide() } } }, { requires: ["overlay/focus"] }); KISSY.Editor.add("pagebreak", function (A) { A.addPlugin("pagebreak", function () { var F = KISSY, D = F.Editor, C = F.Node, E = A.htmlDataProcessor; (F = E && E.dataFilter) && F.addRules({ elements: { div: function (I) { var G = I.attributes; var H = (G = G && G.style) && I.children.length == 1 && I.children[0]; if ((H = H && H.name == "span" && H.attributes.style) && /page-break-after\s*:\s*always/i.test(G) && /display\s*:\s*none/i.test(H)) { return E.createFakeParserElement(I, "ke_pagebreak", "div") } } } }); var B = A.addButton("page-break", { title: "\u5206\u9875", mode: D.WYSIWYG_MODE, contentCls: "ke-toolbar-pagebreak", offClick: function () { var K = this.editor, G = new C('<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>', null, K.document); G = K.createFakeElement ? K.createFakeElement(G, "ke_pagebreak", "div", false, '<div style="page-break-after: always; "><span style="DISPLAY:none">&nbsp;</span></div>') : G; var I = K.getSelection(); if (I = I && I.getRanges()[0]) { K.fire("save"); for (var J = I.startContainer, H = J; J._4e_name() !== "body"; ) { H = J; J = J.parent() } I.collapse(true); I.splitElement(H); G.insertAfter(H); K.fire("save") } } }); this.destroy = function () { B.destroy() } }) }, { attach: false, requires: ["fakeobjects"] }); KISSY.Editor.add("preview", function (A) { A.addPlugin("preview", function () { var B = A.addButton("preview", { title: "\u9884\u89c8", contentCls: "ke-toolbar-preview", offClick: function () { var F = this.editor, E = 640, G = 420, D = 80; try { var H = window.screen; E = Math.round(H.width * 0.8); G = Math.round(H.height * 0.7); D = Math.round(H.width * 0.1) } catch (C) { } F = F._prepareIFrameHtml().replace(/<body[^>]+>.+<\/body>/, "<body>\n" + F.getData(true) + "\n</body>").replace(/\${title}/, "\u9884\u89c8"); E = window.open("", "", "toolbar=yes,location=no,status=yes,menubar=yes,scrollbars=yes,resizable=yes,width=" + E + ",height=" + G + ",left=" + D); G = E.document; G.open(); G.write(F); G.close(); E.focus() } }); this.destroy = function () { B.destroy() } }) }, { attach: false }); KISSY.Editor.add("progressbar", function () { function A() { A.superclass.constructor.apply(this, arguments); this._init() } var D = KISSY, C = D.Editor; if (!C.ProgressBar) { var B = D.Node; D.DOM.addStyleSheet(".ke-progressbar {border:1px solid #D6DEE6;position:relative;margin-left:auto;margin-right:auto;background-color: #EAEFF4;background: -webkit-gradient(linear, left top, left bottom, from(#EAEFF4), .to(#EBF0F3)); background: -moz-linear-gradient(top, #EAEFF4, #EBF0F3);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#EAEFF4', endColorstr = '#EBF0F3');}.ke-progressbar-inner {border:1px solid #3571B4;background-color:#6FA5DB;padding:1px;}.ke-progressbar-inner-bg {height:100%;background-color: #73B1E9;background: -webkit-gradient(linear, left top, left bottom, from(#73B1E9), .to(#3F81C8)); background: -moz-linear-gradient(top, #73B1E9, #3F81C8);filter: progid:DXImageTransform.Microsoft.gradient(startColorstr = '#73B1E9', endColorstr = '#3F81C8');}.ke-progressbar-title {width:30px;top:0;left:40%;line-height:1.2;position:absolute;}", "ke_progressbar"); A.ATTRS = { container: {}, width: {}, height: {}, progress: { value: 0} }; D.extend(A, D.Base, { destroy: function () { this.detach(); this.el.remove() }, _init: function () { var G = this.get("height"), F = new B("<div class='ke-progressbar'  style='width:" + this.get("width") + ";height:" + G + ";'></div>"), H = this.get("container"); G = (new B("<div style='overflow:hidden;'><div class='ke-progressbar-inner' style='height:" + (parseInt(G) - 4) + "px'><div class='ke-progressbar-inner-bg'></div></div></div>")).appendTo(F); var E = (new B("<span class='ke-progressbar-title'>")).appendTo(F); H && F.appendTo(H); this.el = F; this._title = E; this._p = G; this.on("afterProgressChange", this._progressChange, this); this._progressChange({ newVal: this.get("progress") }) }, _progressChange: function (E) { E = E.newVal; this._p.css("width", E + "%"); this._title.html(E + "%") } }); C.ProgressBar = A } }, { attach: false }); KISSY.Editor.add("removeformat", function (A) { A.addPlugin("removeformat", function () { function H(K, J) { for (var L = 0; L < J.length; L++) { K.removeAttr(J[L]) } } var E = KISSY.Editor, D = E.RANGE, F = E.ElementPath, C = E.NODE, I = "class,style,lang,width,height,align,hspace,valign".split(/,/), B = RegExp("^(?:" + "b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var,s".replace(/,/g, "|") + ")$", "i"), G = A.addButton("removeformat", { title: "\u6e05\u9664\u683c\u5f0f", mode: E.WYSIWYG_MODE, contentCls: "ke-toolbar-removeformat", offClick: function () { var P = this.editor; P.focus(); B.lastIndex = 0; var K = P.getSelection().getRanges(); P.fire("save"); for (var Q = 0, O; O = K[Q]; Q++) { if (!O.collapsed) { O.enlarge(D.ENLARGE_ELEMENT); var M = O.createBookmark(), L = M.startNode, J = M.endNode, N = function (R) { for (var T = new F(R), S = T.elements, U = 1, V; V = S[U]; U++) { if (V._4e_equals(T.block) || V._4e_equals(T.blockLimit)) { break } B.test(V._4e_name()) && R._4e_breakParent(V) } }; N(L); N(J); for (L = L._4e_nextSourceNode(true, C.NODE_ELEMENT); L; ) { if (L._4e_equals(J)) { break } N = L._4e_nextSourceNode(false, C.NODE_ELEMENT); L._4e_name() == "img" && L.attr("_ke_realelement") || (B.test(L._4e_name()) ? L._4e_remove(true) : H(L, I)); L = N } O.moveToBookmark(M) } } P.getSelection().selectRanges(K); P.fire("save") } }); this.destroy = function () { G.destroy() } }) }, { attach: false }); KISSY.Editor.add("resize", function (A) { var C = KISSY, B = C.Node; C.use("dd", function () { var N = C.Draggable, O = A.statusDiv, M = A.textarea, E = new B("<div class='ke-resizer'>"), F = A.cfg.pluginConfig.resize || {}; F = F.direction || ["x", "y"]; E.appendTo(O); A.on("maximizeWindow", function () { E.css("display", "none") }); A.on("restoreWindow", function () { E.css("display", "") }); E._4e_unselectable(); var H = new N({ node: E, cursor: "se-resize" }), J = 0, L = 0, K = 0, I = 0, D = A.wrap, G = A.editorWrap; H.on("dragstart", function () { J = D.height(); L = G.width(); K = M.height(); I = M.width() }); H.on("drag", function (P) { var Q = P.left - this.startNodePos.left; P = P.top - this.startNodePos.top; if (C.inArray("y", F)) { D.height(J + P); M.height(K + P) } if (C.inArray("x", F)) { G.width(L + Q); M.width(I + Q) } }); A.on("destroy", function () { H.destroy(); E.remove() }) }) }, { attach: false }); KISSY.Editor.add("separator", function (A) { A.addPlugin("separator", function () { var B = (new KISSY.Node('<span class="ke-toolbar-separator">&nbsp;</span>')).appendTo(A.toolBarDiv); A.on("destroy", function () { B.remove() }) }, { duplicate: true }) }, { attach: false }); KISSY.Editor.add("smiley", function (A) { A.addPlugin("smiley", function () { var C = KISSY.Editor, B = A.addButton("smiley", { contentCls: "ke-toolbar-smiley", title: "\u63d2\u5165\u8868\u60c5", mode: C.WYSIWYG_MODE, loading: true }); C.use("smiley/support", function () { B.reload(C.SmileySupport) }); this.destroy = function () { B.destroy() } }) }, { attach: false }); KISSY.Editor.add("smiley/support", function () { function C() { if (B) { return B } B = "<div class='ke-smiley-sprite'>"; for (var I = 0; I <= 98; I++) { B += "<a href='#' data-icon='http://a.tbcdn.cn/sys/wangwang/smiley/48x48/" + I + ".gif'></a>" } B += "</div>"; return B } var G = KISSY, E = G.Event, D = G.Editor, F = G.DOM; F.addStyleSheet('.ke-smiley-sprite { background: url("http://a.tbcdn.cn/sys/wangwang/smiley/sprite.png") no-repeat scroll -1px 0 transparent; height: 235px; width: 288px; margin: 5px;zoom: 1; overflow: hidden;}.ke-smiley-sprite a {   width: 24px;height: 24px; border: 1px solid white; float: left;}.ke-smiley-sprite a:hover { border: 1px solid #808080;}', "smiley"); var B, H = D.Utils.addRes, A = D.Utils.destroyRes; D.SmileySupport = { _selectSmiley: function (J) { J.halt(); var K = this.editor; J = new G.Node(J.target); var I; if (J._4e_name() == "a" && (I = J.attr("data-icon"))) { I = new G.Node("<img alt='' src='" + I + "'/>", null, K.document); K.insertElement(I); this.smileyWin.hide() } }, _hidePanel: function (J) { var K = this.btn.get("el"); J = new G.Node(J.target); var I = this.smileyWin; K._4e_equals(J) || K.contains(J) || I.hide() }, _prepare: function () { var J = this, L = J.cfg, I = J.btn, M = J.editor, K = C(); J.smileyWin = new D.Overlay({ content: K, focus4e: false, width: "297px", autoRender: true, elCls: "ks-popup", zIndex: D.baseZIndex(D.zIndexManager.POPUP_MENU), mask: false }); K = J.smileyWin; J.smileyPanel = K.get("contentEl"); K.on("show", I.bon, I); K.on("hide", I.boff, I); J.smileyPanel.on("click", L._selectSmiley, J); E.on(document, "click", L._hidePanel, J); E.on(M.document, "click", L._hidePanel, J); J.cfg._prepare = J.cfg._real; H.call(J, J.smileyWin, J.smileyPanel, function () { E.remove(document, "click", L._hidePanel, J); E.remove(M.document, "click", L._hidePanel, J) }); J.call("_real") }, _real: function () { var I = this.btn.get("el"), J = I.offset(); J.top += I.height() + 5; if (J.left + this.smileyPanel.width() > F.viewportWidth() - 60) { J.left = F.viewportWidth() - this.smileyPanel.width() - 60 } this.smileyWin.set("xy", [J.left, J.top]); this.smileyWin.show() }, offClick: function () { var I = this; D.use("overlay", function () { I.call("_prepare") }) }, onClick: function () { this.smileyWin && this.smileyWin.hide() }, destroy: function () { A.call(this) } } }, { attach: false }); KISSY.Editor.add("sourcearea", function (A) { A.addPlugin("sourcearea", function () { function G() { var I = A.textarea; I.on("keydown", function (K) { if (K.ctrlKey && K.keyCode == 87) { K.halt(); K = I.attr("wrap") == "off" ? "soft" : "off"; if (F.ie) { I.attr("wrap", K) } else { I.detach(); var J = I._4e_clone(); A.textarea = J; J.attr("wrap", K); J.val(I.val()); I[0].parentNode.replaceChild(J[0], I[0]); G(); I = null } } }) } var E = KISSY, D = E.Editor, F = E.UA; if (!(F.gecko < 1.92)) { var C = D.SOURCE_MODE, H = D.WYSIWYG_MODE, B = A.addButton("sourcearea", { title: "\u6e90\u7801", contentCls: "ke-toolbar-source", loading: true }); D.use("sourcearea/support", function () { B.reload({ init: function () { var I = this.btn, J = this.editor; J.on("wysiwygmode", I.boff, I); J.on("sourcemode", I.bon, I) }, offClick: function () { this.editor.execCommand("sourceAreaSupport", C) }, onClick: function () { this.editor.execCommand("sourceAreaSupport", H) } }); A.addCommand("sourceAreaSupport", D.SourceAreaSupport) }); this.destroy = function () { B.destroy() }; G() } }) }, { attach: false }); KISSY.Editor.add("sourcearea/support", function () { function B() { var G = this.mapper = {}; G[E] = this._show; G[A] = this._hide } var F = KISSY, D = F.Editor, C = F.UA, E = D.SOURCE_MODE, A = D.WYSIWYG_MODE; F.augment(B, { exec: function (I, G) { var H = this.mapper; H[G] && H[G].call(this, I) }, _show: function (G) { G.textarea.val(G.getData(true)); this._showSource(G); G.fire("sourcemode") }, _showSource: function (I) { var G = I.textarea, H = I.iframe; G.css("display", ""); H.css("display", "none"); C.ieEngine < 8 && G.css("height", I.wrap.css("height")); G[0].focus() }, _hideSource: function (H) { var G = H.textarea; H.iframe.css("display", ""); G.css("display", "none") }, _hide: function (H) { var G = H.textarea; this._hideSource(H); H.fire("save"); H.setData(G.val()); H.fire("wysiwygmode"); H.fire("save"); C.gecko && H.activateGecko() } }); D.SourceAreaSupport = new B }, { attach: false }); KISSY.Editor.add("table", function (A) { A.addPlugin("table", function () { var F = KISSY, D = F.Editor, C = F.trim; F = (F.UA.ie === 6 ? ["table.%2,", "table.%2 td, table.%2 th,", "{", "border : #d3d3d3 1px dotted", "}"] : [" table.%2,", " table.%2 > tr > td,  table.%2 > tr > th,", " table.%2 > tbody > tr > td,  table.%2 > tbody > tr > th,", " table.%2 > thead > tr > td,  table.%2 > thead > tr > th,", " table.%2 > tfoot > tr > td,  table.%2 > tfoot > tr > th", "{", "border : #d3d3d3 1px dotted", "}"]).join("").replace(/%2/g, "ke_show_border"); var E = A.htmlDataProcessor, B = E && E.dataFilter; E = E && E.htmlFilter; B && B.addRules({ elements: { table: function (H) { H = H.attributes; var I = H["class"], J = parseInt(H.border, 10); if (!J || J <= 0) { H["class"] = (I || "") + " ke_show_border" } } } }); E && E.addRules({ elements: { table: function (H) { H = H.attributes; var I = H["class"]; if (I) { H["class"] = C(I.replace("ke_show_border", "").replace(/\s{2}/, " ")) } } } }); var G = A.addButton("table", { contentCls: "ke-toolbar-table", mode: D.WYSIWYG_MODE, title: "\u63d2\u5165\u8868\u683c", loading: true }); D.use("table/support", function () { var H = new D.TableUI(A); G.reload({ offClick: function () { H._tableShow() }, destroy: function () { H.destroy() } }) }); this.destroy = function () { G.destroy() }; A.addCustomStyle(F) }) }, { attach: false }); KISSY.Editor.add("table/support", function () { function K(Y) { var V = this, X = {}, W; for (W in G) { (function (Z) { X[Z] = function () { Y.fire("save"); G[Z](V); Y.fire("save") } })(W) } W = F.ContextMenu.register({ editor: Y, statusChecker: L, rules: T, width: "120px", funcs: X }); P.call(V, W); V.editor = Y } function H(Y) { function c(e) { if (!(V.length > 0)) { if (e[0].nodeType == N.NODE_ELEMENT && M.test(e._4e_name()) && !e.data("selected_cell")) { e._4e_setMarker(Z, "selected_cell", true); V.push(e) } } } for (var b = Y.createBookmarks(), d = Y.getRanges(), V = [], Z = {}, X = 0; X < d.length; X++) { var a = d[X]; if (a.collapsed) { a = a.getCommonAncestor(); (a = a._4e_ascendant("td", true) || a._4e_ascendant("th", true)) && V.push(a) } else { a = new Walker(a); var W; for (a.guard = c; W = a.next(); ) { if ((W = W.parent()) && M.test(W._4e_name()) && !W.data("selected_cell")) { W._4e_setMarker(Z, "selected_cell", true); V.push(W) } } } } F.Utils.clearAllMarkers(Z); Y.selectBookmarks(b); return V } function D(Y, V) { var X = Y.getStartElement()._4e_ascendant("tr"); if (X) { var W = X._4e_clone(true); W.insertBefore(X); X = (V ? W[0] : X[0]).cells; for (W = 0; W < X.length; W++) { X[W].innerHTML = ""; S.ie || (new Q(X[W]))._4e_appendBogus() } } } function C(c) { if (c instanceof F.Selection) { var W = H(c), b = W.length; c = []; for (var Y, Z, X = 0; X < b; X++) { var V = W[X].parent(), a = V[0].rowIndex; !X && (Y = a - 1); c[a] = V; X == b - 1 && (Z = a + 1) } X = V._4e_ascendant("table"); Y = new Q(Z < X[0].rows.length && X[0].rows[Z] || Y > 0 && X[0].rows[Y] || X[0].parentNode); for (X = c.length; X >= 0; X--) { c[X] && C(c[X]) } return Y } else { if (c instanceof Q) { X = c._4e_ascendant("table"); X[0].rows.length == 1 ? X._4e_remove() : c._4e_remove() } } return 0 } function E(b, W) { var a = b.getStartElement(); if (a = a._4e_ascendant("td", true) || a._4e_ascendant("th", true)) { for (var Y = a._4e_ascendant("table"), Z = a[0].cellIndex, X = 0; X < Y[0].rows.length; X++) { var V = Y[0].rows[X]; if (!(V.cells.length < Z + 1)) { a = new Q(V.cells[Z].cloneNode(false)); S.ie || a._4e_appendBogus(); V = new Q(V.cells[Z]); W ? a.insertBefore(V) : a.insertAfter(V) } } } } function A(b) { if (b instanceof F.Selection) { var W = H(b), a, Y = []; b = W[0] && W[0]._4e_ascendant("table"); var Z, X, V; Z = 0; for (X = W.length; Z < X; Z++) { Y.push(W[Z][0].cellIndex) } Y.sort(); Z = 1; for (X = Y.length; Z < X; Z++) { if (Y[Z] - Y[Z - 1] > 1) { V = Y[Z - 1] + 1; break } } V || (V = Y[0] > 0 ? Y[0] - 1 : Y[Y.length - 1] + 1); Y = b[0].rows; Z = 0; for (X = Y.length; Z < X; Z++) { if (a = Y[Z].cells[V]) { break } } a = a ? new Q(a) : b._4e_previous(); for (V = W.length - 1; V >= 0; V--) { W[V] && A(W[V]) } return a } else { if (b instanceof Q) { W = b._4e_ascendant("table"); if (!W) { return null } a = b[0].cellIndex; for (V = W[0].rows.length - 1; V >= 0; V--) { b = new Q(W[0].rows[V]); if (!a && b[0].cells.length == 1) { C(b) } else { b[0].cells[a] && b[0].removeChild(b[0].cells[a]) } } } } return null } function I(X, V) { var W = new F.Range(X[0].ownerDocument); if (!W.moveToElementEditablePosition(X, V ? true : undefined)) { W.selectNodeContents(X); W.collapse(V ? false : true) } W.select(true) } function J(X) { var V = (X = X.getSelection()) && X.getStartElement(), W = V && V._4e_ascendant("table", true); if (W) { X = V._4e_ascendant(function (Y) { var Z = Y._4e_name(); return W.contains(Y) && (Z == "td" || Z == "th") }, true); V = V._4e_ascendant(function (Y) { var Z = Y._4e_name(); return W.contains(Y) && Z == "tr" }, true); return { table: W, td: X, tr: V} } } function O(V) { return (V = J(V)) && V.td } function R(V) { return (V = J(V)) && V.tr } var U = KISSY, S = U.UA, Q = U.Node, F = U.Editor, N = F.NODE, T = ["tr", "th", "td", "tbody", "table"], P = F.Utils.addRes, B = F.Utils.destroyRes; U.augment(K, { _tableShow: function (X, V, W) { this.editor.useDialog("table/dialog", function (Y) { Y.show(V, W) }) }, destroy: function () { B.call(this); this.editor.destroyDialog("table/dialog") } }); var M = /^(?:td|th)$/, L = { "\u8868\u683c\u5c5e\u6027": J, "\u5220\u9664\u8868\u683c": O, "\u5220\u9664\u5217": O, "\u5220\u9664\u884c": R, "\u5728\u4e0a\u65b9\u63d2\u5165\u884c": R, "\u5728\u4e0b\u65b9\u63d2\u5165\u884c": R, "\u5728\u5de6\u4fa7\u63d2\u5165\u5217": O, "\u5728\u53f3\u4fa7\u63d2\u5165\u5217": O }, G = { "\u8868\u683c\u5c5e\u6027": function (W) { var V = J(W.editor); V && W._tableShow(null, V.table, V.td) }, "\u5220\u9664\u8868\u683c": function (X) { var V = (X = X.editor.getSelection()) && X.getStartElement(); if (V = V && V._4e_ascendant("table", true)) { X.selectElement(V); var W = X.getRanges()[0]; W.collapse(); X.selectRanges([W]); X = V.parent(); X[0].childNodes.length == 1 && X._4e_name() != "body" && X._4e_name() != "td" ? X._4e_remove() : V._4e_remove() } }, "\u5220\u9664\u884c ": function (V) { V = V.editor.getSelection(); I(C(V), undefined) }, "\u5220\u9664\u5217 ": function (V) { V = V.editor.getSelection(); (V = A(V)) && I(V, true) }, "\u5728\u4e0a\u65b9\u63d2\u5165\u884c": function (V) { V = V.editor.getSelection(); D(V, true) }, "\u5728\u4e0b\u65b9\u63d2\u5165\u884c": function (V) { V = V.editor.getSelection(); D(V, undefined) }, "\u5728\u5de6\u4fa7\u63d2\u5165\u5217": function (V) { V = V.editor.getSelection(); E(V, true) }, "\u5728\u53f3\u4fa7\u63d2\u5165\u5217": function (V) { V = V.editor.getSelection(); E(V, undefined) } }; F.TableUI = K }, { attach: false, requires: ["contextmenu"] }); KISSY.Editor.add("tabs", function () { function A(E) { this.cfg = E; this._init() } var D = KISSY, C = D.Editor, B = D.Node; if (C.Tabs) { D.log("ke tabs attach more", "warn") } else { D.augment(A, D.EventTarget, { _init: function () { var G = this, F = G.cfg, I = F.tabs, E = F.contents.children("div"), H = I.children("li"); I.on("click", function (K) { K && K.preventDefault(); K = new B(K.target); if (K = K._4e_ascendant(function (L) { return L._4e_name() === "li" && I.contains(L) }, true)) { H.removeClass("ke-tab-selected"); var J = K.attr("rel"); K.addClass("ke-tab-selected"); E.hide(); E.item(D.indexOf(K[0], H)).show(); G.fire(J) } }) }, getTab: function (G) { var F = this.cfg, J = F.tabs; F = F.contents.children("div"); J = J.children("li"); for (var E = 0; E < J.length; E++) { var H = new B(J[E]), I = new B(F[E]); if (D.isNumber(G) && G == E || D.isString(G) && G == H.attr("rel")) { return { tab: H, content: I} } } }, remove: function (E) { E = this.getTab(E); E.tab.remove(); E.content.remove() }, _getActivate: function () { for (var F = this.cfg.tabs.children("li"), E = 0; E < F.length; E++) { var G = new B(F[E]); if (G.hasClass("ke-tab-selected")) { return G.attr("rel") } } }, activate: function (F) { if (arguments.length == 0) { return this._getActivate() } var E = this.cfg, G = E.tabs; E = E.contents.children("div"); G.children("li").removeClass("ke-tab-selected"); E.hide(); G = this.getTab(F); G.tab.addClass("ke-tab-selected"); G.content.show() }, destroy: function () { var E = this.cfg.tabs; E.detach(); E.remove() } }); C.Tabs = A } }, { attach: false }); KISSY.Editor.add("templates", function (A) { A.addPlugin("templates", function () { var E = KISSY, C = E.Editor, B = E.Node; E.DOM.addStyleSheet(".ke-tpl {    border: 2px solid #EEEEEE;    width: 95%;    margin: 20px auto;}.ke-tpl-list {    border: 1px solid #EEEEEE;    margin: 5px;    padding: 7px;    display: block;    text-decoration: none;    zoom: 1;}.ke-tpl-list:hover, .ke-tpl-selected {    background-color: #FFFACD;    text-decoration: none;    border: 1px solid #FF9933;}", "ke-templates"); var D = A.addButton("templates", { contentCls: "ke-toolbar-template", title: "\u6a21\u677f", mode: C.WYSIWYG_MODE, offClick: function () { var F = this; C.use("overlay", function () { F.cfg._prepare.call(F) }) }, _prepare: function () { for (var G = this.editor, J = G.cfg.pluginConfig.templates || [], F = "<div class='ke-tpl'>", H = 0; H < J.length; H++) { F += "<a href='javascript:void(0)' class='ke-tpl-list' tabIndex='-1'>" + J[H].demo + "</a>" } F += "</div>"; var I = new C.Dialog({ width: 500, mask: true, autoRender: true, headerContent: "\u5185\u5bb9\u6a21\u677f", bodyContent: F }); I.get("el").all(".ke-tpl-list").on("click", function (K) { K.halt(); K = (new B(K.target))._4e_index(); K != -1 && G.insertHtml(J[K].html); I.hide() }); this.ui = I; this.cfg.show.call(this); this.cfg._prepare = this.cfg.show }, show: function () { this.ui.show() } }); this.destroy = function () { D.destroy() } }) }, { attach: false }); KISSY.Editor.add("undo", function (B) { var F = KISSY, D = F.Editor, C = { redo: 1, undo: -1 }, E = { mode: D.WYSIWYG_MODE, init: function () { this.editor.on("afterSave afterRestore", this.cfg._respond, this); this.btn.disable() }, offClick: function () { this.editor.fire("restore", { d: C[this.cfg.flag] }) } }, A = F.mix({ flag: "undo", _respond: function (H) { var I = this.btn; H.index > 0 ? I.boff() : I.disable() } }, E, false), G = F.mix({ flag: "redo", _respond: function (H) { var I = this.btn; H.index < H.history.length - 1 ? I.boff() : I.disable() } }, E, false); B.addPlugin("undo", function () { var H = B.addButton("undo", { title: "\u64a4\u9500", loading: true, contentCls: "ke-toolbar-undo" }), I = B.addButton("undo", { title: "\u91cd\u505a", loading: true, contentCls: "ke-toolbar-redo" }); D.use("undo/support", function () { new D.UndoManager(B); H.reload(A); I.reload(G) }); this.destroy = function () { H.destroy(); I.destroy() } }) }, { attach: false }); KISSY.Editor.add("undo/support", function () { function D(K) { var J = K._getRawData(), L; if (J) { L = K.getSelection() } this.contents = J; this.bookmarks = L && L.createBookmarks2(true) } function A(J) { this.history = []; this.index = -1; this.editor = J; this.bufferRunner = G.Utils.buffer(this.save, this, 500); this._init() } var H = KISSY, G = H.Editor, I = G.Utils.arrayCompare, F = H.UA, B = H.Event; H.augment(D, { equals: function (M) { if (this.contents != M.contents) { return false } var J = this.bookmarks; M = M.bookmarks; if (J || M) { if (!J || !M || J.length != M.length) { return false } for (var N = 0; N < J.length; N++) { var L = J[N], K = M[N]; if (L.startOffset != K.startOffset || L.endOffset != K.endOffset || !I(L.start, K.start) || !I(L.end, K.end)) { return false } } } return true } }); var C = { 16: 1, 17: 1, 18: 1 }, E = { 37: 1, 38: 1, 39: 1, 40: 1, 33: 1, 34: 1 }; H.augment(A, { _keyMonitor: function () { var J = this.editor; B.on([J.document, J.textarea], "keydown", function (K) { var L = K.keyCode; if (!(L in E || L in C)) { if (L === 90 && (K.ctrlKey || K.metaKey)) { J.fire("restore", { d: -1 }); K.halt() } else { if (L === 89 && (K.ctrlKey || K.metaKey)) { J.fire("restore", { d: 1 }); K.halt() } else { J.fire("save", { buffer: 1 }) } } } }) }, _init: function () { var K = this, J = K.editor; J.on("save", function (L) { if (J.getMode() == G.WYSIWYG_MODE) { L.buffer ? K.bufferRunner() : K.save() } }); J.on("restore", function (L) { J.getMode() == G.WYSIWYG_MODE && K.restore(L) }); K._keyMonitor(); setTimeout(function () { K.save() }, 0) }, save: function () { var L = this.history, J = this.index; L.length > J + 1 && L.splice(J + 1, L.length - J - 1); var M = this.editor; J = L[L.length - 1]; var K = new D(M); if (!J || !J.equals(K)) { L.length === 30 && L.shift(); L.push(K); this.index = J = L.length - 1; M.fire("afterSave", { history: L, index: J }) } }, restore: function (L) { L = L.d; var J = this.history, M = this.editor, K = J[this.index + L]; if (K) { M._setRawData(K.contents); if (K.bookmarks) { M.getSelection().selectBookmarks(K.bookmarks) } else { if (F.ie) { K = M.document.body.createTextRange(); K.collapse(true); K.select() } } (K = M.getSelection()) && K.scrollIntoView(); this.index += L; M.fire("afterRestore", { history: J, index: this.index }); M.notifySelectionChange() } } }); G.UndoManager = A }, { attach: false });